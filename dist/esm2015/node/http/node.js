import { GPHttpClient } from '@geoplatform/client';
class NodeHttpClient extends GPHttpClient {
    /**
     * @param options.timeout
     * @param options.token - the bearer token or a function to retrieve it
     */
    constructor(options) {
        super(options);
    }
    createRequestOpts(options) {
        let opts = {
            method: options.method,
            url: options.url,
            json: false !== options.json,
            timeout: options.timeout || this.timeout
        };
        if (options.params) {
            opts.qs = options.params;
        }
        if (options.file) {
            const fs = require('fs');
            if (!fs)
                throw new Error("Module 'fs' not available");
            opts.formData = {
                file: {
                    value: fs.createReadStream(options.file.path),
                    options: {
                        filename: options.file.originalFilename
                    }
                }
            };
            Object.assign(opts.formData, options.data || {});
        }
        else if (options.data) {
            if (options.formData) {
                opts.formData = options.data;
            }
            else {
                opts.body = options.data;
            }
        }
        //set authorization header if one was provided
        if (this.token) {
            let token = this.token();
            if (token) {
                opts.auth = { 'bearer': token };
            }
        }
        //copy over user-supplied options
        if (options.options) {
            for (let o in options.options) {
                if (options.options.hasOwnProperty(o)) {
                    opts[o] = options.options[o];
                }
            }
        }
        // console.log(JSON.stringify(opts));
        return opts;
    }
    /**
     *
     */
    execute(options) {
        const request = require('request');
        // require('request-debug')(request);
        if (!request) {
            throw new Error("Module 'request' not available");
        }
        return new Promise((resolve, reject) => {
            request(options, (error, response, body) => {
                this.checkAndHandleError(error, response)
                    .then(() => {
                    if (options.json === false)
                        resolve(response);
                    else
                        resolve(body);
                })
                    .catch(e => reject(e));
            });
        });
    }
    /**
     *
     */
    checkAndHandleError(error, response) {
        let props = {
            message: null,
            error: null,
            status: 200
        };
        if (error) {
            // Logger.debug("Error generated by request library: " + error.code);
            if (error.code === 'ETIMEDOUT' || error.code === 'ESOCKETTIMEDOUT') {
                props.status = 500;
                props.error = "Connection Timeout";
                props.message = "The response from the service took too long to read";
                if (error.connect === true) {
                    props.message = "Unable to establish a connection to the service";
                }
            }
            else {
                return Promise.reject(error);
            }
        }
        else if (response.statusCode < 200 || response.statusCode > 204) {
            // Logger.debug('Error returned by remote endpoint (' + response.statusCode + ')');
            // Logger.debug(JSON.stringify(response));
            props.status = response.statusCode;
            if (response.body && typeof (response.body) === 'object') {
                props = response.body;
                props.status = props.status || response.statusCode;
                props.message = props.message || "An error occurred communicating with service";
                if (response.statusCode === 409) {
                    let sidx = response.body.message.indexOf(" ");
                    let eidx = response.body.message.indexOf(' already exists');
                    if (sidx >= 0 && eidx > sidx) {
                        props.item = response.body.message.substring(sidx + 1, eidx);
                    }
                }
            }
            else {
                switch (response.statusCode) {
                    case 404:
                        props.error = "Not Found";
                        props.message = response.request.uri.pathname + " cannot be found";
                        break;
                    case 401:
                        props.error = "Unauthenticated";
                        props.message = "You are not authenticated";
                        break;
                    case 403:
                        props.error = "Unauthorized";
                        props.message = "You are not authorized to access " + response.request.uri.pathname;
                        break;
                    case 409:
                        props.error = "Conflict";
                        props.message = "Item already exists";
                        // pattern received is: { ..., message: 'Resource <identifier> already exists', ... }
                        try {
                            let json = JSON.parse(response.body);
                            let sidx = json.message.indexOf(" ");
                            let eidx = json.message.indexOf(' already exists');
                            if (sidx >= 0 && eidx > sidx) {
                                props.item = json.message.substring(sidx + 1, eidx);
                            }
                        }
                        catch (e) {
                            props.message += '.  Unable to extract existing identifier from service response';
                        }
                        break;
                    default:
                        try {
                            let json = JSON.parse(response.body);
                            props = json;
                            props.status = response.statusCode;
                            // Logger.debug("PARSED ERROR: " + JSON.stringify(props));
                        }
                        catch (e) {
                            props.error = "Server Error";
                            props.message = response.body;
                            // Logger.debug("DEFAULTED ERROR: " + JSON.stringify(props));
                        }
                }
            }
        }
        if (props.status < 200 || props.status > 204) {
            props.error = props.error || "Server Error";
            props.status = props.status || response.statusCode;
            props.message = props.message || "An error occurred communicating with service";
            let err = new Error(props.message);
            Object.assign(err, props);
            // Logger.debug("UTILS.checkAndHandleError : " + err);
            // Logger.debug("UTILS.checkAndHandleError : " + JSON.stringify(err));
            // Logger.debug("UTILS.checkAndHandleError : " + err.message);
            return Promise.reject(err);
        }
        return Promise.resolve(null);
    }
}
export default NodeHttpClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BnZW9wbGF0Zm9ybS9jbGllbnQvbm9kZS8iLCJzb3VyY2VzIjpbImh0dHAvbm9kZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFHbkQsTUFBTSxjQUFlLFNBQVEsWUFBWTtJQUVyQzs7O09BR0c7SUFDSCxZQUFZLE9BQWlDO1FBQ3pDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNuQixDQUFDO0lBRUQsaUJBQWlCLENBQUMsT0FBZ0M7UUFFOUMsSUFBSSxJQUFJLEdBQXlCO1lBQzdCLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTTtZQUN0QixHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUc7WUFDaEIsSUFBSSxFQUFFLEtBQUssS0FBSyxPQUFPLENBQUMsSUFBSTtZQUM1QixPQUFPLEVBQUUsT0FBTyxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTztTQUMzQyxDQUFDO1FBRUYsSUFBRyxPQUFPLENBQUMsTUFBTSxFQUFFO1lBQ2YsSUFBSSxDQUFDLEVBQUUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1NBQzVCO1FBRUQsSUFBRyxPQUFPLENBQUMsSUFBSSxFQUFFO1lBQ2IsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3pCLElBQUcsQ0FBQyxFQUFFO2dCQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQztZQUNyRCxJQUFJLENBQUMsUUFBUSxHQUFHO2dCQUNaLElBQUksRUFBRTtvQkFDRixLQUFLLEVBQUcsRUFBRSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO29CQUM5QyxPQUFPLEVBQUU7d0JBQ0wsUUFBUSxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCO3FCQUMxQztpQkFDSjthQUNKLENBQUM7WUFDRixNQUFNLENB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QUFRLENBQUMsSUFBSSxDQUFDLENBQUM7NEJBQ3JDLEtBQUssR0FBRyxJQUFJLENBQUM7NEJBQ2IsS0FBSyxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDOzRCQUNuQywwREFBMEQ7eUJBRTdEO3dCQUFDLE9BQU8sQ0FBQyxFQUFFOzRCQUNSLEtBQUssQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDOzRCQUM3QixLQUFLLENBQUMsT0FBTyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUM7NEJBQzlCLDZEQUE2RDt5QkFDaEU7aUJBQ1I7YUFFSjtTQUVKO1FBRUQsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLEdBQUcsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRztZQUUzQyxLQUFLLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLElBQUksY0FBYyxDQUFDO1lBQzVDLEtBQUssQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sSUFBSSxRQUFRLENBQUMsVUFBVSxDQUFDO1lBQ25ELEtBQUssQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sSUFBSSw4Q0FBOEMsQ0FBQztZQUVoRixJQUFJLEdBQUcsR0FBRyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDbkMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFFMUIsc0RBQXNEO1lBQ3RELHNFQUFzRTtZQUN0RSw4REFBOEQ7WUFDOUQsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzlCO1FBRUQsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pDLENBQUM7Q0FFSjtBQUdELGVBQWUsY0FBYyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBHUEh0dHBDbGllbnQgfSBmcm9tICdAZ2VvcGxhdGZvcm0vY2xpZW50JztcblxuXG5jbGFzcyBOb2RlSHR0cENsaWVudCBleHRlbmRzIEdQSHR0cENsaWVudCB7XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0gb3B0aW9ucy50aW1lb3V0XG4gICAgICogQHBhcmFtIG9wdGlvbnMudG9rZW4gLSB0aGUgYmVhcmVyIHRva2VuIG9yIGEgZnVuY3Rpb24gdG8gcmV0cmlldmUgaXRcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zID86IHsgW2tleTpzdHJpbmddIDogYW55IH0pIHtcbiAgICAgICAgc3VwZXIob3B0aW9ucyk7XG4gICAgfVxuXG4gICAgY3JlYXRlUmVxdWVzdE9wdHMob3B0aW9ucyA6IHsgW2tleTpzdHJpbmddIDogYW55IH0pIDogYW55IHtcblxuICAgICAgICBsZXQgb3B0cyA6IHtba2V5OnN0cmluZ106IGFueX0gPSB7XG4gICAgICAgICAgICBtZXRob2Q6IG9wdGlvbnMubWV0aG9kLFxuICAgICAgICAgICAgdXJsOiBvcHRpb25zLnVybCxcbiAgICAgICAgICAgIGpzb246IGZhbHNlICE9PSBvcHRpb25zLmpzb24sXG4gICAgICAgICAgICB0aW1lb3V0OiBvcHRpb25zLnRpbWVvdXQgfHwgdGhpcy50aW1lb3V0XG4gICAgICAgIH07XG5cbiAgICAgICAgaWYob3B0aW9ucy5wYXJhbXMpIHtcbiAgICAgICAgICAgIG9wdHMucXMgPSBvcHRpb25zLnBhcmFtcztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmKG9wdGlvbnMuZmlsZSkge1xuICAgICAgICAgICAgY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuICAgICAgICAgICAgaWYoIWZzKSB0aHJvdyBuZXcgRXJyb3IoXCJNb2R1bGUgJ2ZzJyBub3QgYXZhaWxhYmxlXCIpO1xuICAgICAgICAgICAgb3B0cy5mb3JtRGF0YSA9IHtcbiAgICAgICAgICAgICAgICBmaWxlOiB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiAgZnMuY3JlYXRlUmVhZFN0cmVhbShvcHRpb25zLmZpbGUucGF0aCksXG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVuYW1lOiBvcHRpb25zLmZpbGUub3JpZ2luYWxGaWxlbmFtZVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ob3B0cy5mb3JtRGF0YSwgb3B0aW9ucy5kYXRhfHx7fSk7XG5cbiAgICAgICAgfSBlbHNlIGlmKG9wdGlvbnMuZGF0YSkge1xuICAgICAgICAgICAgaWYob3B0aW9ucy5mb3JtRGF0YSkge1xuICAgICAgICAgICAgICAgIG9wdHMuZm9ybURhdGEgPSBvcHRpb25zLmRhdGE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG9wdHMuYm9keSA9IG9wdGlvbnMuZGF0YTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vc2V0IGF1dGhvcml6YXRpb24gaGVhZGVyIGlmIG9uZSB3YXMgcHJvdmlkZWRcbiAgICAgICAgaWYodGhpcy50b2tlbikge1xuICAgICAgICAgICAgbGV0IHRva2VuID0gdGhpcy50b2tlbigpO1xuICAgICAgICAgICAgaWYodG9rZW4pIHtcbiAgICAgICAgICAgICAgICBvcHRzLmF1dGggPSB7ICdiZWFyZXInOiB0b2tlbiB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy9jb3B5IG92ZXIgdXNlci1zdXBwbGllZCBvcHRpb25zXG4gICAgICAgIGlmKG9wdGlvbnMub3B0aW9ucykge1xuICAgICAgICAgICAgZm9yKGxldCBvIGluIG9wdGlvbnMub3B0aW9ucykge1xuICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMub3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShvKSkge1xuICAgICAgICAgICAgICAgICAgICBvcHRzW29dID0gb3B0aW9ucy5vcHRpb25zW29dO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG9wdHMpKTtcblxuICAgICAgICByZXR1cm4gb3B0cztcbiAgICB9XG5cblxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICBleGVjdXRlKG9wdGlvbnMgOiBhbnkpIDogUHJvbWlzZTxhbnk+IHtcblxuICAgICAgICBjb25zdCByZXF1ZXN0ID0gcmVxdWlyZSgncmVxdWVzdCcpO1xuICAgICAgICAvLyByZXF1aXJlKCdyZXF1ZXN0LWRlYnVnJykocmVxdWVzdCk7XG4gICAgICAgIGlmKCFyZXF1ZXN0KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNb2R1bGUgJ3JlcXVlc3QnIG5vdCBhdmFpbGFibGVcIik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8YW55PiggKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgcmVxdWVzdChvcHRpb25zLCAoZXJyb3IgOiBhbnksIHJlc3BvbnNlIDogYW55LCBib2R5IDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5jaGVja0FuZEhhbmRsZUVycm9yKGVycm9yLCByZXNwb25zZSlcbiAgICAgICAgICAgICAgICAudGhlbiggKCkgPT4gIHtcbiAgICAgICAgICAgICAgICAgICAgaWYob3B0aW9ucy5qc29uID09PSBmYWxzZSkgcmVzb2x2ZSggcmVzcG9uc2UgKTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSByZXNvbHZlKCBib2R5ICk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuY2F0Y2goIGUgPT4gcmVqZWN0KGUpICk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgY2hlY2tBbmRIYW5kbGVFcnJvciAoZXJyb3IgOiBhbnksIHJlc3BvbnNlIDogYW55KSA6IFByb21pc2U8YW55PiB7XG5cbiAgICAgICAgbGV0IHByb3BzIDogeyBba2V5OnN0cmluZ106IGFueSB9ID0ge1xuICAgICAgICAgICAgbWVzc2FnZTogbnVsbCxcbiAgICAgICAgICAgIGVycm9yOiBudWxsLCAgICAvL2Vycm9yIHR5cGVcbiAgICAgICAgICAgIHN0YXR1czogMjAwXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYoZXJyb3IpIHtcbiAgICAgICAgICAgIC8vIExvZ2dlci5kZWJ1ZyhcIkVycm9yIGdlbmVyYXRlZCBieSByZXF1ZXN0IGxpYnJhcnk6IFwiICsgZXJyb3IuY29kZSk7XG5cbiAgICAgICAgICAgIGlmKGVycm9yLmNvZGUgPT09ICdFVElNRURPVVQnIHx8IGVycm9yLmNvZGUgPT09ICdFU09DS0VUVElNRURPVVQnKSB7XG5cbiAgICAgICAgICAgICAgICBwcm9wcy5zdGF0dXMgPSA1MDA7XG4gICAgICAgICAgICAgICAgcHJvcHMuZXJyb3IgPSBcIkNvbm5lY3Rpb24gVGltZW91dFwiO1xuICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgPSBcIlRoZSByZXNwb25zZSBmcm9tIHRoZSBzZXJ2aWNlIHRvb2sgdG9vIGxvbmcgdG8gcmVhZFwiO1xuXG4gICAgICAgICAgICAgICAgaWYoZXJyb3IuY29ubmVjdCA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICBwcm9wcy5tZXNzYWdlID0gXCJVbmFibGUgdG8gZXN0YWJsaXNoIGEgY29ubmVjdGlvbiB0byB0aGUgc2VydmljZVwiO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0gZWxzZSBpZihyZXNwb25zZS5zdGF0dXNDb2RlIDwgMjAwIHx8IHJlc3BvbnNlLnN0YXR1c0NvZGUgPiAyMDQpIHtcblxuICAgICAgICAgICAgLy8gTG9nZ2VyLmRlYnVnKCdFcnJvciByZXR1cm5lZCBieSByZW1vdGUgZW5kcG9pbnQgKCcgKyByZXNwb25zZS5zdGF0dXNDb2RlICsgJyknKTtcbiAgICAgICAgICAgIC8vIExvZ2dlci5kZWJ1ZyhKU09OLnN0cmluZ2lmeShyZXNwb25zZSkpO1xuXG4gICAgICAgICAgICBwcm9wcy5zdGF0dXMgPSByZXNwb25zZS5zdGF0dXNDb2RlO1xuXG4gICAgICAgICAgICBpZihyZXNwb25zZS5ib2R5ICYmIHR5cGVvZihyZXNwb25zZS5ib2R5KSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICBwcm9wcyA9IHJlc3BvbnNlLmJvZHk7XG4gICAgICAgICAgICAgICAgcHJvcHMuc3RhdHVzID0gcHJvcHMuc3RhdHVzIHx8IHJlc3BvbnNlLnN0YXR1c0NvZGU7XG4gICAgICAgICAgICAgICAgcHJvcHMubWVzc2FnZSA9IHByb3BzLm1lc3NhZ2UgfHwgXCJBbiBlcnJvciBvY2N1cnJlZCBjb21tdW5pY2F0aW5nIHdpdGggc2VydmljZVwiO1xuXG4gICAgICAgICAgICAgICAgaWYocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gNDA5KSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzaWR4ID0gcmVzcG9uc2UuYm9keS5tZXNzYWdlLmluZGV4T2YoXCIgXCIpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgZWlkeCA9IHJlc3BvbnNlLmJvZHkubWVzc2FnZS5pbmRleE9mKCcgYWxyZWFkeSBleGlzdHMnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYoc2lkeCA+PSAwICYmIGVpZHggPiBzaWR4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5pdGVtID0gcmVzcG9uc2UuYm9keS5tZXNzYWdlLnN1YnN0cmluZyhzaWR4KzEsIGVpZHgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAgICAgc3dpdGNoKHJlc3BvbnNlLnN0YXR1c0NvZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSA0MDQgOlxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuZXJyb3IgPSBcIk5vdCBGb3VuZFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMubWVzc2FnZSA9IHJlc3BvbnNlLnJlcXVlc3QudXJpLnBhdGhuYW1lICsgXCIgY2Fubm90IGJlIGZvdW5kXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSA0MDEgOlxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuZXJyb3IgPSBcIlVuYXV0aGVudGljYXRlZFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMubWVzc2FnZSA9IFwiWW91IGFyZSBub3QgYXV0aGVudGljYXRlZFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgNDAzIDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLmVycm9yID0gXCJVbmF1dGhvcml6ZWRcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgPSBcIllvdSBhcmUgbm90IGF1dGhvcml6ZWQgdG8gYWNjZXNzIFwiICsgcmVzcG9uc2UucmVxdWVzdC51cmkucGF0aG5hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSA0MDkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuZXJyb3IgPSBcIkNvbmZsaWN0XCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5tZXNzYWdlID0gXCJJdGVtIGFscmVhZHkgZXhpc3RzXCI7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBhdHRlcm4gcmVjZWl2ZWQgaXM6IHsgLi4uLCBtZXNzYWdlOiAnUmVzb3VyY2UgPGlkZW50aWZpZXI+IGFscmVhZHkgZXhpc3RzJywgLi4uIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGpzb24gPSBKU09OLnBhcnNlKHJlc3BvbnNlLmJvZHkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzaWR4ID0ganNvbi5tZXNzYWdlLmluZGV4T2YoXCIgXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBlaWR4ID0ganNvbi5tZXNzYWdlLmluZGV4T2YoJyBhbHJlYWR5IGV4aXN0cycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNpZHggPj0gMCAmJiBlaWR4ID4gc2lkeCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5pdGVtID0ganNvbi5tZXNzYWdlLnN1YnN0cmluZyhzaWR4KzEsIGVpZHgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goIGUgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMubWVzc2FnZSArPSAnLiAgVW5hYmxlIHRvIGV4dHJhY3QgZXhpc3RpbmcgaWRlbnRpZmllciBmcm9tIHNlcnZpY2UgcmVzcG9uc2UnO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcblxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQganNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2UuYm9keSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMgPSBqc29uO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLnN0YXR1cyA9IHJlc3BvbnNlLnN0YXR1c0NvZGU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9nZ2VyLmRlYnVnKFwiUEFSU0VEIEVSUk9SOiBcIiArIEpTT04uc3RyaW5naWZ5KHByb3BzKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5lcnJvciA9IFwiU2VydmVyIEVycm9yXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMubWVzc2FnZSA9IHJlc3BvbnNlLmJvZHk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9nZ2VyLmRlYnVnKFwiREVGQVVMVEVEIEVSUk9SOiBcIiArIEpTT04uc3RyaW5naWZ5KHByb3BzKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGlmKCBwcm9wcy5zdGF0dXMgPCAyMDAgfHwgcHJvcHMuc3RhdHVzID4gMjA0ICkge1xuXG4gICAgICAgICAgICBwcm9wcy5lcnJvciA9IHByb3BzLmVycm9yIHx8IFwiU2VydmVyIEVycm9yXCI7XG4gICAgICAgICAgICBwcm9wcy5zdGF0dXMgPSBwcm9wcy5zdGF0dXMgfHwgcmVzcG9uc2Uuc3RhdHVzQ29kZTtcbiAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgPSBwcm9wcy5tZXNzYWdlIHx8IFwiQW4gZXJyb3Igb2NjdXJyZWQgY29tbXVuaWNhdGluZyB3aXRoIHNlcnZpY2VcIjtcblxuICAgICAgICAgICAgbGV0IGVyciA9IG5ldyBFcnJvcihwcm9wcy5tZXNzYWdlKTtcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oZXJyLCBwcm9wcyk7XG5cbiAgICAgICAgICAgIC8vIExvZ2dlci5kZWJ1ZyhcIlVUSUxTLmNoZWNrQW5kSGFuZGxlRXJyb3IgOiBcIiArIGVycik7XG4gICAgICAgICAgICAvLyBMb2dnZXIuZGVidWcoXCJVVElMUy5jaGVja0FuZEhhbmRsZUVycm9yIDogXCIgKyBKU09OLnN0cmluZ2lmeShlcnIpKTtcbiAgICAgICAgICAgIC8vIExvZ2dlci5kZWJ1ZyhcIlVUSUxTLmNoZWNrQW5kSGFuZGxlRXJyb3IgOiBcIiArIGVyci5tZXNzYWdlKTtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbiAgICB9XG5cbn1cblxuXG5leHBvcnQgZGVmYXVsdCBOb2RlSHR0cENsaWVudDtcbiJdfQ==