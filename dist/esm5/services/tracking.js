import ItemTypes from '../shared/types';
var Categories = {
    UNKNOWN: 'Unknown Category',
    DATASET: 'Dataset',
    SERVICE: 'Service',
    LAYER: 'Layer',
    MAP: 'Map',
    GALLERY: 'Gallery',
    COMMUNITY: 'Community',
    CONTACT: 'Contact',
    ORGANIZATION: 'Organization',
    CONCEPT: 'Concept',
    CONCEPT_SCHEME: 'Concept Scheme',
    APPLICATION: 'Application',
    TOPIC: 'Topic',
    WEBSITE: 'WebSite',
    IMAGE_PRODUCT: 'Image Product',
    RIGHTS_STATEMENT: 'RightsStatement',
    KNOWLEDGE_GRAPH: 'Knowledge Graph',
    USER: 'User',
    COMMUNITY_POST: 'Community Post',
    COMMUNITY_PAGE: 'Community Page',
    APP_PAGE: 'Application Page',
};
var Events = {
    ACCESSED: 'Accessed',
    DISPLAYED: 'Displayed',
    VIEWED: 'Viewed',
    CREATED: 'Created',
    EDITED: 'Edited',
    DELETED: 'Deleted',
    CLONED: 'Cloned',
    ADDED: 'Added',
    REMOVED: 'Removed',
    EXPORTED: 'Exported',
    IMPORTED: 'Imported'
};
function getCategory(type) {
    var result = Categories.UNKNOWN;
    if (type) {
        var cats = Object.keys(Categories).map(function (k) { return Categories[k]; });
        //if existing category was specified
        if (~cats.indexOf(type))
            return type;
        //if an ItemType with prefix was specified (strip off prefix)
        else if (~type.indexOf(':')) {
            var cat = type.split(':')[1];
            if (~cats.indexOf(cat))
                return cat;
        }
    }
    return result;
}
/**
 *
 */
var Event = /** @class */ (function () {
    function Event(category, type, item, related) {
        this.item = null;
        this.related = null;
        if (!category || !type) {
            throw new Error("TrackingService Event - Must specific an event " +
                "category and event type when constructing events");
        }
        this.category = category;
        this.type = type;
        this.setItem(item);
        this.setRelated(related);
    }
    Event.prototype.getCategory = function () { return this.category; };
    Event.prototype.getType = function () { return this.type; };
    Event.prototype.getItem = function () { return this.item; };
    Event.prototype.setItem = function (item) { this.item = item ? (item.id || item) : null; };
    Event.prototype.getRelated = function () { return this.related; };
    Event.prototype.setRelated = function (related) {
        this.related = related ? (related.id || related) : null;
    };
    return Event;
}());
/**
 * @param eventType - type of event being created
 * @param item - GeoPlatform Item instance
 * @return list of event objects
 */
function TrackingEventFactory(eventType, item) {
    var result = [];
    if (eventType && item && item.type) {
        if (ItemTypes.MAP === item.type) {
            result.push(new Event(Categories.MAP, eventType, item));
            if (Events.DISPLAYED === eventType) {
                item.layers.forEach(function (layerState) {
                    if (layerState.layer) {
                        var layerEvents = TrackingEventFactory(eventType, layerState.layer)
                            .filter(function (e) { return e !== null; });
                        if (layerEvents && layerEvents.length) {
                            result = result.concat(layerEvents);
                        }
                    }
                });
                if (item.baseLayer) {
                    var baseEvents = TrackingEventFactory(eventType, item.baseLayer)
                        .filter(function (e) { return e !== null; });
                    if (baseEvents && baseEvents.length)
                        result = result.concat(baseEvents);
                }
            }
        }
        else if (ItemTypes.LAYER === item.type) {
            result.push(new Event(Categories.LAYER, eventType, item));
            if (Events.DISPLAYED === eventType && item.services && item.services.length) {
                result.push(new Event(Categories.SERVICE, eventType, item.services[0]));
            }
        }
        else {
            var category = getCategory(item.type);
            result.push(new Event(category, eventType, item));
        }
    }
    // else {
    //     if(!event) console.log("Missing event");
    //     if(!item) console.log("Missing item");
    //     if(!item.type) console.log("Missing item type");
    // }
    return result;
}
/**
 *
 */
var DefaultTrackingServiceProvider = /** @class */ (function () {
    function DefaultTrackingServiceProvider() {
    }
    DefaultTrackingServiceProvider.prototype.logEvent = function (category, event, item, 
    // @ts-ignore
    related) {
        console.log("Event (" + category + ") - " + event + " : " + item);
    };
    DefaultTrackingServiceProvider.prototype.logPageView = function (view, data) {
        console.log("Page View " + view + (data ? " : " + JSON.stringify(data) : ''));
    };
    DefaultTrackingServiceProvider.prototype.logSearch = function (params, resultCount) {
        console.log("Query : " + JSON.stringify(params) + " found " + resultCount + " matches");
    };
    return DefaultTrackingServiceProvider;
}());
/**
 * TrackingService
 *
 * Service for logging events related to usage of the GeoPlatform and its data
 *
 * Example:
 *
 *   import { TrackingService, EventCategories, EventTypes } from 'geoplatform.client';
 *
 *   let tracker = new TrackingService();
 *   tracker.setProvider( ... );
 *   tracker.event( Event.of(EventCategories.MAP, EventTypes.VIEWED, map) );
 *
 * Multi-event example:
 *
 *   import {
 *      TrackingService, TrackingEventCategories, TrackingEventTypes, TrackingEventFactory
 *   } from 'geoplatform.client';
 *
 *   let tracker = new TrackingService();
 *   tracker.setProvider( ... );
 *
 *   let events = [
 *       TrackingEvent.of( TrackingCategories.MAP, TrackingEventTypes.VIEWED, this.map )
 *       TrackingEvent.of( TrackingCategories.LAYER, TrackingEventTypes.VIEWED, this.map.baseLayer )
 *   ];
 *   tracker.event(events);
 *
 *   //OR use the event factory:
 *   tracker.event( TrackingEventFactory(EventTypes.VIEWED, this.map) );
 */
var TrackingService = /** @class */ (function () {
    function TrackingService(options) {
        this.provider = null;
        if (options && typeof (options) === 'object')
            Object.assign(this, options);
        if (!this.provider)
            this.setProvider(new DefaultTrackingServiceProvider());
    }
    /**
     * @param provider -
     */
    TrackingService.prototype.setProvider = function (provider) {
        if (provider)
            this.provider = provider;
    };
    /**
     * @param event - event to log
     * @return TrackingService
     */
    TrackingService.prototype.event = function (event) {
        this.logEvent(event);
        return this;
    };
    /**
     * @param event - event to log
     */
    TrackingService.prototype.logEvent = function (event) {
        var _this = this;
        if (!this.provider || !this.provider.logEvent || !event)
            return;
        if (Array.isArray(event)) {
            var events = event;
            events.forEach(function (evt) { return _this.logEvent(evt); });
        }
        else {
            var evt = event;
            try {
                this.provider.logEvent(evt.getCategory(), evt.getType(), evt.getItem(), evt.getRelated());
            }
            catch (e) {
                console.log("TrackingService.logEvent() - Error logging event (" +
                    evt.getCategory() + ", " + evt.getType() + ", " +
                    evt.getItem() + ") - " + e.message);
            }
        }
    };
    /**
     * @param view - name of the view being activated
     * @param data - additional context to supply for the event
     * @return TrackingService
     * @deprecated use svc.event( new Event(EventCategories.APP_PAGE, EventTypes.VIEWED, pageId) )
     */
    TrackingService.prototype.pageView = function (view, data) {
        this.logPageView(view, data);
        return this;
    };
    /**
     * @param view - name of the view being activated
     * @param data - additional context to supply for the event
     * @deprecated use svc.logEvent( new Event(EventCategories.APP_PAGE, EventTypes.VIEWED, pageId) )
     */
    TrackingService.prototype.logPageView = function (view, 
    // @ts-ignore
    data) {
        if (this.provider && this.provider.logPageView) {
            this.provider.logPageView(view, data);
        }
        else {
            this.logEvent(new Event(Categories.APP_PAGE, Events.VIEWED, view));
        }
    };
    /**
     * @param params
     * @param resultCount
     */
    TrackingService.prototype.logSearch = function (params, resultCount) {
        if (this.provider.logSearch)
            this.provider.logSearch(params, resultCount);
    };
    return TrackingService;
}());
export { Event as TrackingEvent, TrackingService, Categories as TrackingCategories, Events as TrackingTypes, TrackingEventFactory };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhY2tpbmcuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ2VvcGxhdGZvcm0vY2xpZW50LyIsInNvdXJjZXMiOlsic2VydmljZXMvdHJhY2tpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxTQUFTLE1BQU0saUJBQWlCLENBQUM7QUFHeEMsSUFBTSxVQUFVLEdBQTJCO0lBQ3ZDLE9BQU8sRUFBVSxrQkFBa0I7SUFDbkMsT0FBTyxFQUFVLFNBQVM7SUFDMUIsT0FBTyxFQUFVLFNBQVM7SUFDMUIsS0FBSyxFQUFZLE9BQU87SUFDeEIsR0FBRyxFQUFjLEtBQUs7SUFDdEIsT0FBTyxFQUFVLFNBQVM7SUFDMUIsU0FBUyxFQUFRLFdBQVc7SUFDNUIsT0FBTyxFQUFVLFNBQVM7SUFDMUIsWUFBWSxFQUFLLGNBQWM7SUFDL0IsT0FBTyxFQUFVLFNBQVM7SUFDMUIsY0FBYyxFQUFHLGdCQUFnQjtJQUNqQyxXQUFXLEVBQU0sYUFBYTtJQUM5QixLQUFLLEVBQVksT0FBTztJQUN4QixPQUFPLEVBQVUsU0FBUztJQUMxQixhQUFhLEVBQUksZUFBZTtJQUNoQyxnQkFBZ0IsRUFBQyxpQkFBaUI7SUFDbEMsZUFBZSxFQUFFLGlCQUFpQjtJQUNsQyxJQUFJLEVBQWEsTUFBTTtJQUN2QixjQUFjLEVBQUcsZ0JBQWdCO0lBQ2pDLGNBQWMsRUFBRyxnQkFBZ0I7SUFDakMsUUFBUSxFQUFTLGtCQUFrQjtDQUN0QyxDQUFDO0FBRUYsSUFBTSxNQUFNLEdBQTJCO0lBQ25DLFFBQVEsRUFBSSxVQUFVO0lBQ3RCLFNBQVMsRUFBRyxXQUFXO0lBQ3ZCLE1BQU0sRUFBTSxRQUFRO0lBQ3BCLE9BQU8sRUFBSyxTQUFTO0lBQ3JCLE1BQU0sRUFBTSxRQUFRO0lBQ3BCLE9BQU8sRUFBSyxTQUFTO0lBQ3JCLE1BQU0sRUFBTSxRQUFRO0lBQ3BCLEtBQUssRUFBTyxPQUFPO0lBQ25CLE9BQU8sRUFBSyxTQUFTO0lBQ3JCLFFBQVEsRUFBSSxVQUFVO0lBQ3RCLFFBQVEsRUFB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VyxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVMLHNCQUFDO0FBQUQsQ0FBQyxBQWhHRCxJQWdHQztBQUdELE9BQU8sRUFDSCxLQUFLLElBQUksYUFBYSxFQUN0QixlQUFlLEVBQ2YsVUFBVSxJQUFJLGtCQUFrQixFQUNoQyxNQUFNLElBQUksYUFBYSxFQUN2QixvQkFBb0IsRUFDdkIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxuXG5pbXBvcnQgSXRlbVR5cGVzIGZyb20gJy4uL3NoYXJlZC90eXBlcyc7XG5cblxuY29uc3QgQ2F0ZWdvcmllcyA6IHtba2V5OnN0cmluZ106c3RyaW5nfSA9IHtcbiAgICBVTktOT1dOOiAgICAgICAgICdVbmtub3duIENhdGVnb3J5JyxcbiAgICBEQVRBU0VUOiAgICAgICAgICdEYXRhc2V0JyxcbiAgICBTRVJWSUNFOiAgICAgICAgICdTZXJ2aWNlJyxcbiAgICBMQVlFUjogICAgICAgICAgICdMYXllcicsXG4gICAgTUFQOiAgICAgICAgICAgICAnTWFwJyxcbiAgICBHQUxMRVJZOiAgICAgICAgICdHYWxsZXJ5JyxcbiAgICBDT01NVU5JVFk6ICAgICAgICdDb21tdW5pdHknLFxuICAgIENPTlRBQ1Q6ICAgICAgICAgJ0NvbnRhY3QnLFxuICAgIE9SR0FOSVpBVElPTjogICAgJ09yZ2FuaXphdGlvbicsXG4gICAgQ09OQ0VQVDogICAgICAgICAnQ29uY2VwdCcsXG4gICAgQ09OQ0VQVF9TQ0hFTUU6ICAnQ29uY2VwdCBTY2hlbWUnLFxuICAgIEFQUExJQ0FUSU9OOiAgICAgJ0FwcGxpY2F0aW9uJyxcbiAgICBUT1BJQzogICAgICAgICAgICdUb3BpYycsXG4gICAgV0VCU0lURTogICAgICAgICAnV2ViU2l0ZScsXG4gICAgSU1BR0VfUFJPRFVDVDogICAnSW1hZ2UgUHJvZHVjdCcsXG4gICAgUklHSFRTX1NUQVRFTUVOVDonUmlnaHRzU3RhdGVtZW50JyxcbiAgICBLTk9XTEVER0VfR1JBUEg6ICdLbm93bGVkZ2UgR3JhcGgnLFxuICAgIFVTRVI6ICAgICAgICAgICAgJ1VzZXInLFxuICAgIENPTU1VTklUWV9QT1NUOiAgJ0NvbW11bml0eSBQb3N0JywgICAvL3Bvc3Qgd2l0aGluIGEgY29tbXVuaXR5IHBvcnRhbFxuICAgIENPTU1VTklUWV9QQUdFOiAgJ0NvbW11bml0eSBQYWdlJywgICAvL3BhZ2Ugd2l0aGluIGEgY29tbXVuaXR5IHBvcnRhbFxuICAgIEFQUF9QQUdFOiAgICAgICAgJ0FwcGxpY2F0aW9uIFBhZ2UnLCAvL3BhZ2UvdmlldyB3aXRoaW4gYSBjbGllbnQgYXBwbGljYXRpb25cbn07XG5cbmNvbnN0IEV2ZW50cyA6IHtba2V5OnN0cmluZ106c3RyaW5nfSA9IHtcbiAgICBBQ0NFU1NFRDogICAnQWNjZXNzZWQnLCAgLy9yZWxhdGVkIGl0ZW0gd2FzIGFjY2Vzc2VkIHVzaW5nIEFQSVxuICAgIERJU1BMQVlFRDogICdEaXNwbGF5ZWQnLCAvL3JlbGF0ZWQgaXRlbSB3YXMgZGlzcGxheWVkIGluIGEgbmF0aXZlIGZvcm0gKG1hcClcbiAgICBWSUVXRUQ6ICAgICAnVmlld2VkJywgICAgLy9yZWxhdGVkIGl0ZW0gd2FzIHZpZXdlZCBpbiBnZW5lcmFsIGZvcm0gKG1ldGFkYXRhKVxuICAgIENSRUFURUQ6ICAgICdDcmVhdGVkJyxcbiAgICBFRElURUQ6ICAgICAnRWRpdGVkJyxcbiAgICBERUxFVEVEOiAgICAnRGVsZXRlZCcsXG4gICAgQ0xPTkVEOiAgICAgJ0Nsb25lZCcsXG4gICAgQURERUQ6ICAgICAgJ0FkZGVkJywgICAgLy9pdGVtIHdhcyBhZGRlZCB0byBhbm90aGVyIChpZSwgbGF5ZXIgb24gbWFwKVxuICAgIFJFTU9WRUQ6ICAgICdSZW1vdmVkJywgIC8vaXRlbSB3YXMgcmVtb3ZlZCBmcm9tIGFub3RoZXIgKGllLCBpdGVtIGZyb20gZ2FsbGVyeSlcbiAgICBFWFBPUlRFRDogICAnRXhwb3J0ZWQnLFxuICAgIElNUE9SVEVEOiAgICdJbXBvcnRlZCdcbn07XG5cblxuZnVuY3Rpb24gZ2V0Q2F0ZWdvcnkodHlwZSA6IHN0cmluZykgOiBzdHJpbmcge1xuICAgIGxldCByZXN1bHQgPSBDYXRlZ29yaWVzLlVOS05PV047XG4gICAgaWYodHlwZSkge1xuICAgICAgICBsZXQgY2F0cyA6IHN0cmluZ1tdID0gT2JqZWN0LmtleXMoQ2F0ZWdvcmllcykubWFwKChrOnN0cmluZyk9PkNhdGVnb3JpZXNba10pO1xuICAgICAgICAvL2lmIGV4aXN0aW5nIGNhdGVnb3J5IHdhcyBzcGVjaWZpZWRcbiAgICAgICAgaWYofmNhdHMuaW5kZXhPZih0eXBlKSlcbiAgICAgICAgICAgIHJldHVybiB0eXBlO1xuICAgICAgICAvL2lmIGFuIEl0ZW1UeXBlIHdpdGggcHJlZml4IHdhcyBzcGVjaWZpZWQgKHN0cmlwIG9mZiBwcmVmaXgpXG4gICAgICAgIGVsc2UgaWYofnR5cGUuaW5kZXhPZignOicpKSB7XG4gICAgICAgICAgICBsZXQgY2F0ID0gdHlwZS5zcGxpdCgnOicpWzFdO1xuICAgICAgICAgICAgaWYofmNhdHMuaW5kZXhPZihjYXQpKVxuICAgICAgICAgICAgICAgIHJldHVybiBjYXQ7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cblxuXG5cbi8qKlxuICpcbiAqL1xuY2xhc3MgRXZlbnQge1xuXG4gICAgcHJpdmF0ZSBjYXRlZ29yeSA6IHN0cmluZztcbiAgICBwcml2YXRlIHR5cGUgOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBpdGVtIDogYW55ID0gbnVsbDtcbiAgICBwcml2YXRlIHJlbGF0ZWQgOiBhbnkgPSBudWxsO1xuXG4gICAgY29uc3RydWN0b3IoY2F0ZWdvcnkgOiBzdHJpbmcsIHR5cGUgOiBzdHJpbmcsIGl0ZW0gPzogYW55LCByZWxhdGVkID86IGFueSkge1xuICAgICAgICBpZighY2F0ZWdvcnkgfHwgISB0eXBlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUcmFja2luZ1NlcnZpY2UgRXZlbnQgLSBNdXN0IHNwZWNpZmljIGFuIGV2ZW50IFwiICtcbiAgICAgICAgICAgIFwiY2F0ZWdvcnkgYW5kIGV2ZW50IHR5cGUgd2hlbiBjb25zdHJ1Y3RpbmcgZXZlbnRzXCIpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2F0ZWdvcnkgPSBjYXRlZ29yeTtcbiAgICAgICAgdGhpcy50eXBlID0gdHlwZTtcbiAgICAgICAgdGhpcy5zZXRJdGVtKGl0ZW0pO1xuICAgICAgICB0aGlzLnNldFJlbGF0ZWQocmVsYXRlZCk7XG4gICAgfVxuICAgIGdldENhdGVnb3J5KCkgOiBzdHJpbmcgeyByZXR1cm4gdGhpcy5jYXRlZ29yeTsgfVxuICAgIGdldFR5cGUoKSA6IHN0cmluZyB7IHJldHVybiB0aGlzLnR5cGU7IH1cbiAgICBnZXRJdGVtKCkgOiBhbnkgeyByZXR1cm4gdGhpcy5pdGVtOyB9XG4gICAgc2V0SXRlbShpdGVtIDogYW55KSB7IHRoaXMuaXRlbSA9IGl0ZW0gPyAoaXRlbS5pZCB8fCBpdGVtKSA6IG51bGw7IH1cbiAgICBnZXRSZWxhdGVkKCkgOiBhbnkgeyByZXR1cm4gdGhpcy5yZWxhdGVkOyB9XG4gICAgc2V0UmVsYXRlZChyZWxhdGVkIDogYW55KSB7XG4gICAgICAgIHRoaXMucmVsYXRlZCA9IHJlbGF0ZWQgPyAocmVsYXRlZC5pZCB8fCByZWxhdGVkKSA6IG51bGw7XG4gICAgfVxufVxuXG5cblxuLyoqXG4gKiBAcGFyYW0gZXZlbnRUeXBlIC0gdHlwZSBvZiBldmVudCBiZWluZyBjcmVhdGVkXG4gKiBAcGFyYW0gaXRlbSAtIEdlb1BsYXRmb3JtIEl0ZW0gaW5zdGFuY2VcbiAqIEByZXR1cm4gbGlzdCBvZiBldmVudCBvYmplY3RzXG4gKi9cbmZ1bmN0aW9uIFRyYWNraW5nRXZlbnRGYWN0b3J5KGV2ZW50VHlwZSA6IHN0cmluZywgaXRlbSA6IGFueSkgOiBFdmVudFtdIHtcbiAgICBsZXQgcmVzdWx0IDogRXZlbnRbXSA9IFtdIGFzIEV2ZW50W107XG4gICAgaWYoZXZlbnRUeXBlICYmIGl0ZW0gJiYgaXRlbS50eXBlKSB7XG4gICAgICAgIGlmKEl0ZW1UeXBlcy5NQVAgPT09IGl0ZW0udHlwZSkge1xuICAgICAgICAgICAgcmVzdWx0LnB1c2goIG5ldyBFdmVudChDYXRlZ29yaWVzLk1BUCwgZXZlbnRUeXBlLCBpdGVtKSApO1xuICAgICAgICAgICAgaWYoRXZlbnRzLkRJU1BMQVlFRCA9PT0gZXZlbnRUeXBlKSB7XG5cbiAgICAgICAgICAgICAgICBpdGVtLmxheWVycy5mb3JFYWNoKCAobGF5ZXJTdGF0ZSA6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZihsYXllclN0YXRlLmxheWVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgbGF5ZXJFdmVudHMgPSBUcmFja2luZ0V2ZW50RmFjdG9yeShldmVudFR5cGUsIGxheWVyU3RhdGUubGF5ZXIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihlPT5lIT09bnVsbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihsYXllckV2ZW50cyAmJiBsYXllckV2ZW50cy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KGxheWVyRXZlbnRzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgaWYoaXRlbS5iYXNlTGF5ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGJhc2VFdmVudHMgPSBUcmFja2luZ0V2ZW50RmFjdG9yeShldmVudFR5cGUsIGl0ZW0uYmFzZUxheWVyKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihlPT5lIT09bnVsbCk7XG4gICAgICAgICAgICAgICAgICAgIGlmKGJhc2VFdmVudHMgJiYgYmFzZUV2ZW50cy5sZW5ndGgpXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KCBiYXNlRXZlbnRzICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0gZWxzZSBpZihJdGVtVHlwZXMuTEFZRVIgPT09IGl0ZW0udHlwZSkge1xuICAgICAgICAgICAgcmVzdWx0LnB1c2goIG5ldyBFdmVudChDYXRlZ29yaWVzLkxBWUVSLCBldmVudFR5cGUsIGl0ZW0pICk7XG4gICAgICAgICAgICBpZihFdmVudHMuRElTUExBWUVEID09PSBldmVudFR5cGUgJiYgaXRlbS5zZXJ2aWNlcyAmJiBpdGVtLnNlcnZpY2VzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCBuZXcgRXZlbnQoQ2F0ZWdvcmllcy5TRVJWSUNFLCBldmVudFR5cGUsIGl0ZW0uc2VydmljZXNbMF0pICk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgY2F0ZWdvcnkgPSBnZXRDYXRlZ29yeShpdGVtLnR5cGUpO1xuICAgICAgICAgICAgcmVzdWx0LnB1c2goIG5ldyBFdmVudChjYXRlZ29yeSwgZXZlbnRUeXBlLCBpdGVtKSApO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8vIGVsc2Uge1xuICAgIC8vICAgICBpZighZXZlbnQpIGNvbnNvbGUubG9nKFwiTWlzc2luZyBldmVudFwiKTtcbiAgICAvLyAgICAgaWYoIWl0ZW0pIGNvbnNvbGUubG9nKFwiTWlzc2luZyBpdGVtXCIpO1xuICAgIC8vICAgICBpZighaXRlbS50eXBlKSBjb25zb2xlLmxvZyhcIk1pc3NpbmcgaXRlbSB0eXBlXCIpO1xuICAgIC8vIH1cbiAgICByZXR1cm4gcmVzdWx0O1xufVxuXG5cblxuXG5cbi8qKlxuICpcbiAqL1xuY2xhc3MgRGVmYXVsdFRyYWNraW5nU2VydmljZVByb3ZpZGVyIHtcbiAgICBjb25zdHJ1Y3RvcigpIHt9XG4gICAgbG9nRXZlbnQoXG4gICAgICAgIGNhdGVnb3J5IDogc3RyaW5nLFxuICAgICAgICBldmVudCA6IHN0cmluZyxcbiAgICAgICAgaXRlbSA/OiBhbnksXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgcmVsYXRlZCA/OiBhbnlcbiAgICApIHtcbiAgICAgICAgY29uc29sZS5sb2coIFwiRXZlbnQgKFwiICsgY2F0ZWdvcnkgKyBcIikgLSBcIiArIGV2ZW50ICsgXCIgOiBcIiArIGl0ZW0pO1xuICAgIH1cbiAgICBsb2dQYWdlVmlldyggdmlldywgZGF0YSApIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJQYWdlIFZpZXcgXCIgKyB2aWV3ICsgKGRhdGEgPyBcIiA6IFwiICsgSlNPTi5zdHJpbmdpZnkoZGF0YSkgOiAnJykgKTtcbiAgICB9XG4gICAgbG9nU2VhcmNoKHBhcmFtcyA6IHN0cmluZywgcmVzdWx0Q291bnQgOiBzdHJpbmd8bnVtYmVyKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCBcIlF1ZXJ5IDogXCIgKyBKU09OLnN0cmluZ2lmeShwYXJhbXMpICsgXCIgZm91bmQgXCIgKyByZXN1bHRDb3VudCsgXCIgbWF0Y2hlc1wiKTtcbiAgICB9XG59XG5cblxuXG5cblxuXG4vKipcbiAqIFRyYWNraW5nU2VydmljZVxuICpcbiAqIFNlcnZpY2UgZm9yIGxvZ2dpbmcgZXZlbnRzIHJlbGF0ZWQgdG8gdXNhZ2Ugb2YgdGhlIEdlb1BsYXRmb3JtIGFuZCBpdHMgZGF0YVxuICpcbiAqIEV4YW1wbGU6XG4gKlxuICogICBpbXBvcnQgeyBUcmFja2luZ1NlcnZpY2UsIEV2ZW50Q2F0ZWdvcmllcywgRXZlbnRUeXBlcyB9IGZyb20gJ2dlb3BsYXRmb3JtLmNsaWVudCc7XG4gKlxuICogICBsZXQgdHJhY2tlciA9IG5ldyBUcmFja2luZ1NlcnZpY2UoKTtcbiAqICAgdHJhY2tlci5zZXRQcm92aWRlciggLi4uICk7XG4gKiAgIHRyYWNrZXIuZXZlbnQoIEV2ZW50Lm9mKEV2ZW50Q2F0ZWdvcmllcy5NQVAsIEV2ZW50VHlwZXMuVklFV0VELCBtYXApICk7XG4gKlxuICogTXVsdGktZXZlbnQgZXhhbXBsZTpcbiAqXG4gKiAgIGltcG9ydCB7XG4gKiAgICAgIFRyYWNraW5nU2VydmljZSwgVHJhY2tpbmdFdmVudENhdGVnb3JpZXMsIFRyYWNraW5nRXZlbnRUeXBlcywgVHJhY2tpbmdFdmVudEZhY3RvcnlcbiAqICAgfSBmcm9tICdnZW9wbGF0Zm9ybS5jbGllbnQnO1xuICpcbiAqICAgbGV0IHRyYWNrZXIgPSBuZXcgVHJhY2tpbmdTZXJ2aWNlKCk7XG4gKiAgIHRyYWNrZXIuc2V0UHJvdmlkZXIoIC4uLiApO1xuICpcbiAqICAgbGV0IGV2ZW50cyA9IFtcbiAqICAgICAgIFRyYWNraW5nRXZlbnQub2YoIFRyYWNraW5nQ2F0ZWdvcmllcy5NQVAsIFRyYWNraW5nRXZlbnRUeXBlcy5WSUVXRUQsIHRoaXMubWFwIClcbiAqICAgICAgIFRyYWNraW5nRXZlbnQub2YoIFRyYWNraW5nQ2F0ZWdvcmllcy5MQVlFUiwgVHJhY2tpbmdFdmVudFR5cGVzLlZJRVdFRCwgdGhpcy5tYXAuYmFzZUxheWVyIClcbiAqICAgXTtcbiAqICAgdHJhY2tlci5ldmVudChldmVudHMpO1xuICpcbiAqICAgLy9PUiB1c2UgdGhlIGV2ZW50IGZhY3Rvcnk6XG4gKiAgIHRyYWNrZXIuZXZlbnQoIFRyYWNraW5nRXZlbnRGYWN0b3J5KEV2ZW50VHlwZXMuVklFV0VELCB0aGlzLm1hcCkgKTtcbiAqL1xuY2xhc3MgVHJhY2tpbmdTZXJ2aWNlIHtcblxuICAgIHByaXZhdGUgcHJvdmlkZXIgOiBhbnkgPSBudWxsO1xuXG4gICAgY29uc3RydWN0b3Iob3B0aW9ucyA/OiBhbnkpIHtcbiAgICAgICAgaWYob3B0aW9ucyAmJiB0eXBlb2Yob3B0aW9ucykgPT09ICdvYmplY3QnKVxuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLCBvcHRpb25zKTtcblxuICAgICAgICBpZighdGhpcy5wcm92aWRlcilcbiAgICAgICAgICAgIHRoaXMuc2V0UHJvdmlkZXIobmV3IERlZmF1bHRUcmFja2luZ1NlcnZpY2VQcm92aWRlcigpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0gcHJvdmlkZXIgLVxuICAgICAqL1xuICAgIHNldFByb3ZpZGVyKHByb3ZpZGVyIDogYW55KSB7XG4gICAgICAgIGlmKHByb3ZpZGVyKVxuICAgICAgICAgICAgdGhpcy5wcm92aWRlciA9IHByb3ZpZGVyO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSBldmVudCAtIGV2ZW50IHRvIGxvZ1xuICAgICAqIEByZXR1cm4gVHJhY2tpbmdTZXJ2aWNlXG4gICAgICovXG4gICAgZXZlbnQoIGV2ZW50IDogRXZlbnQgKSA6IFRyYWNraW5nU2VydmljZSB7XG4gICAgICAgIHRoaXMubG9nRXZlbnQoIGV2ZW50ICk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSBldmVudCAtIGV2ZW50IHRvIGxvZ1xuICAgICAqL1xuICAgIGxvZ0V2ZW50KCBldmVudCA6IEV2ZW50fEV2ZW50W10pIHtcbiAgICAgICAgaWYoIXRoaXMucHJvdmlkZXIgfHwgIXRoaXMucHJvdmlkZXIubG9nRXZlbnQgfHwgIWV2ZW50KSByZXR1cm47XG5cbiAgICAgICAgaWYoQXJyYXkuaXNBcnJheShldmVudCkpIHtcbiAgICAgICAgICAgIGxldCBldmVudHMgOiBFdmVudFtdID0gZXZlbnQgYXMgRXZlbnRbXTtcbiAgICAgICAgICAgIGV2ZW50cy5mb3JFYWNoKCAoZXZ0IDogRXZlbnQpID0+IHRoaXMubG9nRXZlbnQoZXZ0KSApO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgZXZ0IDogRXZlbnQgPSBldmVudCBhcyBFdmVudDtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wcm92aWRlci5sb2dFdmVudChcbiAgICAgICAgICAgICAgICAgICAgZXZ0LmdldENhdGVnb3J5KCksXG4gICAgICAgICAgICAgICAgICAgIGV2dC5nZXRUeXBlKCksXG4gICAgICAgICAgICAgICAgICAgIGV2dC5nZXRJdGVtKCksXG4gICAgICAgICAgICAgICAgICAgIGV2dC5nZXRSZWxhdGVkKClcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBjYXRjaChlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICAgICAgIFwiVHJhY2tpbmdTZXJ2aWNlLmxvZ0V2ZW50KCkgLSBFcnJvciBsb2dnaW5nIGV2ZW50IChcIiArXG4gICAgICAgICAgICAgICAgICAgIGV2dC5nZXRDYXRlZ29yeSgpICsgXCIsIFwiICsgZXZ0LmdldFR5cGUoKSArIFwiLCBcIiArXG4gICAgICAgICAgICAgICAgICAgIGV2dC5nZXRJdGVtKCkgKyBcIikgLSBcIiArIGUubWVzc2FnZVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB2aWV3IC0gbmFtZSBvZiB0aGUgdmlldyBiZWluZyBhY3RpdmF0ZWRcbiAgICAgKiBAcGFyYW0gZGF0YSAtIGFkZGl0aW9uYWwgY29udGV4dCB0byBzdXBwbHkgZm9yIHRoZSBldmVudFxuICAgICAqIEByZXR1cm4gVHJhY2tpbmdTZXJ2aWNlXG4gICAgICogQGRlcHJlY2F0ZWQgdXNlIHN2Yy5ldmVudCggbmV3IEV2ZW50KEV2ZW50Q2F0ZWdvcmllcy5BUFBfUEFHRSwgRXZlbnRUeXBlcy5WSUVXRUQsIHBhZ2VJZCkgKVxuICAgICAqL1xuICAgIHBhZ2VWaWV3KCB2aWV3IDogc3RyaW5nLCBkYXRhIDogYW55KSB7XG4gICAgICAgIHRoaXMubG9nUGFnZVZpZXcodmlldywgZGF0YSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB2aWV3IC0gbmFtZSBvZiB0aGUgdmlldyBiZWluZyBhY3RpdmF0ZWRcbiAgICAgKiBAcGFyYW0gZGF0YSAtIGFkZGl0aW9uYWwgY29udGV4dCB0byBzdXBwbHkgZm9yIHRoZSBldmVudFxuICAgICAqIEBkZXByZWNhdGVkIHVzZSBzdmMubG9nRXZlbnQoIG5ldyBFdmVudChFdmVudENhdGVnb3JpZXMuQVBQX1BBR0UsIEV2ZW50VHlwZXMuVklFV0VELCBwYWdlSWQpIClcbiAgICAgKi9cbiAgICBsb2dQYWdlVmlldyhcbiAgICAgICAgdmlldyA6IHN0cmluZyxcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBkYXRhID86IGFueVxuICAgICkge1xuICAgICAgICBpZih0aGlzLnByb3ZpZGVyICYmIHRoaXMucHJvdmlkZXIubG9nUGFnZVZpZXcpIHtcbiAgICAgICAgICAgIHRoaXMucHJvdmlkZXIubG9nUGFnZVZpZXcodmlldywgZGF0YSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ0V2ZW50KCBuZXcgRXZlbnQoQ2F0ZWdvcmllcy5BUFBfUEFHRSwgRXZlbnRzLlZJRVdFRCwgdmlldykgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSBwYXJhbXNcbiAgICAgKiBAcGFyYW0gcmVzdWx0Q291bnRcbiAgICAgKi9cbiAgICBsb2dTZWFyY2ggKHBhcmFtcyA6IGFueSwgcmVzdWx0Q291bnQgOiBzdHJpbmd8bnVtYmVyKSB7XG4gICAgICAgIGlmKHRoaXMucHJvdmlkZXIubG9nU2VhcmNoKVxuICAgICAgICAgICAgdGhpcy5wcm92aWRlci5sb2dTZWFyY2gocGFyYW1zLCByZXN1bHRDb3VudCk7XG4gICAgfVxuXG59XG5cblxuZXhwb3J0IHtcbiAgICBFdmVudCBhcyBUcmFja2luZ0V2ZW50LFxuICAgIFRyYWNraW5nU2VydmljZSxcbiAgICBDYXRlZ29yaWVzIGFzIFRyYWNraW5nQ2F0ZWdvcmllcyxcbiAgICBFdmVudHMgYXMgVHJhY2tpbmdUeXBlcyxcbiAgICBUcmFja2luZ0V2ZW50RmFjdG9yeVxufTtcbiJdfQ==