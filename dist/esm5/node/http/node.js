/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { GPHttpClient } from '@geoplatform/client';
var NodeHttpClient = /** @class */ (function (_super) {
    tslib_1.__extends(NodeHttpClient, _super);
    /**
     * @param options.timeout
     * @param options.token - the bearer token or a function to retrieve it
     */
    function NodeHttpClient(options) {
        return _super.call(this, options) || this;
    }
    /**
     * @param {?} options
     * @return {?}
     */
    NodeHttpClient.prototype.createRequestOpts = /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        /** @type {?} */
        var opts = {
            method: options["method"],
            url: options["url"],
            json: false !== options["json"],
            timeout: options["timeout"] || this.timeout
        };
        if (options["params"]) {
            opts["qs"] = options["params"];
        }
        if (options["file"]) {
            /** @type {?} */
            var fs = require('fs');
            if (!fs)
                throw new Error("Module 'fs' not available");
            opts["formData"] = {
                file: {
                    value: fs.createReadStream(options["file"].path),
                    options: {
                        filename: options["file"].originalFilename
                    }
                }
            };
            Object.assign(opts["formData"], options["data"] || {});
        }
        else if (options["data"]) {
            if (options["formData"]) {
                opts["formData"] = options["data"];
            }
            else {
                opts["body"] = options["data"];
            }
        }
        //set authorization header if one was provided
        if (this.token) {
            /** @type {?} */
            var token = this.token();
            if (token) {
                opts["auth"] = { 'bearer': token };
            }
        }
        //copy over user-supplied options
        if (options["options"]) {
            for (var o in options["options"]) {
                if (options["options"].hasOwnProperty(o)) {
                    opts[o] = options["options"][o];
                }
            }
        }
        // console.log(JSON.stringify(opts));
        return opts;
    };
    /**
     *
     */
    /**
     *
     * @param {?} options
     * @return {?}
     */
    NodeHttpClient.prototype.execute = /**
     *
     * @param {?} options
     * @return {?}
     */
    function (options) {
        var _this = this;
        /** @type {?} */
        var request = require('request');
        // require('request-debug')(request);
        if (!request) {
            throw new Error("Module 'request' not available");
        }
        return new Promise(function (resolve, reject) {
            request(options, function (error, response, body) {
                _this.checkAndHandleError(error, response)
                    .then(function () {
                    if (options.json === false)
                        resolve(response);
                    else
                        resolve(body);
                })
                    .catch(function (e) { return reject(e); });
            });
        });
    };
    /**
     *
     */
    /**
     *
     * @param {?} error
     * @param {?} response
     * @return {?}
     */
    NodeHttpClient.prototype.checkAndHandleError = /**
     *
     * @param {?} error
     * @param {?} response
     * @return {?}
     */
    function (error, response) {
        /** @type {?} */
        var props = {
            message: null,
            error: null,
            //error type
            status: 200
        };
        if (error) {
            // Logger.debug("Error generated by request library: " + error.code);
            if (error.code === 'ETIMEDOUT' || error.code === 'ESOCKETTIMEDOUT') {
                props["status"] = 500;
                props["error"] = "Connection Timeout";
                props["message"] = "The response from the service took too long to read";
                if (error.connect === true) {
                    props["message"] = "Unable to establish a connection to the service";
                }
            }
            else {
                return Promise.reject(error);
            }
        }
        else if (response.statusCode < 200 || response.statusCode > 204) {
            // Logger.debug('Error returned by remote endpoint (' + response.statusCode + ')');
            // Logger.debug(JSON.stringify(response));
            props["status"] = response.statusCode;
            if (response.body && typeof (response.body) === 'object') {
                props = response.body;
                props["status"] = props["status"] || response.statusCode;
                props["message"] = props["message"] || "An error occurred communicating with service";
                if (response.statusCode === 409) {
                    /** @type {?} */
                    var sidx = response.body.message.indexOf(" ");
                    /** @type {?} */
                    var eidx = response.body.message.indexOf(' already exists');
                    if (sidx >= 0 && eidx > sidx) {
                        props["item"] = response.body.message.substring(sidx + 1, eidx);
                    }
                }
            }
            else {
                switch (response.statusCode) {
                    case 404:
                        props["error"] = "Not Found";
                        props["message"] = response.request.uri.pathname + " cannot be found";
                        break;
                    case 401:
                        props["error"] = "Unauthenticated";
                        props["message"] = "You are not authenticated";
                        break;
                    case 403:
                        props["error"] = "Unauthorized";
                        props["message"] = "You are not authorized to access " + response.request.uri.pathname;
                        break;
                    case 409:
                        props["error"] = "Conflict";
                        props["message"] = "Item already exists";
                        // pattern received is: { ..., message: 'Resource <identifier> already exists', ... }
                        try {
                            /** @type {?} */
                            var json = JSON.parse(response.body);
                            /** @type {?} */
                            var sidx = json.message.indexOf(" ");
                            /** @type {?} */
                            var eidx = json.message.indexOf(' already exists');
                            if (sidx >= 0 && eidx > sidx) {
                                props["item"] = json.message.substring(sidx + 1, eidx);
                            }
                        }
                        catch (e) {
                            props["message"] += '.  Unable to extract existing identifier from service response';
                        }
                        break;
                    default:
                        try {
                            /** @type {?} */
                            var json = JSON.parse(response.body);
                            props = json;
                            props["status"] = response.statusCode;
                            // Logger.debug("PARSED ERROR: " + JSON.stringify(props));
                        }
                        catch (e) {
                            props["error"] = "Server Error";
                            props["message"] = response.body;
                            // Logger.debug("DEFAULTED ERROR: " + JSON.stringify(props));
                        }
                }
            }
        }
        if (props["status"] < 200 || props["status"] > 204) {
            props["error"] = props["error"] || "Server Error";
            props["status"] = props["status"] || response.statusCode;
            props["message"] = props["message"] || "An error occurred communicating with service";
            /** @type {?} */
            var err = new Error(props["message"]);
            Object.assign(err, props);
            // Logger.debug("UTILS.checkAndHandleError : " + err);
            // Logger.debug("UTILS.checkAndHandleError : " + JSON.stringify(err));
            // Logger.debug("UTILS.checkAndHandleError : " + err.message);
            return Promise.reject(err);
        }
        return Promise.resolve(null);
    };
    return NodeHttpClient;
}(GPHttpClient));
export default NodeHttpClient;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BnZW9wbGF0Zm9ybS9jbGllbnQvbm9kZS8iLCJzb3VyY2VzIjpbImh0dHAvbm9kZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUduRCxJQUFBO0lBQTZCLDBDQUFZO0lBRXJDOzs7T0FHRztJQUNILHdCQUFZLE9BQWlDO2VBQ3pDLGtCQUFNLE9BQU8sQ0FBQztLQUNqQjs7Ozs7SUFFRCwwQ0FBaUI7Ozs7SUFBakIsVUFBa0IsT0FBZ0M7O1FBRTlDLElBQUksSUFBSSxHQUF5QjtZQUM3QixNQUFNLEVBQUUsT0FBTyxVQUFPO1lBQ3RCLEdBQUcsRUFBRSxPQUFPLE9BQUk7WUFDaEIsSUFBSSxFQUFFLEtBQUssS0FBSyxPQUFPLFFBQUs7WUFDNUIsT0FBTyxFQUFFLE9BQU8sZUFBWSxJQUFJLENBQUMsT0FBTztTQUMzQyxDQUFDO1FBRUYsSUFBRyxPQUFPLFlBQVM7WUFDZixJQUFJLFNBQU0sT0FBTyxVQUFPLENBQUM7U0FDNUI7UUFFRCxJQUFHLE9BQU8sVUFBTzs7WUFDYixJQUFNLEVBQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDekIsSUFBRyxDQUFDLEVBQUU7Z0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1lBQ3JELElBQUksZUFBWTtnQkFDWixJQUFJLEVBQUU7b0JBQ0YsS0FBSyxFQUFHLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLFNBQU0sSUFBSSxDQUFDO29CQUM5QyxPQUFPLEVBQUU7d0JBQ0wsUUFBUSxFQUFFLE9BQU8sU0FBTSxnQkFBZ0I7cUJBQzFDO2lCQUNKO2FBQ0osQ0FBQztZQUNGLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxjQUFXLE9BQU8sWUFBTyxFQUFFLENBQUMsQ0FBQztTQUVsRDthQUFNLElBQUcsT0FBTyxVQUFPO1lBQ3BCLElBQUcs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QU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDOUI7UUFFRCxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDaEM7eUJBcE5MO0VBSTZCLFlBQVksRUFrTnhDLENBQUE7QUFHRCxlQUFlLGNBQWMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgR1BIdHRwQ2xpZW50IH0gZnJvbSAnQGdlb3BsYXRmb3JtL2NsaWVudCc7XG5cblxuY2xhc3MgTm9kZUh0dHBDbGllbnQgZXh0ZW5kcyBHUEh0dHBDbGllbnQge1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIG9wdGlvbnMudGltZW91dFxuICAgICAqIEBwYXJhbSBvcHRpb25zLnRva2VuIC0gdGhlIGJlYXJlciB0b2tlbiBvciBhIGZ1bmN0aW9uIHRvIHJldHJpZXZlIGl0XG4gICAgICovXG4gICAgY29uc3RydWN0b3Iob3B0aW9ucyA/OiB7IFtrZXk6c3RyaW5nXSA6IGFueSB9KSB7XG4gICAgICAgIHN1cGVyKG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGNyZWF0ZVJlcXVlc3RPcHRzKG9wdGlvbnMgOiB7IFtrZXk6c3RyaW5nXSA6IGFueSB9KSA6IGFueSB7XG5cbiAgICAgICAgbGV0IG9wdHMgOiB7W2tleTpzdHJpbmddOiBhbnl9ID0ge1xuICAgICAgICAgICAgbWV0aG9kOiBvcHRpb25zLm1ldGhvZCxcbiAgICAgICAgICAgIHVybDogb3B0aW9ucy51cmwsXG4gICAgICAgICAgICBqc29uOiBmYWxzZSAhPT0gb3B0aW9ucy5qc29uLFxuICAgICAgICAgICAgdGltZW91dDogb3B0aW9ucy50aW1lb3V0IHx8IHRoaXMudGltZW91dFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmKG9wdGlvbnMucGFyYW1zKSB7XG4gICAgICAgICAgICBvcHRzLnFzID0gb3B0aW9ucy5wYXJhbXM7XG4gICAgICAgIH1cblxuICAgICAgICBpZihvcHRpb25zLmZpbGUpIHtcbiAgICAgICAgICAgIGNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbiAgICAgICAgICAgIGlmKCFmcykgdGhyb3cgbmV3IEVycm9yKFwiTW9kdWxlICdmcycgbm90IGF2YWlsYWJsZVwiKTtcbiAgICAgICAgICAgIG9wdHMuZm9ybURhdGEgPSB7XG4gICAgICAgICAgICAgICAgZmlsZToge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogIGZzLmNyZWF0ZVJlYWRTdHJlYW0ob3B0aW9ucy5maWxlLnBhdGgpLFxuICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxlbmFtZTogb3B0aW9ucy5maWxlLm9yaWdpbmFsRmlsZW5hbWVcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKG9wdHMuZm9ybURhdGEsIG9wdGlvbnMuZGF0YXx8e30pO1xuXG4gICAgICAgIH0gZWxzZSBpZihvcHRpb25zLmRhdGEpIHtcbiAgICAgICAgICAgIGlmKG9wdGlvbnMuZm9ybURhdGEpIHtcbiAgICAgICAgICAgICAgICBvcHRzLmZvcm1EYXRhID0gb3B0aW9ucy5kYXRhO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBvcHRzLmJvZHkgPSBvcHRpb25zLmRhdGE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvL3NldCBhdXRob3JpemF0aW9uIGhlYWRlciBpZiBvbmUgd2FzIHByb3ZpZGVkXG4gICAgICAgIGlmKHRoaXMudG9rZW4pIHtcbiAgICAgICAgICAgIGxldCB0b2tlbiA9IHRoaXMudG9rZW4oKTtcbiAgICAgICAgICAgIGlmKHRva2VuKSB7XG4gICAgICAgICAgICAgICAgb3B0cy5hdXRoID0geyAnYmVhcmVyJzogdG9rZW4gfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vY29weSBvdmVyIHVzZXItc3VwcGxpZWQgb3B0aW9uc1xuICAgICAgICBpZihvcHRpb25zLm9wdGlvbnMpIHtcbiAgICAgICAgICAgIGZvcihsZXQgbyBpbiBvcHRpb25zLm9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBpZihvcHRpb25zLm9wdGlvbnMuaGFzT3duUHJvcGVydHkobykpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0c1tvXSA9IG9wdGlvbnMub3B0aW9uc1tvXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShvcHRzKSk7XG5cbiAgICAgICAgcmV0dXJuIG9wdHM7XG4gICAgfVxuXG5cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgZXhlY3V0ZShvcHRpb25zIDogYW55KSA6IFByb21pc2U8YW55PiB7XG5cbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QnKTtcbiAgICAgICAgLy8gcmVxdWlyZSgncmVxdWVzdC1kZWJ1ZycpKHJlcXVlc3QpO1xuICAgICAgICBpZighcmVxdWVzdCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTW9kdWxlICdyZXF1ZXN0JyBub3QgYXZhaWxhYmxlXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHJlcXVlc3Qob3B0aW9ucywgKGVycm9yIDogYW55LCByZXNwb25zZSA6IGFueSwgYm9keSA6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tBbmRIYW5kbGVFcnJvcihlcnJvciwgcmVzcG9uc2UpXG4gICAgICAgICAgICAgICAgLnRoZW4oICgpID0+ICB7XG4gICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMuanNvbiA9PT0gZmFsc2UpIHJlc29sdmUoIHJlc3BvbnNlICk7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmVzb2x2ZSggYm9keSApO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKCBlID0+IHJlamVjdChlKSApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIGNoZWNrQW5kSGFuZGxlRXJyb3IgKGVycm9yIDogYW55LCByZXNwb25zZSA6IGFueSkgOiBQcm9taXNlPGFueT4ge1xuXG4gICAgICAgIGxldCBwcm9wcyA6IHsgW2tleTpzdHJpbmddOiBhbnkgfSA9IHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IG51bGwsXG4gICAgICAgICAgICBlcnJvcjogbnVsbCwgICAgLy9lcnJvciB0eXBlXG4gICAgICAgICAgICBzdGF0dXM6IDIwMFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmKGVycm9yKSB7XG4gICAgICAgICAgICAvLyBMb2dnZXIuZGVidWcoXCJFcnJvciBnZW5lcmF0ZWQgYnkgcmVxdWVzdCBsaWJyYXJ5OiBcIiArIGVycm9yLmNvZGUpO1xuXG4gICAgICAgICAgICBpZihlcnJvci5jb2RlID09PSAnRVRJTUVET1VUJyB8fCBlcnJvci5jb2RlID09PSAnRVNPQ0tFVFRJTUVET1VUJykge1xuXG4gICAgICAgICAgICAgICAgcHJvcHMuc3RhdHVzID0gNTAwO1xuICAgICAgICAgICAgICAgIHByb3BzLmVycm9yID0gXCJDb25uZWN0aW9uIFRpbWVvdXRcIjtcbiAgICAgICAgICAgICAgICBwcm9wcy5tZXNzYWdlID0gXCJUaGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmljZSB0b29rIHRvbyBsb25nIHRvIHJlYWRcIjtcblxuICAgICAgICAgICAgICAgIGlmKGVycm9yLmNvbm5lY3QgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvcHMubWVzc2FnZSA9IFwiVW5hYmxlIHRvIGVzdGFibGlzaCBhIGNvbm5lY3Rpb24gdG8gdGhlIHNlcnZpY2VcIjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9IGVsc2UgaWYocmVzcG9uc2Uuc3RhdHVzQ29kZSA8IDIwMCB8fCByZXNwb25zZS5zdGF0dXNDb2RlID4gMjA0KSB7XG5cbiAgICAgICAgICAgIC8vIExvZ2dlci5kZWJ1ZygnRXJyb3IgcmV0dXJuZWQgYnkgcmVtb3RlIGVuZHBvaW50ICgnICsgcmVzcG9uc2Uuc3RhdHVzQ29kZSArICcpJyk7XG4gICAgICAgICAgICAvLyBMb2dnZXIuZGVidWcoSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpKTtcblxuICAgICAgICAgICAgcHJvcHMuc3RhdHVzID0gcmVzcG9uc2Uuc3RhdHVzQ29kZTtcblxuICAgICAgICAgICAgaWYocmVzcG9uc2UuYm9keSAmJiB0eXBlb2YocmVzcG9uc2UuYm9keSkgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgcHJvcHMgPSByZXNwb25zZS5ib2R5O1xuICAgICAgICAgICAgICAgIHByb3BzLnN0YXR1cyA9IHByb3BzLnN0YXR1cyB8fCByZXNwb25zZS5zdGF0dXNDb2RlO1xuICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgPSBwcm9wcy5tZXNzYWdlIHx8IFwiQW4gZXJyb3Igb2NjdXJyZWQgY29tbXVuaWNhdGluZyB3aXRoIHNlcnZpY2VcIjtcblxuICAgICAgICAgICAgICAgIGlmKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDQwOSkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgc2lkeCA9IHJlc3BvbnNlLmJvZHkubWVzc2FnZS5pbmRleE9mKFwiIFwiKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGVpZHggPSByZXNwb25zZS5ib2R5Lm1lc3NhZ2UuaW5kZXhPZignIGFscmVhZHkgZXhpc3RzJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmKHNpZHggPj0gMCAmJiBlaWR4ID4gc2lkeCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuaXRlbSA9IHJlc3BvbnNlLmJvZHkubWVzc2FnZS5zdWJzdHJpbmcoc2lkeCsxLCBlaWR4KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIHN3aXRjaChyZXNwb25zZS5zdGF0dXNDb2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgNDA0IDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLmVycm9yID0gXCJOb3QgRm91bmRcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgPSByZXNwb25zZS5yZXF1ZXN0LnVyaS5wYXRobmFtZSArIFwiIGNhbm5vdCBiZSBmb3VuZFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgNDAxIDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLmVycm9yID0gXCJVbmF1dGhlbnRpY2F0ZWRcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgPSBcIllvdSBhcmUgbm90IGF1dGhlbnRpY2F0ZWRcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDQwMyA6XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5lcnJvciA9IFwiVW5hdXRob3JpemVkXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5tZXNzYWdlID0gXCJZb3UgYXJlIG5vdCBhdXRob3JpemVkIHRvIGFjY2VzcyBcIiArIHJlc3BvbnNlLnJlcXVlc3QudXJpLnBhdGhuYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgNDA5IDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLmVycm9yID0gXCJDb25mbGljdFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMubWVzc2FnZSA9IFwiSXRlbSBhbHJlYWR5IGV4aXN0c1wiO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBwYXR0ZXJuIHJlY2VpdmVkIGlzOiB7IC4uLiwgbWVzc2FnZTogJ1Jlc291cmNlIDxpZGVudGlmaWVyPiBhbHJlYWR5IGV4aXN0cycsIC4uLiB9XG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBqc29uID0gSlNPTi5wYXJzZShyZXNwb25zZS5ib2R5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2lkeCA9IGpzb24ubWVzc2FnZS5pbmRleE9mKFwiIFwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZWlkeCA9IGpzb24ubWVzc2FnZS5pbmRleE9mKCcgYWxyZWFkeSBleGlzdHMnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihzaWR4ID49IDAgJiYgZWlkeCA+IHNpZHgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuaXRlbSA9IGpzb24ubWVzc2FnZS5zdWJzdHJpbmcoc2lkeCsxLCBlaWR4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKCBlICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgKz0gJy4gIFVuYWJsZSB0byBleHRyYWN0IGV4aXN0aW5nIGlkZW50aWZpZXIgZnJvbSBzZXJ2aWNlIHJlc3BvbnNlJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGpzb24gPSBKU09OLnBhcnNlKHJlc3BvbnNlLmJvZHkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzID0ganNvbjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5zdGF0dXMgPSByZXNwb25zZS5zdGF0dXNDb2RlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExvZ2dlci5kZWJ1ZyhcIlBBUlNFRCBFUlJPUjogXCIgKyBKU09OLnN0cmluZ2lmeShwcm9wcykpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuZXJyb3IgPSBcIlNlcnZlciBFcnJvclwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgPSByZXNwb25zZS5ib2R5O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExvZ2dlci5kZWJ1ZyhcIkRFRkFVTFRFRCBFUlJPUjogXCIgKyBKU09OLnN0cmluZ2lmeShwcm9wcykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICBpZiggcHJvcHMuc3RhdHVzIDwgMjAwIHx8IHByb3BzLnN0YXR1cyA+IDIwNCApIHtcblxuICAgICAgICAgICAgcHJvcHMuZXJyb3IgPSBwcm9wcy5lcnJvciB8fCBcIlNlcnZlciBFcnJvclwiO1xuICAgICAgICAgICAgcHJvcHMuc3RhdHVzID0gcHJvcHMuc3RhdHVzIHx8IHJlc3BvbnNlLnN0YXR1c0NvZGU7XG4gICAgICAgICAgICBwcm9wcy5tZXNzYWdlID0gcHJvcHMubWVzc2FnZSB8fCBcIkFuIGVycm9yIG9jY3VycmVkIGNvbW11bmljYXRpbmcgd2l0aCBzZXJ2aWNlXCI7XG5cbiAgICAgICAgICAgIGxldCBlcnIgPSBuZXcgRXJyb3IocHJvcHMubWVzc2FnZSk7XG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKGVyciwgcHJvcHMpO1xuXG4gICAgICAgICAgICAvLyBMb2dnZXIuZGVidWcoXCJVVElMUy5jaGVja0FuZEhhbmRsZUVycm9yIDogXCIgKyBlcnIpO1xuICAgICAgICAgICAgLy8gTG9nZ2VyLmRlYnVnKFwiVVRJTFMuY2hlY2tBbmRIYW5kbGVFcnJvciA6IFwiICsgSlNPTi5zdHJpbmdpZnkoZXJyKSk7XG4gICAgICAgICAgICAvLyBMb2dnZXIuZGVidWcoXCJVVElMUy5jaGVja0FuZEhhbmRsZUVycm9yIDogXCIgKyBlcnIubWVzc2FnZSk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbCk7XG4gICAgfVxuXG59XG5cblxuZXhwb3J0IGRlZmF1bHQgTm9kZUh0dHBDbGllbnQ7XG4iXX0=