import ItemTypes from './types';
const URI_BASE = 'http://www.geoplatform.gov';
const ESRI_TYPES = [
    "http://www.geoplatform.gov/spec/esri-feature-rest",
    "http://www.geoplatform.gov/spec/esri-image-rest",
    "http://www.geoplatform.gov/spec/esri-map-rest",
    "http://www.geoplatform.gov/spec/esri-tile-rest"
];
function formatReference(ref) {
    if (ref === null)
        return '';
    if (typeof (ref) === 'string')
        return ref.toLowerCase().replace(/\s/g, '');
    else if (typeof (ref) === 'object') {
        var result = '';
        for (var prop in ref) {
            if (ref.hasOwnProperty(prop)) {
                var value = ref[prop];
                if (value !== null && typeof (value) !== 'undefined') {
                    //TODO catch non-string-able values
                    result += (value + '').toLowerCase().replace(/\s/g, '');
                }
            }
        }
        return result;
    }
    return '';
}
/**
 * Adjusts service access url to ignore certain patterns that can affect
 * how URI uniqueness is.
 * @param service - GP Service instance
 * @return access url adjusted for URI generation needs
 */
function fixServiceHref(service) {
    stripLayerFromServiceHref(service);
    let url = service.accessURL || service.href;
    if (!url || !url.length)
        return null;
    //ensure case sensitivity is not an issue
    // and that any surrounding whitespace is ignored
    url = (url + '').trim().toLowerCase();
    url = url.replace(/http(s)?:\/\//, ''); //ignore protocol for URI purposes
    url = url.replace(/&?request=[A-Za-z]+/i, '')
        .replace(/&?service=(WMS|WFS|WCS|CSW)/i, '')
        .replace(/&?version=[0-9\.]*/i, '')
        .replace(/&?layers=[A-Za-z0-9\-\:_,]*/i, '')
        .replace(/&?srs=[A-Za-z0-9\:]*/i, '')
        .replace(/&?crs=[A-Za-z0-9\:]*/i, '')
        .replace(/&?format=[A-Za-z\/]*/i, '')
        .replace(/&?bbox=[0-9,\.]*/i, '');
    let lastChar = url[url.length - 1];
    if ('/' === lastChar || '?' === lastChar) { //ignore empty querystring or trailing slashes
        url = url.substring(0, url.length - 1);
    }
    return url;
}
/**
 * ESRI services sometimes have layer information baked into their URL
 * which needs to be removed before the service can be used.
 * @param service - GP Service object
 */
function stripLayerFromServiceHref(service) {
    if (!service)
        return;
    let type = service.serviceType || service.conformsTo;
    if (!type)
        return;
    //if ESRI service, make sure it doesn't have a layer id on the href
    if (ESRI_TYPES.indexOf(type.uri) >= 0) {
        let href = service.href || service.accessURL;
        let matches = href.match(/(Map|Feature|Image)(Server\/\d+)/i);
        if (matches && matches.length > 2) {
            // 0 < full string match (ie, 'MapServer/1')
            // 1 < server type match (ie, 'Map' or 'Feature')
            // 2 < bit we care about (ie, 'Server/1')
            href = href.replace(matches[2], 'Server/');
            if (service.href)
                service.href = href;
            if (service.accessURL)
                service.accessURL = href;
        }
    }
}
const ɵ0 = function (type, factory) {
    this.factories[type] = factory;
}, ɵ1 = function (object, md5Fn) {
    if (!object || !object.type)
        return null;
    if (typeof (md5Fn) !== 'function') {
        throw new Error("Must specify a MD5 function when using URIFactory");
    }
    let factory = this.factories[object.type];
    if (!factory)
        return null;
    return factory(object, md5Fn);
};
/**
 * @see https://geoplatform.atlassian.net/wiki/display/DT/Common+Object+Identifier+Scheme
 */
const URIFactory = {
    factories: {},
    register: ɵ0,
    create: ɵ1
};
URIFactory.register(ItemTypes.DATASET, function (dataset, md5) {
    let pubName = (dataset.publisher || dataset.publishers || [])
        .map(pub => { return pub.label || ""; }).join('');
    let ref = formatReference({
        title: dataset.title,
        pub: pubName
    });
    return URI_BASE + '/id/dataset/' + md5(ref);
});
URIFactory.register(ItemTypes.SERVICE, function (service, md5) {
    let url = fixServiceHref(service);
    let ref = formatReference(url);
    return URI_BASE + '/id/service/' + md5(ref);
});
URIFactory.register(ItemTypes.LAYER, function (layer, md5) {
    let svcUrl = '';
    let services = layer.servicedBy || layer.services;
    if (services && services.length)
        svcUrl = services[0].accessURL || services[0].href || '';
    let lyrUrl = layer.accessURL || layer.href || '';
    let lyrName = layer.layerName || '';
    //not recommended based upon following example:
    //  http://services.nationalmap.gov/.../MapServer/WMSServer?request=GetCapabilities&service=WMS/layer/1
    // return url + '/layer/' + layer.layerName;
    let args = svcUrl + lyrName + lyrUrl;
    if (!args.length)
        return null; //nothing was provided
    //ALTERNATE URI PATTERN
    let ref = formatReference(args);
    return URI_BASE + '/id/layer/' + md5(ref);
});
/**
 * Uses the map title, createdBy, and all third-party identifiers associated with the map
 * @param {object} map - GP Map object
 * @return {string} uri unique to this object
 */
URIFactory.register(ItemTypes.MAP, function (map, md5) {
    let author = map.createdBy || map._createdBy || "";
    let identifiers = (map.identifiers || map.identifier || []).join('');
    let ref = formatReference({ title: map.title, author: author, identifiers: identifiers });
    return URI_BASE + '/id/map/' + md5(ref);
});
URIFactory.register(ItemTypes.GALLERY, function (gallery, md5) {
    let author = gallery.createdBy || gallery._createdBy || "";
    let ref = formatReference({ title: gallery.title, author: author });
    return URI_BASE + '/id/gallery/' + md5(ref);
});
URIFactory.register(ItemTypes.COMMUNITY, function (community, md5) {
    let ref = formatReference({ title: community.title });
    return URI_BASE + '/id/community/' + md5(ref);
});
URIFactory.register(ItemTypes.ORGANIZATION, function (org, md5) {
    let ref = formatReference(org.label || org.name);
    return URI_BASE + '/id/organization/' + md5(ref);
});
URIFactory.register(ItemTypes.PERSON, function (person, md5) {
    let ref = formatReference(person.name);
    return URI_BASE + '/id/person/' + md5(ref);
});
URIFactory.register(ItemTypes.CONTACT, function (vcard, md5) {
    let ref = {};
    if (vcard.email || vcard.hasEmail)
        ref.email = vcard.email || vcard.hasEmail; //email
    if (vcard.tel)
        ref.tel = vcard.tel; //tel
    if (vcard.orgName || vcard['organization-name'])
        ref.orgName = vcard.orgName || vcard['organization-name']; //orgName
    if (vcard.positionTitle)
        ref.positionTitle = vcard.positionTitle; //positionTitle
    ref = formatReference(ref);
    return URI_BASE + '/id/contact/' + md5(ref);
});
URIFactory.register(ItemTypes.CONCEPT, function (object, md5) {
    let scheme = object.inScheme || object.scheme;
    let schemeLabel = scheme ? (scheme.label || scheme.prefLabel) : '';
    let schemeRef = formatReference(schemeLabel);
    let ref = formatReference(object.label || object.prefLabel);
    return URI_BASE + '/id/metadata-codelists/' + md5(schemeRef) + '/' + md5(ref);
});
URIFactory.register(ItemTypes.CONCEPT_SCHEME, function (object, md5) {
    let ref = formatReference(object.label || object.prefLabel);
    return URI_BASE + '/id/metadata-codelists/' + md5(ref);
});
URIFactory.register(ItemTypes.APPLICATION, function (object, md5) {
    if (!object || !object.title)
        return null;
    let author = object.createdBy || object._createdBy || "";
    let ref = formatReference({ title: object.title, author: author });
    return URI_BASE + '/id/application/' + md5(ref);
});
URIFactory.register(ItemTypes.TOPIC, function (object, md5) {
    if (!object || !object.title)
        return null;
    let author = object.createdBy || object._createdBy || "";
    let ref = formatReference({ title: object.title, author: author });
    return URI_BASE + '/id/topic/' + md5(ref);
});
URIFactory.register(ItemTypes.WEBSITE, function (item, md5) {
    if (!item || !item.landingPage)
        return null;
    let ref = formatReference(item.landingPage);
    return URI_BASE + '/id/website/' + md5(ref);
});
function factoryFn(md5Fn) {
    if (typeof (md5Fn) !== 'function') {
        throw new Error("Must specify a MD5 function when using URIFactory");
    }
    return function (object) {
        return URIFactory.create(object, md5Fn);
    };
}
export { factoryFn as default, factoryFn as URIFactory };
export { ɵ0, ɵ1 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXJpLWZhY3RvcnkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ2VvcGxhdGZvcm0vY2xpZW50LyIsInNvdXJjZXMiOlsic2hhcmVkL3VyaS1mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sU0FBUyxNQUFNLFNBQVMsQ0FBQztBQUloQyxNQUFNLFFBQVEsR0FBRyw0QkFBNEIsQ0FBQztBQUU5QyxNQUFNLFVBQVUsR0FBRztJQUNmLG1EQUFtRDtJQUNuRCxpREFBaUQ7SUFDakQsK0NBQStDO0lBQy9DLGdEQUFnRDtDQUNuRCxDQUFDO0FBS0YsU0FBUyxlQUFlLENBQUUsR0FBUztJQUMvQixJQUFHLEdBQUcsS0FBSyxJQUFJO1FBQUUsT0FBTyxFQUFFLENBQUM7SUFDM0IsSUFBRyxPQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssUUFBUTtRQUN2QixPQUFPLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQzFDLElBQUcsT0FBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFFBQVEsRUFBRTtRQUM5QixJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDaEIsS0FBSSxJQUFJLElBQUksSUFBSSxHQUFHLEVBQUU7WUFDakIsSUFBRyxHQUFHLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUN6QixJQUFJLEtBQUssR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3RCLElBQUcsS0FBSyxLQUFLLElBQUksSUFBSSxPQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssV0FBVyxFQUFFO29CQUNoRCxtQ0FBbUM7b0JBQ25DLE1BQU0sSUFBSSxDQUFDLEtBQUssR0FBQyxFQUFFLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUN4RDthQUNKO1NBQ0o7UUFDRCxPQUFPLE1BQU0sQ0FBQztLQUNqQjtJQUNELE9B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O0lBQzVDLE9BQU8sUUFBUSxHQUFHLGNBQWMsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDaEQsQ0FBQyxDQUFDLENBQUM7QUFJSCxTQUFTLFNBQVMsQ0FBQyxLQUFLO0lBQ3BCLElBQUksT0FBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLFVBQVUsRUFBRztRQUMvQixNQUFNLElBQUksS0FBSyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7S0FDeEU7SUFDRCxPQUFPLFVBQVMsTUFBTTtRQUNsQixPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzVDLENBQUMsQ0FBQztBQUNOLENBQUM7QUFJRCxPQUFPLEVBQ0gsU0FBUyxJQUFJLE9BQU8sRUFDcEIsU0FBUyxJQUFJLFVBQVUsRUFDMUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IEl0ZW1UeXBlcyBmcm9tICcuL3R5cGVzJztcblxuXG5cbmNvbnN0IFVSSV9CQVNFID0gJ2h0dHA6Ly93d3cuZ2VvcGxhdGZvcm0uZ292JztcblxuY29uc3QgRVNSSV9UWVBFUyA9IFtcbiAgICBcImh0dHA6Ly93d3cuZ2VvcGxhdGZvcm0uZ292L3NwZWMvZXNyaS1mZWF0dXJlLXJlc3RcIixcbiAgICBcImh0dHA6Ly93d3cuZ2VvcGxhdGZvcm0uZ292L3NwZWMvZXNyaS1pbWFnZS1yZXN0XCIsXG4gICAgXCJodHRwOi8vd3d3Lmdlb3BsYXRmb3JtLmdvdi9zcGVjL2VzcmktbWFwLXJlc3RcIixcbiAgICBcImh0dHA6Ly93d3cuZ2VvcGxhdGZvcm0uZ292L3NwZWMvZXNyaS10aWxlLXJlc3RcIlxuXTtcblxuXG5cblxuZnVuY3Rpb24gZm9ybWF0UmVmZXJlbmNlKCByZWYgOiBhbnkgKSA6IGFueSB7XG4gICAgaWYocmVmID09PSBudWxsKSByZXR1cm4gJyc7XG4gICAgaWYodHlwZW9mKHJlZikgPT09ICdzdHJpbmcnKVxuICAgICAgICByZXR1cm4gcmVmLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXFxzL2csJycpO1xuICAgIGVsc2UgaWYodHlwZW9mKHJlZikgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIHZhciByZXN1bHQgPSAnJztcbiAgICAgICAgZm9yKHZhciBwcm9wIGluIHJlZikge1xuICAgICAgICAgICAgaWYocmVmLmhhc093blByb3BlcnR5KHByb3ApKSB7XG4gICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gcmVmW3Byb3BdO1xuICAgICAgICAgICAgICAgIGlmKHZhbHVlICE9PSBudWxsICYmIHR5cGVvZih2YWx1ZSkgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vVE9ETyBjYXRjaCBub24tc3RyaW5nLWFibGUgdmFsdWVzXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPSAodmFsdWUrJycpLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXFxzL2csJycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICByZXR1cm4gJyc7XG59XG5cbi8qKlxuICogQWRqdXN0cyBzZXJ2aWNlIGFjY2VzcyB1cmwgdG8gaWdub3JlIGNlcnRhaW4gcGF0dGVybnMgdGhhdCBjYW4gYWZmZWN0XG4gKiBob3cgVVJJIHVuaXF1ZW5lc3MgaXMuXG4gKiBAcGFyYW0gc2VydmljZSAtIEdQIFNlcnZpY2UgaW5zdGFuY2VcbiAqIEByZXR1cm4gYWNjZXNzIHVybCBhZGp1c3RlZCBmb3IgVVJJIGdlbmVyYXRpb24gbmVlZHNcbiAqL1xuZnVuY3Rpb24gZml4U2VydmljZUhyZWYoc2VydmljZSA6IGFueSkgOiBzdHJpbmcge1xuICAgIHN0cmlwTGF5ZXJGcm9tU2VydmljZUhyZWYoc2VydmljZSk7XG4gICAgbGV0IHVybCA9IHNlcnZpY2UuYWNjZXNzVVJMIHx8IHNlcnZpY2UuaHJlZjtcbiAgICBpZighdXJsIHx8ICF1cmwubGVuZ3RoKSByZXR1cm4gbnVsbDtcblxuICAgIC8vZW5zdXJlIGNhc2Ugc2Vuc2l0aXZpdHkgaXMgbm90IGFuIGlzc3VlXG4gICAgLy8gYW5kIHRoYXQgYW55IHN1cnJvdW5kaW5nIHdoaXRlc3BhY2UgaXMgaWdub3JlZFxuICAgIHVybCA9ICh1cmwgKyAnJykudHJpbSgpLnRvTG93ZXJDYXNlKCk7XG5cbiAgICB1cmwgPSB1cmwucmVwbGFjZSgvaHR0cChzKT86XFwvXFwvLywnJyk7ICAgIC8vaWdub3JlIHByb3RvY29sIGZvciBVUkkgcHVycG9zZXNcblxuICAgIHVybCA9IHVybC5yZXBsYWNlKC8mP3JlcXVlc3Q9W0EtWmEtel0rL2ksJycpXG4gICAgICAgICAgICAgLnJlcGxhY2UoLyY/c2VydmljZT0oV01TfFdGU3xXQ1N8Q1NXKS9pLCcnKVxuICAgICAgICAgICAgIC5yZXBsYWNlKC8mP3ZlcnNpb249WzAtOVxcLl0qL2ksJycpXG4gICAgICAgICAgICAgLnJlcGxhY2UoLyY/bGF5ZXJzPVtBLVphLXowLTlcXC1cXDpfLF0qL2ksICcnKVxuICAgICAgICAgICAgIC5yZXBsYWNlKC8mP3Nycz1bQS1aYS16MC05XFw6XSovaSwgJycpXG4gICAgICAgICAgICAgLnJlcGxhY2UoLyY/Y3JzPVtBLVphLXowLTlcXDpdKi9pLCAnJylcbiAgICAgICAgICAgICAucmVwbGFjZSgvJj9mb3JtYXQ9W0EtWmEtelxcL10qL2ksICcnKVxuICAgICAgICAgICAgIC5yZXBsYWNlKC8mP2Jib3g9WzAtOSxcXC5dKi9pLCAnJyk7XG5cbiAgICBsZXQgbGFzdENoYXIgPSB1cmxbdXJsLmxlbmd0aC0xXTtcbiAgICBpZiggJy8nID09PSBsYXN0Q2hhciB8fCAnPycgPT09IGxhc3RDaGFyKSB7IC8vaWdub3JlIGVtcHR5IHF1ZXJ5c3RyaW5nIG9yIHRyYWlsaW5nIHNsYXNoZXNcbiAgICAgICAgdXJsID0gdXJsLnN1YnN0cmluZygwLCB1cmwubGVuZ3RoLTEpO1xuICAgIH1cbiAgICByZXR1cm4gdXJsO1xufVxuXG5cbi8qKlxuICogRVNSSSBzZXJ2aWNlcyBzb21ldGltZXMgaGF2ZSBsYXllciBpbmZvcm1hdGlvbiBiYWtlZCBpbnRvIHRoZWlyIFVSTFxuICogd2hpY2ggbmVlZHMgdG8gYmUgcmVtb3ZlZCBiZWZvcmUgdGhlIHNlcnZpY2UgY2FuIGJlIHVzZWQuXG4gKiBAcGFyYW0gc2VydmljZSAtIEdQIFNlcnZpY2Ugb2JqZWN0XG4gKi9cbmZ1bmN0aW9uIHN0cmlwTGF5ZXJGcm9tU2VydmljZUhyZWYoc2VydmljZSA6IGFueSkgOiBzdHJpbmcge1xuXG4gICAgaWYoIXNlcnZpY2UpIHJldHVybjtcbiAgICBsZXQgdHlwZSA9IHNlcnZpY2Uuc2VydmljZVR5cGUgfHwgc2VydmljZS5jb25mb3Jtc1RvO1xuICAgIGlmKCF0eXBlKSByZXR1cm47XG5cbiAgICAvL2lmIEVTUkkgc2VydmljZSwgbWFrZSBzdXJlIGl0IGRvZXNuJ3QgaGF2ZSBhIGxheWVyIGlkIG9uIHRoZSBocmVmXG4gICAgaWYoIEVTUklfVFlQRVMuaW5kZXhPZih0eXBlLnVyaSkgPj0gMCApIHtcblxuICAgICAgICBsZXQgaHJlZiA9IHNlcnZpY2UuaHJlZiB8fCBzZXJ2aWNlLmFjY2Vzc1VSTDtcbiAgICAgICAgbGV0IG1hdGNoZXMgPSBocmVmLm1hdGNoKC8oTWFwfEZlYXR1cmV8SW1hZ2UpKFNlcnZlclxcL1xcZCspL2kpO1xuICAgICAgICBpZihtYXRjaGVzICYmIG1hdGNoZXMubGVuZ3RoID4gMikge1xuICAgICAgICAgICAgLy8gMCA8IGZ1bGwgc3RyaW5nIG1hdGNoIChpZSwgJ01hcFNlcnZlci8xJylcbiAgICAgICAgICAgIC8vIDEgPCBzZXJ2ZXIgdHlwZSBtYXRjaCAoaWUsICdNYXAnIG9yICdGZWF0dXJlJylcbiAgICAgICAgICAgIC8vIDIgPCBiaXQgd2UgY2FyZSBhYm91dCAoaWUsICdTZXJ2ZXIvMScpXG4gICAgICAgICAgICBocmVmID0gaHJlZi5yZXBsYWNlKG1hdGNoZXNbMl0sICdTZXJ2ZXIvJyk7XG5cbiAgICAgICAgICAgIGlmKHNlcnZpY2UuaHJlZikgc2VydmljZS5ocmVmID0gaHJlZjtcbiAgICAgICAgICAgIGlmKHNlcnZpY2UuYWNjZXNzVVJMKSBzZXJ2aWNlLmFjY2Vzc1VSTCA9IGhyZWY7XG4gICAgICAgIH1cbiAgICB9XG59XG5cblxuXG5cbi8qKlxuICogQHNlZSBodHRwczovL2dlb3BsYXRmb3JtLmF0bGFzc2lhbi5uZXQvd2lraS9kaXNwbGF5L0RUL0NvbW1vbitPYmplY3QrSWRlbnRpZmllcitTY2hlbWVcbiAqL1xuY29uc3QgVVJJRmFjdG9yeSA9IHtcblxuICAgIGZhY3RvcmllcyA6IHt9LFxuXG4gICAgcmVnaXN0ZXIgOiBmdW5jdGlvbiAodHlwZSA6IHN0cmluZywgZmFjdG9yeSA6IEZ1bmN0aW9uKSB7XG4gICAgICAgIHRoaXMuZmFjdG9yaWVzW3R5cGVdID0gZmFjdG9yeTtcbiAgICB9LFxuXG4gICAgY3JlYXRlIDogZnVuY3Rpb24ob2JqZWN0IDogYW55LCBtZDVGbiA6IEZ1bmN0aW9uKSB7XG4gICAgICAgIGlmKCFvYmplY3QgfHwgIW9iamVjdC50eXBlKSByZXR1cm4gbnVsbDtcbiAgICAgICAgaWYoIHR5cGVvZihtZDVGbikgIT09ICdmdW5jdGlvbicgKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNdXN0IHNwZWNpZnkgYSBNRDUgZnVuY3Rpb24gd2hlbiB1c2luZyBVUklGYWN0b3J5XCIpO1xuICAgICAgICB9XG4gICAgICAgIGxldCBmYWN0b3J5ID0gdGhpcy5mYWN0b3JpZXNbb2JqZWN0LnR5cGVdO1xuICAgICAgICBpZighZmFjdG9yeSkgcmV0dXJuIG51bGw7XG4gICAgICAgIHJldHVybiBmYWN0b3J5KG9iamVjdCwgbWQ1Rm4pO1xuICAgIH1cbn07XG5cblxuXG5cblVSSUZhY3RvcnkucmVnaXN0ZXIoSXRlbVR5cGVzLkRBVEFTRVQsIGZ1bmN0aW9uKGRhdGFzZXQgOiBhbnksIG1kNSA6IEZ1bmN0aW9uKSB7XG4gICAgbGV0IHB1Yk5hbWUgPSAoZGF0YXNldC5wdWJsaXNoZXJ8fGRhdGFzZXQucHVibGlzaGVyc3x8W10pXG4gICAgICAgIC5tYXAoIHB1YiA9PiB7IHJldHVybiBwdWIubGFiZWx8fFwiXCI7IH0pLmpvaW4oJycpO1xuICAgIGxldCByZWYgOiBhbnkgPSBmb3JtYXRSZWZlcmVuY2Uoe1xuICAgICAgICB0aXRsZTogZGF0YXNldC50aXRsZSxcbiAgICAgICAgcHViOiBwdWJOYW1lXG4gICAgfSk7XG4gICAgcmV0dXJuIFVSSV9CQVNFICsgJy9pZC9kYXRhc2V0LycgKyBtZDUocmVmKTtcbn0pO1xuXG5VUklGYWN0b3J5LnJlZ2lzdGVyKEl0ZW1UeXBlcy5TRVJWSUNFLCBmdW5jdGlvbihzZXJ2aWNlIDogYW55LCBtZDUgOiBGdW5jdGlvbikge1xuICAgIGxldCB1cmwgPSBmaXhTZXJ2aWNlSHJlZihzZXJ2aWNlKTtcbiAgICBsZXQgcmVmID0gZm9ybWF0UmVmZXJlbmNlKHVybCk7XG4gICAgcmV0dXJuIFVSSV9CQVNFICsgJy9pZC9zZXJ2aWNlLycgKyBtZDUocmVmKTtcbn0pO1xuXG5VUklGYWN0b3J5LnJlZ2lzdGVyKEl0ZW1UeXBlcy5MQVlFUiwgZnVuY3Rpb24obGF5ZXIgOiBhbnksIG1kNSA6IEZ1bmN0aW9uKSB7XG5cbiAgICBsZXQgc3ZjVXJsID0gJyc7XG4gICAgbGV0IHNlcnZpY2VzID0gbGF5ZXIuc2VydmljZWRCeSB8fCBsYXllci5zZXJ2aWNlcztcbiAgICBpZihzZXJ2aWNlcyAmJiBzZXJ2aWNlcy5sZW5ndGgpXG4gICAgICAgIHN2Y1VybCA9IHNlcnZpY2VzWzBdLmFjY2Vzc1VSTCB8fCBzZXJ2aWNlc1swXS5ocmVmIHx8ICcnO1xuICAgIGxldCBseXJVcmwgPSBsYXllci5hY2Nlc3NVUkwgfHwgbGF5ZXIuaHJlZiB8fCAnJztcbiAgICBsZXQgbHlyTmFtZSA9IGxheWVyLmxheWVyTmFtZSB8fCAnJztcblxuICAgIC8vbm90IHJlY29tbWVuZGVkIGJhc2VkIHVwb24gZm9sbG93aW5nIGV4YW1wbGU6XG4gICAgLy8gIGh0dHA6Ly9zZXJ2aWNlcy5uYXRpb25hbG1hcC5nb3YvLi4uL01hcFNlcnZlci9XTVNTZXJ2ZXI/cmVxdWVzdD1HZXRDYXBhYmlsaXRpZXMmc2VydmljZT1XTVMvbGF5ZXIvMVxuICAgIC8vIHJldHVybiB1cmwgKyAnL2xheWVyLycgKyBsYXllci5sYXllck5hbWU7XG5cbiAgICBsZXQgYXJncyA9IHN2Y1VybCArIGx5ck5hbWUgKyBseXJVcmw7XG4gICAgaWYoIWFyZ3MubGVuZ3RoKSByZXR1cm4gbnVsbDsgICAvL25vdGhpbmcgd2FzIHByb3ZpZGVkXG5cbiAgICAvL0FMVEVSTkFURSBVUkkgUEFUVEVSTlxuICAgIGxldCByZWYgPSBmb3JtYXRSZWZlcmVuY2UoYXJncyk7XG4gICAgcmV0dXJuIFVSSV9CQVNFICsgJy9pZC9sYXllci8nICsgbWQ1KHJlZik7XG5cbn0pO1xuXG4vKipcbiAqIFVzZXMgdGhlIG1hcCB0aXRsZSwgY3JlYXRlZEJ5LCBhbmQgYWxsIHRoaXJkLXBhcnR5IGlkZW50aWZpZXJzIGFzc29jaWF0ZWQgd2l0aCB0aGUgbWFwXG4gKiBAcGFyYW0ge29iamVjdH0gbWFwIC0gR1AgTWFwIG9iamVjdFxuICogQHJldHVybiB7c3RyaW5nfSB1cmkgdW5pcXVlIHRvIHRoaXMgb2JqZWN0XG4gKi9cblVSSUZhY3RvcnkucmVnaXN0ZXIoSXRlbVR5cGVzLk1BUCwgZnVuY3Rpb24obWFwIDogYW55LCBtZDUgOiBGdW5jdGlvbikge1xuICAgIGxldCBhdXRob3IgPSBtYXAuY3JlYXRlZEJ5IHx8IG1hcC5fY3JlYXRlZEJ5IHx8IFwiXCI7XG4gICAgbGV0IGlkZW50aWZpZXJzID0gKG1hcC5pZGVudGlmaWVycyB8fCBtYXAuaWRlbnRpZmllciB8fCBbXSkuam9pbignJyk7XG4gICAgbGV0IHJlZiA9IGZvcm1hdFJlZmVyZW5jZSh7dGl0bGU6IG1hcC50aXRsZSwgYXV0aG9yOiBhdXRob3IsIGlkZW50aWZpZXJzOiBpZGVudGlmaWVyc30pO1xuICAgIHJldHVybiBVUklfQkFTRSArICcvaWQvbWFwLycgKyBtZDUocmVmKTtcbn0pO1xuXG5VUklGYWN0b3J5LnJlZ2lzdGVyKEl0ZW1UeXBlcy5HQUxMRVJZLCBmdW5jdGlvbihnYWxsZXJ5IDogYW55LCBtZDUgOiBGdW5jdGlvbikge1xuICAgIGxldCBhdXRob3IgPSBnYWxsZXJ5LmNyZWF0ZWRCeSB8fCBnYWxsZXJ5Ll9jcmVhdGVkQnkgfHwgXCJcIjtcbiAgICBsZXQgcmVmID0gZm9ybWF0UmVmZXJlbmNlKHt0aXRsZTogZ2FsbGVyeS50aXRsZSwgYXV0aG9yOiBhdXRob3J9KTtcbiAgICByZXR1cm4gVVJJX0JBU0UgKyAnL2lkL2dhbGxlcnkvJyArIG1kNShyZWYpO1xufSk7XG5cblVSSUZhY3RvcnkucmVnaXN0ZXIoSXRlbVR5cGVzLkNPTU1VTklUWSwgZnVuY3Rpb24oY29tbXVuaXR5IDogYW55LCBtZDUgOiBGdW5jdGlvbikge1xuICAgIGxldCByZWYgPSBmb3JtYXRSZWZlcmVuY2Uoe3RpdGxlOiBjb21tdW5pdHkudGl0bGV9KTtcbiAgICByZXR1cm4gVVJJX0JBU0UgKyAnL2lkL2NvbW11bml0eS8nICsgbWQ1KHJlZik7XG59KTtcblxuVVJJRmFjdG9yeS5yZWdpc3RlcihJdGVtVHlwZXMuT1JHQU5JWkFUSU9OLCBmdW5jdGlvbihvcmcgOiBhbnksIG1kNSA6IEZ1bmN0aW9uKSB7XG4gICAgbGV0IHJlZiA9IGZvcm1hdFJlZmVyZW5jZShvcmcubGFiZWwgfHwgb3JnLm5hbWUpO1xuICAgIHJldHVybiBVUklfQkFTRSArICcvaWQvb3JnYW5pemF0aW9uLycgKyBtZDUocmVmKTtcbn0pO1xuXG5VUklGYWN0b3J5LnJlZ2lzdGVyKEl0ZW1UeXBlcy5QRVJTT04sIGZ1bmN0aW9uKHBlcnNvbiA6IGFueSwgbWQ1IDogRnVuY3Rpb24pIHtcbiAgICBsZXQgcmVmID0gZm9ybWF0UmVmZXJlbmNlKHBlcnNvbi5uYW1lKTtcbiAgICByZXR1cm4gVVJJX0JBU0UgKyAnL2lkL3BlcnNvbi8nICsgbWQ1KHJlZik7XG59KTtcblxuVVJJRmFjdG9yeS5yZWdpc3RlcihJdGVtVHlwZXMuQ09OVEFDVCwgZnVuY3Rpb24odmNhcmQgOiBhbnksIG1kNSA6IEZ1bmN0aW9uKSB7XG4gICAgbGV0IHJlZiA6IGFueSA9IHt9O1xuICAgIGlmKHZjYXJkLmVtYWlsIHx8IHZjYXJkLmhhc0VtYWlsKVxuICAgICAgICByZWYuZW1haWwgPSB2Y2FyZC5lbWFpbCB8fCB2Y2FyZC5oYXNFbWFpbDsgLy9lbWFpbFxuICAgIGlmKHZjYXJkLnRlbClcbiAgICAgICAgcmVmLnRlbCA9IHZjYXJkLnRlbDsgLy90ZWxcbiAgICBpZih2Y2FyZC5vcmdOYW1lIHx8IHZjYXJkWydvcmdhbml6YXRpb24tbmFtZSddKVxuICAgICAgICByZWYub3JnTmFtZSA9IHZjYXJkLm9yZ05hbWUgfHwgdmNhcmRbJ29yZ2FuaXphdGlvbi1uYW1lJ107IC8vb3JnTmFtZVxuICAgIGlmKHZjYXJkLnBvc2l0aW9uVGl0bGUpXG4gICAgICAgIHJlZi5wb3NpdGlvblRpdGxlID0gdmNhcmQucG9zaXRpb25UaXRsZTsgLy9wb3NpdGlvblRpdGxlXG4gICAgcmVmID0gZm9ybWF0UmVmZXJlbmNlKHJlZik7XG4gICAgcmV0dXJuIFVSSV9CQVNFICsgJy9pZC9jb250YWN0LycgKyBtZDUocmVmKTtcbn0pO1xuXG5VUklGYWN0b3J5LnJlZ2lzdGVyKEl0ZW1UeXBlcy5DT05DRVBULCBmdW5jdGlvbihvYmplY3QgOiBhbnksIG1kNSA6IEZ1bmN0aW9uKSB7XG4gICAgbGV0IHNjaGVtZSA9IG9iamVjdC5pblNjaGVtZSB8fCBvYmplY3Quc2NoZW1lO1xuICAgIGxldCBzY2hlbWVMYWJlbCA9IHNjaGVtZSA/IChzY2hlbWUubGFiZWwgfHwgc2NoZW1lLnByZWZMYWJlbCkgOiAnJztcbiAgICBsZXQgc2NoZW1lUmVmID0gZm9ybWF0UmVmZXJlbmNlKHNjaGVtZUxhYmVsKTtcbiAgICBsZXQgcmVmID0gZm9ybWF0UmVmZXJlbmNlKCBvYmplY3QubGFiZWwgfHwgb2JqZWN0LnByZWZMYWJlbCApO1xuICAgIHJldHVybiBVUklfQkFTRSArICcvaWQvbWV0YWRhdGEtY29kZWxpc3RzLycgKyBtZDUoc2NoZW1lUmVmKSArICcvJyArIG1kNShyZWYpO1xufSk7XG5cblVSSUZhY3RvcnkucmVnaXN0ZXIoSXRlbVR5cGVzLkNPTkNFUFRfU0NIRU1FLCBmdW5jdGlvbihvYmplY3QgOiBhbnksIG1kNSA6IEZ1bmN0aW9uKSB7XG4gICAgbGV0IHJlZiA9IGZvcm1hdFJlZmVyZW5jZShvYmplY3QubGFiZWwgfHwgb2JqZWN0LnByZWZMYWJlbCk7XG4gICAgcmV0dXJuIFVSSV9CQVNFICsgJy9pZC9tZXRhZGF0YS1jb2RlbGlzdHMvJyArIG1kNShyZWYpO1xufSk7XG5cblVSSUZhY3RvcnkucmVnaXN0ZXIoSXRlbVR5cGVzLkFQUExJQ0FUSU9OLCBmdW5jdGlvbihvYmplY3QgOiBhbnksIG1kNSA6IEZ1bmN0aW9uKSB7XG4gICAgaWYoIW9iamVjdCB8fCAhb2JqZWN0LnRpdGxlKSByZXR1cm4gbnVsbDtcbiAgICBsZXQgYXV0aG9yID0gb2JqZWN0LmNyZWF0ZWRCeSB8fCBvYmplY3QuX2NyZWF0ZWRCeSB8fCBcIlwiO1xuICAgIGxldCByZWYgPSBmb3JtYXRSZWZlcmVuY2Uoe3RpdGxlOiBvYmplY3QudGl0bGUsIGF1dGhvcjogYXV0aG9yfSk7XG4gICAgcmV0dXJuIFVSSV9CQVNFICsgJy9pZC9hcHBsaWNhdGlvbi8nICsgbWQ1KHJlZik7XG59KTtcblxuVVJJRmFjdG9yeS5yZWdpc3RlcihJdGVtVHlwZXMuVE9QSUMsIGZ1bmN0aW9uKG9iamVjdCA6IGFueSwgbWQ1IDogRnVuY3Rpb24pIHtcbiAgICBpZighb2JqZWN0IHx8ICFvYmplY3QudGl0bGUpIHJldHVybiBudWxsO1xuICAgIGxldCBhdXRob3IgPSBvYmplY3QuY3JlYXRlZEJ5IHx8IG9iamVjdC5fY3JlYXRlZEJ5IHx8IFwiXCI7XG4gICAgbGV0IHJlZiA9IGZvcm1hdFJlZmVyZW5jZSh7dGl0bGU6IG9iamVjdC50aXRsZSwgYXV0aG9yOiBhdXRob3J9KTtcbiAgICByZXR1cm4gVVJJX0JBU0UgKyAnL2lkL3RvcGljLycgKyBtZDUocmVmKTtcbn0pO1xuXG5VUklGYWN0b3J5LnJlZ2lzdGVyKEl0ZW1UeXBlcy5XRUJTSVRFLCBmdW5jdGlvbihpdGVtIDogYW55LCBtZDUgOiBGdW5jdGlvbikge1xuICAgIGlmKCFpdGVtIHx8ICFpdGVtLmxhbmRpbmdQYWdlKSByZXR1cm4gbnVsbDtcbiAgICBsZXQgcmVmID0gZm9ybWF0UmVmZXJlbmNlKGl0ZW0ubGFuZGluZ1BhZ2UpO1xuICAgIHJldHVybiBVUklfQkFTRSArICcvaWQvd2Vic2l0ZS8nICsgbWQ1KHJlZik7XG59KTtcblxuXG5cbmZ1bmN0aW9uIGZhY3RvcnlGbihtZDVGbikge1xuICAgIGlmKCB0eXBlb2YobWQ1Rm4pICE9PSAnZnVuY3Rpb24nICkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNdXN0IHNwZWNpZnkgYSBNRDUgZnVuY3Rpb24gd2hlbiB1c2luZyBVUklGYWN0b3J5XCIpO1xuICAgIH1cbiAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7XG4gICAgICAgIHJldHVybiBVUklGYWN0b3J5LmNyZWF0ZShvYmplY3QsIG1kNUZuKTtcbiAgICB9O1xufVxuXG5cblxuZXhwb3J0IHtcbiAgICBmYWN0b3J5Rm4gYXMgZGVmYXVsdCxcbiAgICBmYWN0b3J5Rm4gYXMgVVJJRmFjdG9yeVxufTtcbiJdfQ==