import request from 'request';
import { Config, ItemService } from '@geoplatform/client';
import NodeHttpClient from '../../http/node';
var GP_AUTH_COOKIE = 'gpoauth-a';
var ɵ0 = function (router, routes, options) {
    var _this = this;
    options = options || {};
    var paths = options.paths || {};
    var auths = options.auth || {};
    routes.forEach(function (route) {
        if (paths[route.key] === false)
            return; //disabled endpoint
        if (!paths[route.key] && !route.path)
            return; //something is wrong with route
        //newer route override...
        // {
        //   'create': {
        //     'path': 'custom/path',
        //     'auth': true,
        //     'onResponse': function(result, res, next) { }
        //   }
        // }
        var overrides = options[route.key] || {};
        //look for overriden paths in either new override structure or older key:path format
        var path = '/' + (overrides.path || paths[route.key] || route.path);
        //look for authentication override in either new structure or older format
        var needsAuth = overrides.auth || auths[route.key] || route.auth;
        if (options.logger) {
            options.logger.debug("Binding Service Route [" + route.method + "] " + path);
        }
        router[route.method](path, function (req, res, next) {
            var promise = null;
            if (typeof (route.onExecute) !== 'function') {
                promise = Promise.resolve(null);
            }
            else {
                if (options.logger) {
                    options.logger.debug("Executing Service Route [" + route.method + "] " + path);
                    options.logger.debug(JSON.stringify(req.params));
                    options.logger.debug("-------------------------");
                }
                var svc = _this.getService(req, needsAuth, options);
                try {
                    promise = route.onExecute(svc, req);
                }
                catch (e) {
                    promise = Promise.reject(e);
                }
            }
            promise.then(function (result) {
                var onResponse = overrides.onResponse || route.onResponse;
                if (onResponse)
                    onResponse(result, res, next);
                else
                    res.json(result);
            })
                .catch(function (err) {
                if (overrides.onError)
                    overrides.onError(err);
                if (options.onError)
                    options.onError(route.key, err);
                next(err);
            })
                .finally(function () {
                //if route has a finish function defined, invoke it
                if (overrides.onFinish) {
                    overrides.onFinish(req, res);
                }
                //if proxy has an overall finish function defined, invoke it
                var finishFn = options.onFinish;
                if (finishFn)
                    finishFn(route.key, req, res);
            });
        });
    });
    if (options && options.addl) {
        this.bindAdditionalRoutes(router, options);
    }
}, ɵ1 = function (router, options) {
    var _this = this;
    //fetch thumbnail proxy
    router.get('/items/:id/thumbnail', function (req, res, next) {
        var url = Config.ualUrl + '/api/items/' + req.params.id + '/thumbnail';
        request.get(url).pipe(res);
    });
    if (options && options.logger) {
        options.logger.debug("Binding Service Route [get] /items/:id/thumbnail");
    }
    //request new thumbnail be created
    router.post('/items/:id/thumbnail', function (req, res, next) {
        var url = Config.ualUrl + '/api/items/' + req.params.id + '/thumbnail';
        var token = _this.getAuthToken(req);
        var cookie = _this.getAuthCookie(req);
        var opts = {}; //doesn't need a body when posting to thumbnail
        if (token)
            opts.auth = { bearer: token };
        if (cookie)
            opts.headers = { Cookie: _this.authCookieName + '=' + cookie };
        request.post(url, opts).pipe(res);
    });
    if (options && options.logger) {
        options.logger.debug("Binding Service Route [post] /items/:id/thumbnail");
    }
}, ɵ2 = function (req, needsAuth, options) {
    var token = this.getAuthToken(req);
    if (needsAuth) {
        if (options && options.logger) {
            // options.logger.debug(`ServiceProxy.getClient() - Token: ${token}`);
            // options.logger.debug(`ServiceProxy.getClient() - JWT: ${req.jwt}`);
            if (!token) {
                options.logger.warn("ServiceProxy.getClient() - No Access Token was provided on incoming request header!");
            }
            else if (!!options.debug) {
                options.logger.debug("ServiceProxy.getClient() - Token: " + token);
                options.logger.debug("ServiceProxy.getClient() - JWT: " + req.jwt);
            }
        }
        else if (!token) {
            console.log("[WARN] No Access Token provided on incoming request header");
        }
    }
    //check the incoming proxied request for cookies that should be forwarded along
    var cookie = this.getAuthCookie(req);
    // console.log("COOKIE IS " + cookie);
    if (cookie && !cookie.length)
        cookie = null;
    // if(options && options.logger) {
    //     options.logger.debug("Proxying Request Cookie: " + cookie);
    //     options.logger.debug(" ");
    // } else {
    //     console.log("Proxying Request Cookie: " + cookie);
    // }
    return new NodeHttpClient({
        timeout: Config.timeout,
        token: needsAuth ? token : null,
        cookie: needsAuth ? cookie : null
    });
}, ɵ3 = function (req, needsAuth, options) {
    var client = this.getClient(req, needsAuth, options);
    var svcClass = options.serviceClass || ItemService;
    // console.log("Proxying to " + Config.ualUrl);
    if (options.logger) {
        options.logger.debug("Proxying to " + Config.ualUrl);
        // options.logger.debug("Using service class: " + svcClass);
    }
    var service = new svcClass(Config.ualUrl, client);
    service.setTimeout(Config.timeout || 30000);
    if (options.logger) {
        service.setLogger(options.logger);
    }
    return service;
}, ɵ4 = function (req) {
    var token = req.accessToken || null;
    if (!token && !req.jwt) { //if not processed by middleware...
        token = (req.headers.authorization || '').replace('Bearer ', '');
    }
    return token;
}, ɵ5 = function (req) {
    if (!req)
        return null;
    if (req.cookies) { //parsed by cookieParser already
        // console.log("COOKIES PARSED ... ");
        // console.log("COOKIES ARE...");
        // console.log(JSON.stringify(req.cookies));
        // console.log(" ");
        // console.log("AUTH COOKIE IS " + req.cookies[GP_AUTH_COOKIE]);
        return req.cookies[GP_AUTH_COOKIE];
    }
    else if (req.headers.cookie) {
        // console.log("COOKIES NEED PARSING");
        try {
            var cookies = this.parseCookies(req.headers.cookie);
            return cookies[GP_AUTH_COOKIE];
        }
        catch (e) {
            console.log("ERROR parsing cookies: " + e.message);
            return null;
        }
    }
}, ɵ6 = function parse(str) {
    if (!str || typeof str !== 'string' || !str.length)
        return null;
    var result = {};
    var expr = /; */;
    var pairs = str.split(expr);
    pairs.forEach(function (pair) {
        var sepIdx = pair.indexOf('=');
        if (sepIdx < 0)
            return; //ignore non- 'key=value' values
        var key = pair.substr(0, sepIdx).trim();
        var val = pair.substr(++sepIdx, pair.length).trim();
        // quoted values
        if ('"' == val[0])
            val = val.slice(1, -1);
        // only assign once
        if (undefined == result[key]) {
            var value = val;
            try {
                value = decodeURIComponent(val);
            }
            catch (e) { }
            result[key] = value;
        }
    });
    return result;
};
var ServiceProxy = {
    /**
     * @param {Router} router - ExpressJS router instance
     * @param {array[object]} routes - list of routes to map to the router
     * @param {object} options - additional configuration needed
     */
    bindRoutes: ɵ0,
    /**
     *
     */
    bindAdditionalRoutes: ɵ1,
    /**
    * @param {HttpRequest} req - incoming http request being proxied
    * @param {boolean} needsAuth - flag indicating if the request must provide an authentication token
    * @param {object} options - additional configuration options
    * @return {HttpClient} client to use to make requests to GeoPlatform API endpoint
    */
    getClient: ɵ2,
    /**
     * @param {HttpRequest} req - incoming http request being proxied
     * @param {boolean} needsAuth - flag indicating if request requires authorization token
     * @param {object} options - additional configuration options
     */
    getService: ɵ3,
    /**
     * @return JWT authorization bearer token
     */
    getAuthToken: ɵ4,
    /**
     * @return GP Authentication cookie
     */
    getAuthCookie: ɵ5,
    parseCookies: ɵ6
};
export default ServiceProxy;
export { ɵ0, ɵ1, ɵ2, ɵ3, ɵ4, ɵ5, ɵ6 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BnZW9wbGF0Zm9ybS9jbGllbnQvbm9kZS8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL3Byb3hpZXMvYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLE9BQU8sTUFBc0IsU0FBUyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDMUQsT0FBTyxjQUFjLE1BQWUsaUJBQWlCLENBQUM7QUFFdEQsSUFBTSxjQUFjLEdBQUcsV0FBVyxDQUFDO1NBU25CLFVBQVMsTUFBWSxFQUFFLE1BQWMsRUFBRSxPQUFjO0lBQXJELGlCQTZFWDtJQTNFRyxPQUFPLEdBQUcsT0FBTyxJQUFJLEVBQUUsQ0FBQztJQUN4QixJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztJQUNoQyxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUUvQixNQUFNLENBQUMsT0FBTyxDQUFFLFVBQUEsS0FBSztRQUVqQixJQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssS0FBSztZQUFFLE9BQU8sQ0FBRSxtQkFBbUI7UUFDM0QsSUFBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSTtZQUFFLE9BQU8sQ0FBQywrQkFBK0I7UUFFNUUseUJBQXlCO1FBQ3pCLElBQUk7UUFDSixnQkFBZ0I7UUFDaEIsNkJBQTZCO1FBQzdCLG9CQUFvQjtRQUNwQixvREFBb0Q7UUFDcEQsTUFBTTtRQUNOLElBQUk7UUFDSixJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUV6QyxvRkFBb0Y7UUFDcEYsSUFBSSxJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUUsU0FBUyxDQUFDLElBQUks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S0U7SUFDRixTQUFTLElBc0NSO0lBR0Q7Ozs7T0FJRztJQUNILFVBQVUsSUFjVDtJQUVEOztPQUVHO0lBQ0gsWUFBWSxJQU1YO0lBRUQ7O09BRUc7SUFDSCxhQUFhLElBb0JaO0lBRUQsWUFBWSxJQTZCWDtDQUtKLENBQUM7QUFFRixlQUFlLFlBQVksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHJlcXVlc3QgICAgICAgICAgICAgICAgIGZyb20gJ3JlcXVlc3QnO1xuaW1wb3J0IHsgQ29uZmlnLCBJdGVtU2VydmljZSB9IGZyb20gJ0BnZW9wbGF0Zm9ybS9jbGllbnQnO1xuaW1wb3J0IE5vZGVIdHRwQ2xpZW50ICAgICAgICAgIGZyb20gJy4uLy4uL2h0dHAvbm9kZSc7XG5cbmNvbnN0IEdQX0FVVEhfQ09PS0lFID0gJ2dwb2F1dGgtYSc7XG5cbmNvbnN0IFNlcnZpY2VQcm94eSA9IHtcblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7Um91dGVyfSByb3V0ZXIgLSBFeHByZXNzSlMgcm91dGVyIGluc3RhbmNlXG4gICAgICogQHBhcmFtIHthcnJheVtvYmplY3RdfSByb3V0ZXMgLSBsaXN0IG9mIHJvdXRlcyB0byBtYXAgdG8gdGhlIHJvdXRlclxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIC0gYWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG5lZWRlZFxuICAgICAqL1xuICAgIGJpbmRSb3V0ZXM6IGZ1bmN0aW9uKHJvdXRlciA6IGFueSwgcm91dGVzIDogYW55W10sIG9wdGlvbnMgPzogYW55KSB7XG5cbiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgICAgIGxldCBwYXRocyA9IG9wdGlvbnMucGF0aHMgfHwge307XG4gICAgICAgIGxldCBhdXRocyA9IG9wdGlvbnMuYXV0aCB8fCB7fTtcblxuICAgICAgICByb3V0ZXMuZm9yRWFjaCggcm91dGUgPT4ge1xuXG4gICAgICAgICAgICBpZihwYXRoc1tyb3V0ZS5rZXldID09PSBmYWxzZSkgcmV0dXJuOyAgLy9kaXNhYmxlZCBlbmRwb2ludFxuICAgICAgICAgICAgaWYoIXBhdGhzW3JvdXRlLmtleV0gJiYgIXJvdXRlLnBhdGgpIHJldHVybjsgLy9zb21ldGhpbmcgaXMgd3Jvbmcgd2l0aCByb3V0ZVxuXG4gICAgICAgICAgICAvL25ld2VyIHJvdXRlIG92ZXJyaWRlLi4uXG4gICAgICAgICAgICAvLyB7XG4gICAgICAgICAgICAvLyAgICdjcmVhdGUnOiB7XG4gICAgICAgICAgICAvLyAgICAgJ3BhdGgnOiAnY3VzdG9tL3BhdGgnLFxuICAgICAgICAgICAgLy8gICAgICdhdXRoJzogdHJ1ZSxcbiAgICAgICAgICAgIC8vICAgICAnb25SZXNwb25zZSc6IGZ1bmN0aW9uKHJlc3VsdCwgcmVzLCBuZXh0KSB7IH1cbiAgICAgICAgICAgIC8vICAgfVxuICAgICAgICAgICAgLy8gfVxuICAgICAgICAgICAgbGV0IG92ZXJyaWRlcyA9IG9wdGlvbnNbcm91dGUua2V5XSB8fCB7fTtcblxuICAgICAgICAgICAgLy9sb29rIGZvciBvdmVycmlkZW4gcGF0aHMgaW4gZWl0aGVyIG5ldyBvdmVycmlkZSBzdHJ1Y3R1cmUgb3Igb2xkZXIga2V5OnBhdGggZm9ybWF0XG4gICAgICAgICAgICBsZXQgcGF0aCA9ICcvJyArICggb3ZlcnJpZGVzLnBhdGggfHwgcGF0aHNbcm91dGUua2V5XSB8fCByb3V0ZS5wYXRoICk7XG4gICAgICAgICAgICAvL2xvb2sgZm9yIGF1dGhlbnRpY2F0aW9uIG92ZXJyaWRlIGluIGVpdGhlciBuZXcgc3RydWN0dXJlIG9yIG9sZGVyIGZvcm1hdFxuICAgICAgICAgICAgbGV0IG5lZWRzQXV0aCA9IG92ZXJyaWRlcy5hdXRoIHx8IGF1dGhzW3JvdXRlLmtleV0gfHwgcm91dGUuYXV0aDtcblxuICAgICAgICAgICAgaWYob3B0aW9ucy5sb2dnZXIpIHtcbiAgICAgICAgICAgICAgICBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhgQmluZGluZyBTZXJ2aWNlIFJvdXRlIFske3JvdXRlLm1ldGhvZH1dICR7cGF0aH1gKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcm91dGVyW3JvdXRlLm1ldGhvZF0oIHBhdGgsIChyZXEgOiBhbnksIHJlcyA6IGFueSwgbmV4dCA6IEZ1bmN0aW9uKSA9PiB7XG5cbiAgICAgICAgICAgICAgICBsZXQgcHJvbWlzZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgaWYodHlwZW9mKHJvdXRlLm9uRXhlY3V0ZSkgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSggbnVsbCApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMubG9nZ2VyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhgRXhlY3V0aW5nIFNlcnZpY2UgUm91dGUgWyR7cm91dGUubWV0aG9kfV0gJHtwYXRofWApXG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhKU09OLnN0cmluZ2lmeShyZXEucGFyYW1zKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhcIi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgbGV0IHN2YyA9IHRoaXMuZ2V0U2VydmljZShyZXEsIG5lZWRzQXV0aCwgb3B0aW9ucyk7XG5cbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSByb3V0ZS5vbkV4ZWN1dGUoc3ZjLCByZXEpO1xuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKCBlICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IFByb21pc2UucmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKCAoIHJlc3VsdCA6IGFueSApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9uUmVzcG9uc2UgPSBvdmVycmlkZXMub25SZXNwb25zZSB8fCByb3V0ZS5vblJlc3BvbnNlO1xuICAgICAgICAgICAgICAgICAgICBpZihvblJlc3BvbnNlKSBvblJlc3BvbnNlKHJlc3VsdCwgcmVzLCBuZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSByZXMuanNvbihyZXN1bHQpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKCAoZXJyIDogRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYob3ZlcnJpZGVzLm9uRXJyb3IpIG92ZXJyaWRlcy5vbkVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMub25FcnJvcikgb3B0aW9ucy5vbkVycm9yKHJvdXRlLmtleSwgZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgbmV4dChlcnIpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmZpbmFsbHkoICgpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAvL2lmIHJvdXRlIGhhcyBhIGZpbmlzaCBmdW5jdGlvbiBkZWZpbmVkLCBpbnZva2UgaXRcbiAgICAgICAgICAgICAgICAgICAgaWYob3ZlcnJpZGVzLm9uRmluaXNoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvdmVycmlkZXMub25GaW5pc2gocmVxLCByZXMpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy9pZiBwcm94eSBoYXMgYW4gb3ZlcmFsbCBmaW5pc2ggZnVuY3Rpb24gZGVmaW5lZCwgaW52b2tlIGl0XG4gICAgICAgICAgICAgICAgICAgIGxldCBmaW5pc2hGbiA9IG9wdGlvbnMub25GaW5pc2g7XG4gICAgICAgICAgICAgICAgICAgIGlmKGZpbmlzaEZuKSBmaW5pc2hGbihyb3V0ZS5rZXksIHJlcSwgcmVzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmKG9wdGlvbnMgJiYgb3B0aW9ucy5hZGRsKSB7XG4gICAgICAgICAgICB0aGlzLmJpbmRBZGRpdGlvbmFsUm91dGVzKHJvdXRlciwgb3B0aW9ucyk7XG4gICAgICAgIH1cblxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIGJpbmRBZGRpdGlvbmFsUm91dGVzOiBmdW5jdGlvbiggcm91dGVyIDogYW55LCBvcHRpb25zID86IGFueSApIHtcblxuICAgICAgICAvL2ZldGNoIHRodW1ibmFpbCBwcm94eVxuICAgICAgICByb3V0ZXIuZ2V0KCcvaXRlbXMvOmlkL3RodW1ibmFpbCcsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICAgICAgbGV0IHVybCA9IENvbmZpZy51YWxVcmwgKyAnL2FwaS9pdGVtcy8nICsgcmVxLnBhcmFtcy5pZCArICcvdGh1bWJuYWlsJztcbiAgICAgICAgICAgIHJlcXVlc3QuZ2V0KHVybCkucGlwZShyZXMpO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYob3B0aW9ucyAmJiBvcHRpb25zLmxvZ2dlcikge1xuICAgICAgICAgICAgb3B0aW9ucy5sb2dnZXIuZGVidWcoXCJCaW5kaW5nIFNlcnZpY2UgUm91dGUgW2dldF0gL2l0ZW1zLzppZC90aHVtYm5haWxcIik7XG4gICAgICAgIH1cblxuICAgICAgICAvL3JlcXVlc3QgbmV3IHRodW1ibmFpbCBiZSBjcmVhdGVkXG4gICAgICAgIHJvdXRlci5wb3N0KCcvaXRlbXMvOmlkL3RodW1ibmFpbCcsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICAgICAgbGV0IHVybCA9IENvbmZpZy51YWxVcmwgKyAnL2FwaS9pdGVtcy8nICsgcmVxLnBhcmFtcy5pZCArICcvdGh1bWJuYWlsJztcbiAgICAgICAgICAgIGxldCB0b2tlbiA9IHRoaXMuZ2V0QXV0aFRva2VuKHJlcSk7XG4gICAgICAgICAgICBsZXQgY29va2llID0gdGhpcy5nZXRBdXRoQ29va2llKHJlcSk7XG4gICAgICAgICAgICBsZXQgb3B0cyA6IGFueSA9IHt9OyAgLy9kb2Vzbid0IG5lZWQgYSBib2R5IHdoZW4gcG9zdGluZyB0byB0aHVtYm5haWxcbiAgICAgICAgICAgIGlmKHRva2VuKSAgb3B0cy5hdXRoID0geyBiZWFyZXIgOiB0b2tlbiB9O1xuICAgICAgICAgICAgaWYoY29va2llKSBvcHRzLmhlYWRlcnMgPSB7IENvb2tpZSA6IHRoaXMuYXV0aENvb2tpZU5hbWUgKyAnPScgKyBjb29raWUgfTtcbiAgICAgICAgICAgIHJlcXVlc3QucG9zdCh1cmwsIG9wdHMpLnBpcGUocmVzKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmKG9wdGlvbnMgJiYgb3B0aW9ucy5sb2dnZXIpIHtcbiAgICAgICAgICAgIG9wdGlvbnMubG9nZ2VyLmRlYnVnKFwiQmluZGluZyBTZXJ2aWNlIFJvdXRlIFtwb3N0XSAvaXRlbXMvOmlkL3RodW1ibmFpbFwiKTtcbiAgICAgICAgfVxuXG4gICAgfSxcblxuICAgIC8qKlxuICAgICogQHBhcmFtIHtIdHRwUmVxdWVzdH0gcmVxIC0gaW5jb21pbmcgaHR0cCByZXF1ZXN0IGJlaW5nIHByb3hpZWRcbiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbmVlZHNBdXRoIC0gZmxhZyBpbmRpY2F0aW5nIGlmIHRoZSByZXF1ZXN0IG11c3QgcHJvdmlkZSBhbiBhdXRoZW50aWNhdGlvbiB0b2tlblxuICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgLSBhZGRpdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9uc1xuICAgICogQHJldHVybiB7SHR0cENsaWVudH0gY2xpZW50IHRvIHVzZSB0byBtYWtlIHJlcXVlc3RzIHRvIEdlb1BsYXRmb3JtIEFQSSBlbmRwb2ludFxuICAgICovXG4gICAgZ2V0Q2xpZW50OiBmdW5jdGlvbihyZXEgOiBhbnksIG5lZWRzQXV0aCA6IGJvb2xlYW4sIG9wdGlvbnMgPzogYW55KSB7XG5cbiAgICAgICAgbGV0IHRva2VuID0gdGhpcy5nZXRBdXRoVG9rZW4ocmVxKTtcbiAgICAgICAgaWYobmVlZHNBdXRoKSB7XG5cbiAgICAgICAgICAgIGlmKG9wdGlvbnMgJiYgb3B0aW9ucy5sb2dnZXIpIHtcbiAgICAgICAgICAgICAgICAvLyBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhgU2VydmljZVByb3h5LmdldENsaWVudCgpIC0gVG9rZW46ICR7dG9rZW59YCk7XG4gICAgICAgICAgICAgICAgLy8gb3B0aW9ucy5sb2dnZXIuZGVidWcoYFNlcnZpY2VQcm94eS5nZXRDbGllbnQoKSAtIEpXVDogJHtyZXEuand0fWApO1xuICAgICAgICAgICAgICAgIGlmKCF0b2tlbikge1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmxvZ2dlci53YXJuKFwiU2VydmljZVByb3h5LmdldENsaWVudCgpIC0gTm8gQWNjZXNzIFRva2VuIHdhcyBwcm92aWRlZCBvbiBpbmNvbWluZyByZXF1ZXN0IGhlYWRlciFcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYoISFvcHRpb25zLmRlYnVnKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMubG9nZ2VyLmRlYnVnKGBTZXJ2aWNlUHJveHkuZ2V0Q2xpZW50KCkgLSBUb2tlbjogJHt0b2tlbn1gKTtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5sb2dnZXIuZGVidWcoYFNlcnZpY2VQcm94eS5nZXRDbGllbnQoKSAtIEpXVDogJHtyZXEuand0fWApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZighdG9rZW4pIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIltXQVJOXSBObyBBY2Nlc3MgVG9rZW4gcHJvdmlkZWQgb24gaW5jb21pbmcgcmVxdWVzdCBoZWFkZXJcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvL2NoZWNrIHRoZSBpbmNvbWluZyBwcm94aWVkIHJlcXVlc3QgZm9yIGNvb2tpZXMgdGhhdCBzaG91bGQgYmUgZm9yd2FyZGVkIGFsb25nXG4gICAgICAgIGxldCBjb29raWUgPSB0aGlzLmdldEF1dGhDb29raWUocmVxKTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJDT09LSUUgSVMgXCIgKyBjb29raWUpO1xuICAgICAgICBpZihjb29raWUgJiYgIWNvb2tpZS5sZW5ndGgpIGNvb2tpZSA9IG51bGw7XG5cbiAgICAgICAgLy8gaWYob3B0aW9ucyAmJiBvcHRpb25zLmxvZ2dlcikge1xuICAgICAgICAvLyAgICAgb3B0aW9ucy5sb2dnZXIuZGVidWcoXCJQcm94eWluZyBSZXF1ZXN0IENvb2tpZTogXCIgKyBjb29raWUpO1xuICAgICAgICAvLyAgICAgb3B0aW9ucy5sb2dnZXIuZGVidWcoXCIgXCIpO1xuICAgICAgICAvLyB9IGVsc2Uge1xuICAgICAgICAvLyAgICAgY29uc29sZS5sb2coXCJQcm94eWluZyBSZXF1ZXN0IENvb2tpZTogXCIgKyBjb29raWUpO1xuICAgICAgICAvLyB9XG5cblxuICAgICAgICByZXR1cm4gbmV3IE5vZGVIdHRwQ2xpZW50KHtcbiAgICAgICAgICAgIHRpbWVvdXQ6IENvbmZpZy50aW1lb3V0LFxuICAgICAgICAgICAgdG9rZW46IG5lZWRzQXV0aCA/IHRva2VuIDogbnVsbCxcbiAgICAgICAgICAgIGNvb2tpZTogbmVlZHNBdXRoID8gY29va2llIDogbnVsbFxuICAgICAgICB9KTtcbiAgICB9LFxuXG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge0h0dHBSZXF1ZXN0fSByZXEgLSBpbmNvbWluZyBodHRwIHJlcXVlc3QgYmVpbmcgcHJveGllZFxuICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbmVlZHNBdXRoIC0gZmxhZyBpbmRpY2F0aW5nIGlmIHJlcXVlc3QgcmVxdWlyZXMgYXV0aG9yaXphdGlvbiB0b2tlblxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIC0gYWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnNcbiAgICAgKi9cbiAgICBnZXRTZXJ2aWNlOiBmdW5jdGlvbihyZXEgOiBhbnksIG5lZWRzQXV0aCA6IGJvb2xlYW4sIG9wdGlvbnMgPzogYW55KSB7XG4gICAgICAgIGxldCBjbGllbnQgPSB0aGlzLmdldENsaWVudChyZXEsIG5lZWRzQXV0aCwgb3B0aW9ucyk7XG4gICAgICAgIGxldCBzdmNDbGFzcyA9IG9wdGlvbnMuc2VydmljZUNsYXNzIHx8IEl0ZW1TZXJ2aWNlO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhcIlByb3h5aW5nIHRvIFwiICsgQ29uZmlnLnVhbFVybCk7XG4gICAgICAgIGlmKG9wdGlvbnMubG9nZ2VyKSB7XG4gICAgICAgICAgICBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhgUHJveHlpbmcgdG8gJHtDb25maWcudWFsVXJsfWApO1xuICAgICAgICAgICAgLy8gb3B0aW9ucy5sb2dnZXIuZGVidWcoXCJVc2luZyBzZXJ2aWNlIGNsYXNzOiBcIiArIHN2Y0NsYXNzKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgc2VydmljZSA9IG5ldyBzdmNDbGFzcyhDb25maWcudWFsVXJsLCBjbGllbnQpO1xuICAgICAgICBzZXJ2aWNlLnNldFRpbWVvdXQoQ29uZmlnLnRpbWVvdXQgfHwgMzAwMDApO1xuICAgICAgICBpZihvcHRpb25zLmxvZ2dlcikge1xuICAgICAgICAgICAgc2VydmljZS5zZXRMb2dnZXIob3B0aW9ucy5sb2dnZXIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzZXJ2aWNlO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBAcmV0dXJuIEpXVCBhdXRob3JpemF0aW9uIGJlYXJlciB0b2tlblxuICAgICAqL1xuICAgIGdldEF1dGhUb2tlbjogZnVuY3Rpb24ocmVxIDogYW55KSA6IHN0cmluZyB7XG4gICAgICAgIGxldCB0b2tlbiA9IHJlcS5hY2Nlc3NUb2tlbiB8fCBudWxsO1xuICAgICAgICBpZighdG9rZW4gJiYgIXJlcS5qd3QpIHsgICAgLy9pZiBub3QgcHJvY2Vzc2VkIGJ5IG1pZGRsZXdhcmUuLi5cbiAgICAgICAgICAgIHRva2VuID0gKHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24gfHwgJycpLnJlcGxhY2UoJ0JlYXJlciAnLCcnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdG9rZW47XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEByZXR1cm4gR1AgQXV0aGVudGljYXRpb24gY29va2llXG4gICAgICovXG4gICAgZ2V0QXV0aENvb2tpZTogZnVuY3Rpb24ocmVxOiBhbnkpIDogc3RyaW5nIHtcbiAgICAgICAgaWYoIXJlcSkgcmV0dXJuIG51bGw7XG4gICAgICAgIGlmKHJlcS5jb29raWVzKSB7ICAgLy9wYXJzZWQgYnkgY29va2llUGFyc2VyIGFscmVhZHlcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiQ09PS0lFUyBQQVJTRUQgLi4uIFwiKTtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiQ09PS0lFUyBBUkUuLi5cIik7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyZXEuY29va2llcykpO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCIgXCIpO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCJBVVRIIENPT0tJRSBJUyBcIiArIHJlcS5jb29raWVzW0dQX0FVVEhfQ09PS0lFXSk7XG4gICAgICAgICAgICByZXR1cm4gcmVxLmNvb2tpZXNbR1BfQVVUSF9DT09LSUVdO1xuXG4gICAgICAgIH0gZWxzZSBpZihyZXEuaGVhZGVycy5jb29raWUpIHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiQ09PS0lFUyBORUVEIFBBUlNJTkdcIik7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGxldCBjb29raWVzID0gdGhpcy5wYXJzZUNvb2tpZXMocmVxLmhlYWRlcnMuY29va2llKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gY29va2llc1tHUF9BVVRIX0NPT0tJRV07XG4gICAgICAgICAgICB9IGNhdGNoKCBlICkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRVJST1IgcGFyc2luZyBjb29raWVzOiBcIiArIGUubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgcGFyc2VDb29raWVzOiBmdW5jdGlvbiBwYXJzZShzdHIgOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCFzdHIgfHwgdHlwZW9mIHN0ciAhPT0gJ3N0cmluZycgfHwgIXN0ci5sZW5ndGgpIHJldHVybiBudWxsO1xuXG4gICAgICAgIGxldCByZXN1bHQgPSB7fVxuICAgICAgICBsZXQgZXhwciA9IC87ICovO1xuICAgICAgICBsZXQgcGFpcnMgPSBzdHIuc3BsaXQoZXhwcik7XG5cbiAgICAgICAgcGFpcnMuZm9yRWFjaCggcGFpciA9PiB7XG4gICAgICAgICAgICBsZXQgc2VwSWR4ID0gcGFpci5pbmRleE9mKCc9Jyk7XG5cbiAgICAgICAgICAgIGlmIChzZXBJZHggPCAwKSByZXR1cm47IC8vaWdub3JlIG5vbi0gJ2tleT12YWx1ZScgdmFsdWVzXG5cbiAgICAgICAgICAgIGxldCBrZXkgPSBwYWlyLnN1YnN0cigwLCBzZXBJZHgpLnRyaW0oKTtcbiAgICAgICAgICAgIGxldCB2YWwgPSBwYWlyLnN1YnN0cigrK3NlcElkeCwgcGFpci5sZW5ndGgpLnRyaW0oKTtcblxuICAgICAgICAgICAgLy8gcXVvdGVkIHZhbHVlc1xuICAgICAgICAgICAgaWYgKCdcIicgPT0gdmFsWzBdKSB2YWwgPSB2YWwuc2xpY2UoMSwgLTEpO1xuXG4gICAgICAgICAgICAvLyBvbmx5IGFzc2lnbiBvbmNlXG4gICAgICAgICAgICBpZiAodW5kZWZpbmVkID09IHJlc3VsdFtrZXldKSB7XG4gICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gdmFsO1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZGVjb2RlVVJJQ29tcG9uZW50KHZhbCk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgeyB9XG4gICAgICAgICAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cblxuXG5cbn07XG5cbmV4cG9ydCBkZWZhdWx0IFNlcnZpY2VQcm94eTtcbiJdfQ==