/*
This software has been approved for release by the U.S. Department of the Interior. Although the software has been subjected to rigorous review, the DOI reserves the right to update the software as needed pursuant to further analysis and review. No warranty, expressed or implied, is made by the DOI or the U.S. Government as to the functionality of the software and related material nor shall the fact of release constitute any such warranty. Furthermore, the software is released on condition that neither the DOI nor the U.S. Government shall be held liable for any damages resulting from its authorized or unauthorized use.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@geoplatform/client")):"function"==typeof define&&define.amd?define("@geoplatform/client/node",["exports","@geoplatform/client"],t):t(((e=e||self).geoplatform=e.geoplatform||{},e.geoplatform.client=e.geoplatform.client||{},e.geoplatform.client.node={}),e.geoplatform.client)}(this,function(e,t){"use strict";var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};var o=function(e){function t(t){return e.call(this,t)||this}return function(e,t){function o(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}(t,e),t.prototype.createRequestOpts=function(e){var t={method:e.method,url:e.url,json:!1!==e.json,timeout:e.timeout||this.timeout};if(e.params&&(t.qs=e.params),e.file){var r=require("fs");if(!r)throw new Error("Module 'fs' not available");t.formData={file:{value:r.createReadStream(e.file.path),options:{filename:e.file.originalFilename}}},Object.assign(t.formData,e.data||{})}else e.data&&(e.formData?t.formData=e.data:t.body=e.data);if(e.headers&&(t.headers=e.headers),this.token){var o=this.token();o&&(t.auth={bearer:o})}var n=this.getCookie();if(n&&(t.headers=t.headers||{},t.headers.Cookie=this.authCookieName+"="+n),e.options)for(var a in e.options)e.options.hasOwnProperty(a)&&(t[a]=e.options[a]);return t},t.prototype.execute=function(e){var t=this,r=require("request");if(!r)throw new Error("Module 'request' not available");return new Promise(function(o,n){r(e,function(r,a,s){t.checkAndHandleError(r,a).then(function(){!1===e.json?o(a):o(s)}).catch(function(e){return n(e)})})})},t.prototype.checkAndHandleError=function(e,t){var r={message:null,error:null,status:200};if(e){if("ETIMEDOUT"!==e.code&&"ESOCKETTIMEDOUT"!==e.code)return Promise.reject(e);r.status=500,r.error="Connection Timeout",r.message="The response from the service took too long to read",!0===e.connect&&(r.message="Unable to establish a connection to the service")}else if(t.statusCode<200||t.statusCode>204)if(r.status=t.statusCode,t.body&&"object"==typeof t.body){if((r=t.body).status=r.status||t.statusCode,r.message=r.message||"An error occurred communicating with service",409===t.statusCode){var o=t.body.message.indexOf(" "),n=t.body.message.indexOf(" already exists");o>=0&&n>o&&(r.item=t.body.message.substring(o+1,n))}}else switch(t.statusCode){case 404:r.error="Not Found",r.message=t.request.uri.pathname+" cannot be found";break;case 401:r.error="Unauthenticated",r.message="You are not authenticated";break;case 403:r.error="Unauthorized",r.message="You are not authorized to access "+t.request.uri.pathname;break;case 409:r.error="Conflict",r.message="Item already exists";try{o=(a=JSON.parse(t.body)).message.indexOf(" "),n=a.message.indexOf(" already exists");o>=0&&n>o&&(r.item=a.message.substring(o+1,n))}catch(e){r.message+=".  Unable to extract existing identifier from service response"}break;default:try{var a;(r=a=JSON.parse(t.body)).status=t.statusCode}catch(e){r.error="Server Error",r.message=t.body}}if(r.status<200||r.status>204){r.error=r.error||"Server Error",r.status=r.status||t.statusCode,r.message=r.message||"An error occurred communicating with service";var s=new Error(r.message);return Object.assign(s,r),Promise.reject(s)}return Promise.resolve(null)},t}(t.GPHttpClient),n={bindRoutes:function(e,t,r){var o=this,n=(r=r||{}).paths||{},a=r.auth||{};t.forEach(function(t){if(!1!==n[t.key]&&(n[t.key]||t.path)){var s=r[t.key]||{},i="/"+(s.path||n[t.key]||t.path),u=s.auth||a[t.key]||t.auth;r.logger&&r.logger.debug("Binding Service Route ["+t.method+"] "+i),e[t.method](i,function(e,n,a){var c=null;if("function"!=typeof t.onExecute)c=Promise.resolve(null);else{r.logger&&(r.logger.debug("Executing Service Route ["+t.method+"] "+i),r.logger.debug(JSON.stringify(e.params)),r.logger.debug("-------------------------"));var d=o.getService(e,u,r);try{c=t.onExecute(d,e)}catch(e){c=Promise.reject(e)}}c.then(function(e){var r=s.onResponse||t.onResponse;r?r(e,n,a):n.json(e)}).catch(function(e){s.onError&&s.onError(e),r.onError&&r.onError(t.key,e),a(e)}).finally(function(){s.onFinish&&s.onFinish(e,n);var o=r.onFinish;o&&o(t.key,e,n)})})}})},getClient:function(e,r,n){var a=e.accessToken||null;r&&n&&n.logger&&(a?n.debug&&(n.logger.debug("ServiceProxy.getClient() - Token: "+a),n.logger.debug("ServiceProxy.getClient() - JWT: "+e.jwt)):n.logger.warn("ServiceProxy.getClient() - No Access Token was provided on incoming request header!"));var s=this.getAuthCookie(e);return s&&!s.length&&(s=null),new o({timeout:t.Config.timeout,token:r?a:null,cookie:r?s:null})},getService:function(e,r,o){var n=this.getClient(e,r,o),a=o.serviceClass||t.ItemService;o.logger&&o.logger.debug("Proxying to "+t.Config.ualUrl);var s=new a(t.Config.ualUrl,n);return s.setTimeout(t.Config.timeout||3e4),o.logger&&s.setLogger(o.logger),s},getAuthCookie:function(e){if(!e)return null;if(e.cookies)return e.cookies["gpoauth-a"];if(e.headers.cookie)try{return this.parseCookies(e.headers.cookie)["gpoauth-a"]}catch(e){return console.log("ERROR parsing cookies: "+e.message),null}},parseCookies:function(e){if(!e||"string"!=typeof e||!e.length)return null;var t={};return e.split(/; */).forEach(function(e){var r=e.indexOf("=");if(!(r<0)){var o=e.substr(0,r).trim(),n=e.substr(++r,e.length).trim();if('"'==n[0]&&(n=n.slice(1,-1)),null==t[o]){var a=n;try{a=decodeURIComponent(n)}catch(e){}t[o]=a}}}),t}},a=[{key:"search",method:"get",path:"items",auth:!1,onExecute:function(e,r){var o=new t.Query(r.query);return e.search(o)}},{key:"get",method:"get",path:"items/:id",auth:!1,onExecute:function(e,t){return e.get(t.params.id)}},{key:"create",method:"post",path:"items",auth:!0,onExecute:function(e,t){return e.save(t.body)}},{key:"update",method:"put",path:"items/:id",auth:!0,onExecute:function(e,t){return e.save(t.body)}},{key:"delete",method:"delete",path:"items/:id",auth:!0,onExecute:function(e,t){return e.remove(t.params.id)},onResponse:function(e,t){t.status(204).end()}},{key:"patch",method:"patch",path:"items/:id",auth:!0,onExecute:function(e,t){return e.patch(t.params.id,t.body)}},{key:"clone",method:"post",path:"items/:id/clone",auth:!0,onExecute:function(e,t){return e.clone(t.params.id,t.body)}},{key:"clone",method:"post",path:"items/:id/clone",auth:!0,execFn:function(e,t){return e.clone(t.params.id,t.body)}},{key:"export",method:"get",path:"items/:id/export",auth:!1,onExecute:function(e,t){return e.export(t.params.id,t.query.format)},onResponse:function(e,t){var r=e.headers["content-type"],o=e.headers["content-disposition"];t.set("Content-Type",r),t.setHeader("Content-disposition",o),t.send(e.body)}},{key:"uri",method:"post",path:"items/uri",auth:!1,onExecute:function(e,t){return e.getUri(t.body)},onResponse:function(e,t){t.json({uri:e})}},{key:"exists",method:"post",path:"items/exists",auth:!1,onExecute:function(e,r){return e.getUri(r.body).then(function(r){var o=(new t.Query).uri(r).fields(["serviceType","services","scheme","themes","publishers","keywords"]);return e.search(o)})}},{key:"import",method:"post",path:"items/import",auth:!0,onExecute:function(e,t){var r=t.body.url||t.files.file;return e.import(r,t.query.format)}},{key:"associations",method:"get",path:"items/:id/associations",auth:!1,onExecute:function(e,t){return e.associations(t.params.id,t.query)}},{key:"versions",method:"get",path:"items/:id/versions",auth:!1,onExecute:function(e,t){return e.versions(t.params.id,t.query)}},{key:"getVersion",method:"get",path:"items/:id/versions/:version",auth:!1,onExecute:function(e,t){return e.get(t.params.id,{version:t.params.version})}}];var s=[{key:"search",method:"get",path:"services",auth:!1,onExecute:function(e,t){return e.search(t.query)}},{key:"get",method:"get",path:"services/:id",auth:!1,onExecute:function(e,t){return e.get(t.params.id)}},{key:"create",method:"post",path:"services",auth:!0,onExecute:function(e,t){return e.save(t.body)}},{key:"update",method:"put",path:"services/:id",auth:!0,onExecute:function(e,t){return e.save(t.body)}},{key:"delete",method:"delete",path:"services/:id",auth:!0,onExecute:function(e,t){return e.remove(t.params.id)},onResponse:function(e,t){t.status(204).end()}},{key:"patch",method:"patch",path:"services/:id",auth:!0,onExecute:function(e,t){return e.patch(t.params.id,t.body)}},{key:"export",method:"get",path:"services/:id/export",auth:!1,onExecute:function(e,t){return e.export(t.params.id,t.query.format)},onResponse:function(e,t){var r=e.headers["content-type"],o=e.headers["content-disposition"];t.set("Content-Type",r),t.setHeader("Content-disposition",o),t.send(e.body)}},{key:"types",method:"get",path:"serviceTypes",auth:!1,onExecute:function(e){return e.types()}},{key:"import",method:"post",path:"services/import",auth:!0,onExecute:function(e,t){return e.import(t.body)}},{key:"about",method:"get",path:"services/:id/about",auth:!1,onExecute:function(e,t){return e.about(t.params.id)}},{key:"harvest",method:"get",path:"services/:id/harvest",auth:!1,onExecute:function(e,t){return e.harvest(t.params.id)}},{key:"test",method:"get",path:"services/:id/test",auth:!1,onExecute:function(e,t){return e.liveTest(t.params.id)}},{key:"statistics",method:"get",path:"services/:id/statistics",auth:!1,onExecute:function(e,t){return e.statistics(t.params.id)}}];var i=[{key:"search",method:"get",path:"layers",auth:!1,onExecute:function(e,t){return e.search(t.query)}},{key:"get",method:"get",path:"layers/:id",auth:!1,onExecute:function(e,t){return e.get(t.params.id)}},{key:"create",method:"post",path:"layers",auth:!0,onExecute:function(e,t){return e.save(t.body)}},{key:"update",method:"put",path:"layers/:id",auth:!0,onExecute:function(e,t){return e.save(t.body)}},{key:"delete",method:"delete",path:"layers/:id",auth:!0,onExecute:function(e,t){return e.remove(t.params.id)},onResponse:function(e,t){t.status(204).end()}},{key:"patch",method:"patch",path:"layers/:id",auth:!0,onExecute:function(e,t){return e.patch(t.params.id,t.body)}},{key:"export",method:"get",path:"layers/:id/export",auth:!1,onExecute:function(e,t){return e.export(t.params.id,t.query.format)},onResponse:function(e,t){var r=e.headers["content-type"],o=e.headers["content-disposition"];t.set("Content-Type",r),t.setHeader("Content-disposition",o),t.send(e.body)}},{key:"style",method:"get",path:"layers/:id/style",auth:!1,onExecute:function(e,t){return e.style(t.params.id)}},{key:"styleById",method:"get",path:"layers/:id/styles/:styleId",auth:!1,onExecute:function(e,t){return e.style(t.params.id,t.params.styleId)}},{key:"styles",method:"get",path:"layers/:id/styles",auth:!1,onExecute:function(e,t){return e.styles(t.params.id)}},{key:"describe",method:"post",path:"layers/:id/describe",auth:!1,onExecute:function(e,t){return e.describe(t.params.id,t.body)}},{key:"validate",method:"post",path:"layers/:id/validate",auth:!1,onExecute:function(e,t){return e.validate(t.params.id,t.body)}}];var u=[{key:"search",method:"get",path:"datasets",auth:!1,onExecute:function(e,t){return e.search(t.query)}},{key:"get",method:"get",path:"datasets/:id",auth:!1,onExecute:function(e,t){return e.get(t.params.id)}},{key:"create",method:"post",path:"datasets",auth:!0,onExecute:function(e,t){return e.save(t.body)}},{key:"update",method:"put",path:"datasets/:id",auth:!0,onExecute:function(e,t){return e.save(t.body)}},{key:"delete",method:"delete",path:"datasets/:id",auth:!0,onExecute:function(e,t){return e.remove(t.params.id)},onResponse:function(e,t){t.status(204).end()}},{key:"patch",method:"patch",path:"datasets/:id",auth:!0,onExecute:function(e,t){return e.patch(t.params.id,t.body)}},{key:"export",method:"get",path:"datasets/:id/export",auth:!1,onExecute:function(e,t){return e.export(t.params.id,t.query.format)},onResponse:function(e,t){var r=e.headers["content-type"],o=e.headers["content-disposition"];t.set("Content-Type",r),t.setHeader("Content-disposition",o),t.send(e.body)}}];var c=[{key:"search",method:"get",path:"maps",auth:!1,onExecute:function(e,t){return e.search(t.query)}},{key:"get",method:"get",path:"maps/:id",auth:!1,onExecute:function(e,t){return e.get(t.params.id)}},{key:"create",method:"post",path:"maps",auth:!0,onExecute:function(e,t){return e.save(t.body)}},{key:"update",method:"put",path:"maps/:id",auth:!0,onExecute:function(e,t){return e.save(t.body)}},{key:"delete",method:"delete",path:"maps/:id",auth:!0,onExecute:function(e,t){return e.remove(t.params.id)},onResponse:function(e,t){t.status(204).end()}},{key:"patch",method:"patch",path:"maps/:id",auth:!0,onExecute:function(e,t){return e.patch(t.params.id,t.body)}},{key:"export",method:"get",path:"maps/:id/export",auth:!1,onExecute:function(e,t){return e.export(t.params.id,t.query.format)},onResponse:function(e,t){var r=e.headers["content-type"],o=e.headers["content-disposition"];t.set("Content-Type",r),t.setHeader("Content-disposition",o),t.send(e.body)}}];var d=[{key:"search",method:"get",path:"galleries",auth:!1,onExecute:function(e,t){return e.search(t.query)}},{key:"get",method:"get",path:"galleries/:id",auth:!1,onExecute:function(e,t){return e.get(t.params.id)}},{key:"create",method:"post",path:"galleries",auth:!0,onExecute:function(e,t){return e.save(t.body)}},{key:"update",method:"put",path:"galleries/:id",auth:!0,onExecute:function(e,t){return e.save(t.body)}},{key:"delete",method:"delete",path:"galleries/:id",auth:!0,onExecute:function(e,t){return e.remove(t.params.id)},onResponse:function(e,t){t.status(204).end()}},{key:"patch",method:"patch",path:"galleries/:id",auth:!0,onExecute:function(e,t){return e.patch(t.params.id,t.body)}},{key:"export",method:"get",path:"galleries/:id/export",auth:!1,onExecute:function(e,t){return e.export(t.params.id,t.query.format)},onResponse:function(e,t){var r=e.headers["content-type"],o=e.headers["content-disposition"];t.set("Content-Type",r),t.setHeader("Content-disposition",o),t.send(e.body)}}];var p=[{key:"locate",method:"get",path:"utils/locate",auth:!1,onExecute:function(e,t){return e.locate(t.query.location)}},{key:"parseFile",method:"post",path:"utils/parse",auth:!1,onExecute:function(e,t){return e.parseFile(t.files.file,t.body.format)}},{key:"capabilities",method:"get",path:"utils/capabilities",auth:!1,onExecute:function(e,t){return e.capabilities(null,t.query)}},{key:"capabilitiesProperty",method:"get",path:"utils/capabilities/:id",auth:!1,onExecute:function(e,t){return e.capabilities(t.params.id,t.query)}},{key:"store",method:"post",path:"store",auth:!0,onExecute:function(e,t){return e.store(t.files.file,t.body.format)}}];var h=[{key:"suggest",method:"get",path:"recommender/suggest",auth:!1,onExecute:function(e,r){var o=new t.KGQuery(r.query);return e.suggest(o)}},{key:"types",method:"get",path:"recommender/types",auth:!1,onExecute:function(e,r){var o=new t.KGQuery(r.query);return e.types(o)}},{key:"sources",method:"get",path:"recommender/sources",auth:!1,onExecute:function(e,r){var o=new t.KGQuery(r.query);return e.sources(o)}}];var y=[{key:"searchItems",method:"get",path:"agol/items",auth:!1,onExecute:function(e,t){return e.searchItems(t.query)}},{key:"searchGroups",method:"get",path:"agol/groups",auth:!1,onExecute:function(e,t){return e.searchGroups(t.query)}},{key:"searchOrgs",method:"get",path:"agol/orgs",auth:!1,onExecute:function(e,t){return e.searchOrgs(t.query)}},{key:"getItem",method:"get",path:"agol/items/:id",auth:!1,onExecute:function(e,t){return e.getItem(t.params.id)}},{key:"getGroup",method:"get",path:"agol/groups/:id",auth:!1,onExecute:function(e,t){return e.getGroup(t.params.id)}},{key:"getOrg",method:"get",path:"agol/orgs/:id",auth:!1,onExecute:function(e,t){return e.getOrg(t.params.id)}}];e.AgolServiceProxy=function(e){void 0===e&&(e={});var r=e.router;if(!e.router){var o=require("express");if(!o)throw new Error("AgolServiceProxy() - Must provide'options.router' or include express as a dependency");r=o.Router()}if(!r)throw new Error("AgolServiceProxy() - Unable to create proxy route, missing router");return e.serviceClass=t.AgolService,n.bindRoutes(r,y,e),r},e.DatasetServiceProxy=function(e){void 0===e&&(e={});var r=e.router;if(!e.router){var o=require("express");if(!o)throw new Error("DatasetServiceProxy() - Must provide'options.router' or include express as a dependency");r=o.Router()}if(!r)throw new Error("DatasetServiceProxy() - Unable to create proxy route, missing router");return e.serviceClass=t.DatasetService,n.bindRoutes(r,u,e),r},e.GalleryServiceProxy=function(e){void 0===e&&(e={});var r=e.router;if(!e.router){var o=require("express");if(!o)throw new Error("GalleryServiceProxy() - Must provide'options.router' or include express as a dependency");r=o.Router()}if(!r)throw new Error("GalleryServiceProxy() - Unable to create proxy route, missing router");return e.serviceClass=t.GalleryService,n.bindRoutes(r,d,e),r},e.ItemServiceProxy=function(e){void 0===e&&(e={});var r=e.router;if(!e.router){var o=require("express");if(!o)throw new Error("ItemServiceProxy() - Must provide'options.router' or include express as a dependency");r=o.Router()}if(!r)throw new Error("ItemServiceProxy() - Unable to create proxy route, missing router");return function(e,r){r.pathBaseDefault="items",r.serviceClass=t.ItemService,n.bindRoutes(e,a,r)}(r,e),r},e.KGServiceProxy=function(e){void 0===e&&(e={});var r=e.router;if(!e.router){var o=require("express");if(!o)throw new Error("KGServiceProxy() - Must provide'options.router' or include express as a dependency");r=o.Router()}if(!r)throw new Error("KGServiceProxy() - Unable to create proxy route, missing router");return e.serviceClass=t.KGService,n.bindRoutes(r,h,e),r},e.LayerServiceProxy=function(e){void 0===e&&(e={});var r=e.router;if(!e.router){var o=require("express");if(!o)throw new Error("LayerServiceProxy() - Must provide'options.router' or include express as a dependency");r=o.Router()}if(!r)throw new Error("LayerServiceProxy() - Unable to create proxy route, missing router");return e.serviceClass=t.LayerService,n.bindRoutes(r,i,e),r},e.MapServiceProxy=function(e){void 0===e&&(e={});var r=e.router;if(!e.router){var o=require("express");if(!o)throw new Error("MapServiceProxy() - Must provide'options.router' or include express as a dependency");r=o.Router()}if(!r)throw new Error("MapServiceProxy() - Unable to create proxy route, missing router");return e.serviceClass=t.MapService,n.bindRoutes(r,c,e),r},e.NodeHttpClient=o,e.ServiceServiceProxy=function(e){void 0===e&&(e={});var r=e.router;if(!e.router){var o=require("express");if(!o)throw new Error("ServiceServiceProxy() - Must provide'options.router' or include express as a dependency");r=o.Router()}if(!r)throw new Error("ServiceServiceProxy() - Unable to create proxy route, missing router");return e.serviceClass=t.ServiceService,n.bindRoutes(r,s,e),r},e.UtilsServiceProxy=function(e){void 0===e&&(e={});var r=e.router;if(!e.router){var o=require("express");if(!o)throw new Error("UtilsServiceProxy() - Must provide'options.router' or include express as a dependency");r=o.Router()}if(!r)throw new Error("UtilsServiceProxy() - Unable to create proxy route, missing router");return e.serviceClass=t.UtilsService,n.bindRoutes(r,p,e),r},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=geoplatform-client-node.umd.min.js.map