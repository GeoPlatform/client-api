import NodeHttpClient from '../../http/node';
import { Config, ItemService } from '@geoplatform/client';
const GP_AUTH_COOKIE = 'gpoauth-a';
const ɵ0 = function (router, routes, options) {
    options = options || {};
    let paths = options.paths || {};
    let auths = options.auth || {};
    routes.forEach(route => {
        if (paths[route.key] === false)
            return; //disabled endpoint
        if (!paths[route.key] && !route.path)
            return; //something is wrong with route
        //newer route override...
        // {
        //   'create': {
        //     'path': 'custom/path',
        //     'auth': true,
        //     'onResponse': function(result, res, next) { }
        //   }
        // }
        let overrides = options[route.key] || {};
        //look for overriden paths in either new override structure or older key:path format
        let path = '/' + (overrides.path || paths[route.key] || route.path);
        //look for authentication override in either new structure or older format
        let needsAuth = overrides.auth || auths[route.key] || route.auth;
        if (options.logger) {
            options.logger.debug(`Binding Service Route [${route.method}] ${path}`);
        }
        router[route.method](path, (req, res, next) => {
            let promise = null;
            if (typeof (route.onExecute) !== 'function') {
                promise = Promise.resolve(null);
            }
            else {
                if (options.logger) {
                    options.logger.debug(`Executing Service Route [${route.method}] ${path}`);
                    options.logger.debug(JSON.stringify(req.params));
                    options.logger.debug("-------------------------");
                }
                let svc = this.getService(req, needsAuth, options);
                try {
                    promise = route.onExecute(svc, req);
                }
                catch (e) {
                    promise = Promise.reject(e);
                }
            }
            promise.then((result) => {
                let onResponse = overrides.onResponse || route.onResponse;
                if (onResponse)
                    onResponse(result, res, next);
                else
                    res.json(result);
            })
                .catch((err) => {
                if (overrides.onError)
                    overrides.onError(err);
                if (options.onError)
                    options.onError(route.key, err);
                next(err);
            })
                .finally(() => {
                //if route has a finish function defined, invoke it
                if (overrides.onFinish) {
                    overrides.onFinish(req, res);
                }
                //if proxy has an overall finish function defined, invoke it
                let finishFn = options.onFinish;
                if (finishFn)
                    finishFn(route.key, req, res);
            });
        });
    });
}, ɵ1 = function (req, needsAuth, options) {
    let token = null;
    if (needsAuth) {
        token = req.accessToken || null;
        if (!token && !req.jwt) { //if not processed by middleware...
            token = (req.headers.authorization || '').replace('Bearer ', '');
        }
        if (options && options.logger) {
            // options.logger.debug(`ServiceProxy.getClient() - Token: ${token}`);
            // options.logger.debug(`ServiceProxy.getClient() - JWT: ${req.jwt}`);
            if (!token) {
                options.logger.warn("ServiceProxy.getClient() - No Access Token was provided on incoming request header!");
            }
            else if (!!options.debug) {
                options.logger.debug(`ServiceProxy.getClient() - Token: ${token}`);
                options.logger.debug(`ServiceProxy.getClient() - JWT: ${req.jwt}`);
            }
        }
        else if (!token) {
            console.log("[WARN] No Access Token provided on incoming request header");
        }
    }
    //check the incoming proxied request for cookies that should be forwarded along
    let cookie = this.getAuthCookie(req);
    // console.log("COOKIE IS " + cookie);
    if (cookie && !cookie.length)
        cookie = null;
    // if(options && options.logger) {
    //     options.logger.debug("Proxying Request Cookie: " + cookie);
    //     options.logger.debug(" ");
    // } else {
    //     console.log("Proxying Request Cookie: " + cookie);
    // }
    return new NodeHttpClient({
        timeout: Config.timeout,
        token: needsAuth ? token : null,
        cookie: needsAuth ? cookie : null
    });
}, ɵ2 = function (req, needsAuth, options) {
    let client = this.getClient(req, needsAuth, options);
    let svcClass = options.serviceClass || ItemService;
    // console.log("Proxying to " + Config.ualUrl);
    if (options.logger) {
        options.logger.debug(`Proxying to ${Config.ualUrl}`);
        // options.logger.debug("Using service class: " + svcClass);
    }
    let service = new svcClass(Config.ualUrl, client);
    service.setTimeout(Config.timeout || 30000);
    if (options.logger) {
        service.setLogger(options.logger);
    }
    return service;
}, ɵ3 = function (req) {
    if (!req)
        return null;
    if (req.cookies) { //parsed by cookieParser already
        // console.log("COOKIES PARSED ... ");
        // console.log("COOKIES ARE...");
        // console.log(JSON.stringify(req.cookies));
        // console.log(" ");
        // console.log("AUTH COOKIE IS " + req.cookies[GP_AUTH_COOKIE]);
        return req.cookies[GP_AUTH_COOKIE];
    }
    else if (req.headers.cookie) {
        // console.log("COOKIES NEED PARSING");
        try {
            let cookies = this.parseCookies(req.headers.cookie);
            return cookies[GP_AUTH_COOKIE];
        }
        catch (e) {
            console.log("ERROR parsing cookies: " + e.message);
            return null;
        }
    }
}, ɵ4 = function parse(str) {
    if (!str || typeof str !== 'string' || !str.length)
        return null;
    let result = {};
    let expr = /; */;
    let pairs = str.split(expr);
    pairs.forEach(pair => {
        let sepIdx = pair.indexOf('=');
        if (sepIdx < 0)
            return; //ignore non- 'key=value' values
        let key = pair.substr(0, sepIdx).trim();
        let val = pair.substr(++sepIdx, pair.length).trim();
        // quoted values
        if ('"' == val[0])
            val = val.slice(1, -1);
        // only assign once
        if (undefined == result[key]) {
            let value = val;
            try {
                value = decodeURIComponent(val);
            }
            catch (e) { }
            result[key] = value;
        }
    });
    return result;
};
const ServiceProxy = {
    /**
     * @param {Router} router - ExpressJS router instance
     * @param {array[object]} routes - list of routes to map to the router
     * @param {object} options - additional configuration needed
     */
    bindRoutes: ɵ0,
    /**
    * @param {HttpRequest} req - incoming http request being proxied
    * @param {boolean} needsAuth - flag indicating if the request must provide an authentication token
    * @param {object} options - additional configuration options
    * @return {HttpClient} client to use to make requests to GeoPlatform API endpoint
    */
    getClient: ɵ1,
    /**
     * @param {HttpRequest} req - incoming http request being proxied
     * @param {boolean} needsAuth - flag indicating if request requires authorization token
     * @param {object} options - additional configuration options
     */
    getService: ɵ2,
    getAuthCookie: ɵ3,
    parseCookies: ɵ4
};
export default ServiceProxy;
export { ɵ0, ɵ1, ɵ2, ɵ3, ɵ4 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BnZW9wbGF0Zm9ybS9jbGllbnQvbm9kZS8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL3Byb3hpZXMvYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLGNBQWMsTUFBTSxpQkFBaUIsQ0FBQztBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTFELE1BQU0sY0FBYyxHQUFHLFdBQVcsQ0FBQztXQVNuQixVQUFTLE1BQVksRUFBRSxNQUFjLEVBQUUsT0FBYztJQUU3RCxPQUFPLEdBQUcsT0FBTyxJQUFJLEVBQUUsQ0FBQztJQUN4QixJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztJQUNoQyxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUUvQixNQUFNLENBQUMsT0FBTyxDQUFFLEtBQUssQ0FBQyxFQUFFO1FBRXBCLElBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxLQUFLO1lBQUUsT0FBTyxDQUFFLG1CQUFtQjtRQUMzRCxJQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJO1lBQUUsT0FBTyxDQUFDLCtCQUErQjtRQUU1RSx5QkFBeUI7UUFDekIsSUFBSTtRQUNKLGdCQUFnQjtRQUNoQiw2QkFBNkI7UUFDN0Isb0JBQW9CO1FBQ3BCLG9EQUFvRDtRQUNwRCxNQUFNO1FBQ04sSUFBSTtRQUNKLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRXpDLG9GQUFvRjtRQUNwRixJQUFJLElBQUksR0FBRyxHQUFHLEdBQUcsQ0FBRSxTQUFTLENBQUMsSUFBSSxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUks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QUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFcEQsZ0JBQWdCO1FBQ2hCLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFBRSxHQUFHLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUUxQyxtQkFBbUI7UUFDbkIsSUFBSSxTQUFTLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzFCLElBQUksS0FBSyxHQUFHLEdBQUcsQ0FBQztZQUNoQixJQUFJO2dCQUNBLEtBQUssR0FBRyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUNuQztZQUFDLE9BQU8sQ0FBQyxFQUFFLEdBQUc7WUFDZixNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO1NBQ3ZCO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDO0FBN01MLE1BQU0sWUFBWSxHQUFHO0lBRWpCOzs7O09BSUc7SUFDSCxVQUFVLElBeUVUO0lBRUQ7Ozs7O01BS0U7SUFDRixTQUFTLElBMkNSO0lBR0Q7Ozs7T0FJRztJQUNILFVBQVUsSUFjVDtJQUVELGFBQWEsSUFtQlo7SUFFRCxZQUFZLElBNkJYO0NBS0osQ0FBQztBQUVGLGVBQWUsWUFBWSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXG5cbmltcG9ydCBOb2RlSHR0cENsaWVudCBmcm9tICcuLi8uLi9odHRwL25vZGUnO1xuaW1wb3J0IHsgQ29uZmlnLCBJdGVtU2VydmljZSB9IGZyb20gJ0BnZW9wbGF0Zm9ybS9jbGllbnQnO1xuXG5jb25zdCBHUF9BVVRIX0NPT0tJRSA9ICdncG9hdXRoLWEnO1xuXG5jb25zdCBTZXJ2aWNlUHJveHkgPSB7XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge1JvdXRlcn0gcm91dGVyIC0gRXhwcmVzc0pTIHJvdXRlciBpbnN0YW5jZVxuICAgICAqIEBwYXJhbSB7YXJyYXlbb2JqZWN0XX0gcm91dGVzIC0gbGlzdCBvZiByb3V0ZXMgdG8gbWFwIHRvIHRoZSByb3V0ZXJcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyAtIGFkZGl0aW9uYWwgY29uZmlndXJhdGlvbiBuZWVkZWRcbiAgICAgKi9cbiAgICBiaW5kUm91dGVzOiBmdW5jdGlvbihyb3V0ZXIgOiBhbnksIHJvdXRlcyA6IGFueVtdLCBvcHRpb25zID86IGFueSkge1xuXG4gICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgICAgICBsZXQgcGF0aHMgPSBvcHRpb25zLnBhdGhzIHx8IHt9O1xuICAgICAgICBsZXQgYXV0aHMgPSBvcHRpb25zLmF1dGggfHwge307XG5cbiAgICAgICAgcm91dGVzLmZvckVhY2goIHJvdXRlID0+IHtcblxuICAgICAgICAgICAgaWYocGF0aHNbcm91dGUua2V5XSA9PT0gZmFsc2UpIHJldHVybjsgIC8vZGlzYWJsZWQgZW5kcG9pbnRcbiAgICAgICAgICAgIGlmKCFwYXRoc1tyb3V0ZS5rZXldICYmICFyb3V0ZS5wYXRoKSByZXR1cm47IC8vc29tZXRoaW5nIGlzIHdyb25nIHdpdGggcm91dGVcblxuICAgICAgICAgICAgLy9uZXdlciByb3V0ZSBvdmVycmlkZS4uLlxuICAgICAgICAgICAgLy8ge1xuICAgICAgICAgICAgLy8gICAnY3JlYXRlJzoge1xuICAgICAgICAgICAgLy8gICAgICdwYXRoJzogJ2N1c3RvbS9wYXRoJyxcbiAgICAgICAgICAgIC8vICAgICAnYXV0aCc6IHRydWUsXG4gICAgICAgICAgICAvLyAgICAgJ29uUmVzcG9uc2UnOiBmdW5jdGlvbihyZXN1bHQsIHJlcywgbmV4dCkgeyB9XG4gICAgICAgICAgICAvLyAgIH1cbiAgICAgICAgICAgIC8vIH1cbiAgICAgICAgICAgIGxldCBvdmVycmlkZXMgPSBvcHRpb25zW3JvdXRlLmtleV0gfHwge307XG5cbiAgICAgICAgICAgIC8vbG9vayBmb3Igb3ZlcnJpZGVuIHBhdGhzIGluIGVpdGhlciBuZXcgb3ZlcnJpZGUgc3RydWN0dXJlIG9yIG9sZGVyIGtleTpwYXRoIGZvcm1hdFxuICAgICAgICAgICAgbGV0IHBhdGggPSAnLycgKyAoIG92ZXJyaWRlcy5wYXRoIHx8IHBhdGhzW3JvdXRlLmtleV0gfHwgcm91dGUucGF0aCApO1xuICAgICAgICAgICAgLy9sb29rIGZvciBhdXRoZW50aWNhdGlvbiBvdmVycmlkZSBpbiBlaXRoZXIgbmV3IHN0cnVjdHVyZSBvciBvbGRlciBmb3JtYXRcbiAgICAgICAgICAgIGxldCBuZWVkc0F1dGggPSBvdmVycmlkZXMuYXV0aCB8fCBhdXRoc1tyb3V0ZS5rZXldIHx8IHJvdXRlLmF1dGg7XG5cbiAgICAgICAgICAgIGlmKG9wdGlvbnMubG9nZ2VyKSB7XG4gICAgICAgICAgICAgICAgb3B0aW9ucy5sb2dnZXIuZGVidWcoYEJpbmRpbmcgU2VydmljZSBSb3V0ZSBbJHtyb3V0ZS5tZXRob2R9XSAke3BhdGh9YClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJvdXRlcltyb3V0ZS5tZXRob2RdKCBwYXRoLCAocmVxIDogYW55LCByZXMgOiBhbnksIG5leHQgOiBGdW5jdGlvbikgPT4ge1xuXG4gICAgICAgICAgICAgICAgbGV0IHByb21pc2UgPSBudWxsO1xuICAgICAgICAgICAgICAgIGlmKHR5cGVvZihyb3V0ZS5vbkV4ZWN1dGUpICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoIG51bGwgKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZihvcHRpb25zLmxvZ2dlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5sb2dnZXIuZGVidWcoYEV4ZWN1dGluZyBTZXJ2aWNlIFJvdXRlIFske3JvdXRlLm1ldGhvZH1dICR7cGF0aH1gKVxuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5sb2dnZXIuZGVidWcoSlNPTi5zdHJpbmdpZnkocmVxLnBhcmFtcykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5sb2dnZXIuZGVidWcoXCItLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGxldCBzdmMgPSB0aGlzLmdldFNlcnZpY2UocmVxLCBuZWVkc0F1dGgsIG9wdGlvbnMpO1xuXG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gcm91dGUub25FeGVjdXRlKHN2YywgcmVxKTtcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCggZSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBQcm9taXNlLnJlamVjdChlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHByb21pc2UudGhlbiggKCByZXN1bHQgOiBhbnkgKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBvblJlc3BvbnNlID0gb3ZlcnJpZGVzLm9uUmVzcG9uc2UgfHwgcm91dGUub25SZXNwb25zZTtcbiAgICAgICAgICAgICAgICAgICAgaWYob25SZXNwb25zZSkgb25SZXNwb25zZShyZXN1bHQsIHJlcywgbmV4dCk7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmVzLmpzb24ocmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaCggKGVyciA6IEVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmKG92ZXJyaWRlcy5vbkVycm9yKSBvdmVycmlkZXMub25FcnJvcihlcnIpO1xuICAgICAgICAgICAgICAgICAgICBpZihvcHRpb25zLm9uRXJyb3IpIG9wdGlvbnMub25FcnJvcihyb3V0ZS5rZXksIGVycik7XG4gICAgICAgICAgICAgICAgICAgIG5leHQoZXJyKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5maW5hbGx5KCAoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy9pZiByb3V0ZSBoYXMgYSBmaW5pc2ggZnVuY3Rpb24gZGVmaW5lZCwgaW52b2tlIGl0XG4gICAgICAgICAgICAgICAgICAgIGlmKG92ZXJyaWRlcy5vbkZpbmlzaCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcnJpZGVzLm9uRmluaXNoKHJlcSwgcmVzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vaWYgcHJveHkgaGFzIGFuIG92ZXJhbGwgZmluaXNoIGZ1bmN0aW9uIGRlZmluZWQsIGludm9rZSBpdFxuICAgICAgICAgICAgICAgICAgICBsZXQgZmluaXNoRm4gPSBvcHRpb25zLm9uRmluaXNoO1xuICAgICAgICAgICAgICAgICAgICBpZihmaW5pc2hGbikgZmluaXNoRm4ocm91dGUua2V5LCByZXEsIHJlcyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KTtcblxuICAgIH0sXG5cbiAgICAvKipcbiAgICAqIEBwYXJhbSB7SHR0cFJlcXVlc3R9IHJlcSAtIGluY29taW5nIGh0dHAgcmVxdWVzdCBiZWluZyBwcm94aWVkXG4gICAgKiBAcGFyYW0ge2Jvb2xlYW59IG5lZWRzQXV0aCAtIGZsYWcgaW5kaWNhdGluZyBpZiB0aGUgcmVxdWVzdCBtdXN0IHByb3ZpZGUgYW4gYXV0aGVudGljYXRpb24gdG9rZW5cbiAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIC0gYWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnNcbiAgICAqIEByZXR1cm4ge0h0dHBDbGllbnR9IGNsaWVudCB0byB1c2UgdG8gbWFrZSByZXF1ZXN0cyB0byBHZW9QbGF0Zm9ybSBBUEkgZW5kcG9pbnRcbiAgICAqL1xuICAgIGdldENsaWVudDogZnVuY3Rpb24ocmVxIDogYW55LCBuZWVkc0F1dGggOiBib29sZWFuLCBvcHRpb25zID86IGFueSkge1xuXG4gICAgICAgIGxldCB0b2tlbiA9IG51bGw7XG4gICAgICAgIGlmKG5lZWRzQXV0aCkge1xuXG4gICAgICAgICAgICB0b2tlbiA9IHJlcS5hY2Nlc3NUb2tlbiB8fCBudWxsO1xuICAgICAgICAgICAgaWYoIXRva2VuICYmICFyZXEuand0KSB7ICAgIC8vaWYgbm90IHByb2Nlc3NlZCBieSBtaWRkbGV3YXJlLi4uXG4gICAgICAgICAgICAgICAgdG9rZW4gPSAocmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbiB8fCAnJykucmVwbGFjZSgnQmVhcmVyICcsJycpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZihvcHRpb25zICYmIG9wdGlvbnMubG9nZ2VyKSB7XG4gICAgICAgICAgICAgICAgLy8gb3B0aW9ucy5sb2dnZXIuZGVidWcoYFNlcnZpY2VQcm94eS5nZXRDbGllbnQoKSAtIFRva2VuOiAke3Rva2VufWApO1xuICAgICAgICAgICAgICAgIC8vIG9wdGlvbnMubG9nZ2VyLmRlYnVnKGBTZXJ2aWNlUHJveHkuZ2V0Q2xpZW50KCkgLSBKV1Q6ICR7cmVxLmp3dH1gKTtcbiAgICAgICAgICAgICAgICBpZighdG9rZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5sb2dnZXIud2FybihcIlNlcnZpY2VQcm94eS5nZXRDbGllbnQoKSAtIE5vIEFjY2VzcyBUb2tlbiB3YXMgcHJvdmlkZWQgb24gaW5jb21pbmcgcmVxdWVzdCBoZWFkZXIhXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmKCEhb3B0aW9ucy5kZWJ1Zykge1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhgU2VydmljZVByb3h5LmdldENsaWVudCgpIC0gVG9rZW46ICR7dG9rZW59YCk7XG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMubG9nZ2VyLmRlYnVnKGBTZXJ2aWNlUHJveHkuZ2V0Q2xpZW50KCkgLSBKV1Q6ICR7cmVxLmp3dH1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYoIXRva2VuKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJbV0FSTl0gTm8gQWNjZXNzIFRva2VuIHByb3ZpZGVkIG9uIGluY29taW5nIHJlcXVlc3QgaGVhZGVyXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy9jaGVjayB0aGUgaW5jb21pbmcgcHJveGllZCByZXF1ZXN0IGZvciBjb29raWVzIHRoYXQgc2hvdWxkIGJlIGZvcndhcmRlZCBhbG9uZ1xuICAgICAgICBsZXQgY29va2llID0gdGhpcy5nZXRBdXRoQ29va2llKHJlcSk7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwiQ09PS0lFIElTIFwiICsgY29va2llKTtcbiAgICAgICAgaWYoY29va2llICYmICFjb29raWUubGVuZ3RoKSBjb29raWUgPSBudWxsO1xuXG4gICAgICAgIC8vIGlmKG9wdGlvbnMgJiYgb3B0aW9ucy5sb2dnZXIpIHtcbiAgICAgICAgLy8gICAgIG9wdGlvbnMubG9nZ2VyLmRlYnVnKFwiUHJveHlpbmcgUmVxdWVzdCBDb29raWU6IFwiICsgY29va2llKTtcbiAgICAgICAgLy8gICAgIG9wdGlvbnMubG9nZ2VyLmRlYnVnKFwiIFwiKTtcbiAgICAgICAgLy8gfSBlbHNlIHtcbiAgICAgICAgLy8gICAgIGNvbnNvbGUubG9nKFwiUHJveHlpbmcgUmVxdWVzdCBDb29raWU6IFwiICsgY29va2llKTtcbiAgICAgICAgLy8gfVxuXG5cbiAgICAgICAgcmV0dXJuIG5ldyBOb2RlSHR0cENsaWVudCh7XG4gICAgICAgICAgICB0aW1lb3V0OiBDb25maWcudGltZW91dCxcbiAgICAgICAgICAgIHRva2VuOiBuZWVkc0F1dGggPyB0b2tlbiA6IG51bGwsXG4gICAgICAgICAgICBjb29raWU6IG5lZWRzQXV0aCA/IGNvb2tpZSA6IG51bGxcbiAgICAgICAgfSk7XG4gICAgfSxcblxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtIdHRwUmVxdWVzdH0gcmVxIC0gaW5jb21pbmcgaHR0cCByZXF1ZXN0IGJlaW5nIHByb3hpZWRcbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IG5lZWRzQXV0aCAtIGZsYWcgaW5kaWNhdGluZyBpZiByZXF1ZXN0IHJlcXVpcmVzIGF1dGhvcml6YXRpb24gdG9rZW5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyAtIGFkZGl0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zXG4gICAgICovXG4gICAgZ2V0U2VydmljZTogZnVuY3Rpb24ocmVxIDogYW55LCBuZWVkc0F1dGggOiBib29sZWFuLCBvcHRpb25zID86IGFueSkge1xuICAgICAgICBsZXQgY2xpZW50ID0gdGhpcy5nZXRDbGllbnQocmVxLCBuZWVkc0F1dGgsIG9wdGlvbnMpO1xuICAgICAgICBsZXQgc3ZjQ2xhc3MgPSBvcHRpb25zLnNlcnZpY2VDbGFzcyB8fCBJdGVtU2VydmljZTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJQcm94eWluZyB0byBcIiArIENvbmZpZy51YWxVcmwpO1xuICAgICAgICBpZihvcHRpb25zLmxvZ2dlcikge1xuICAgICAgICAgICAgb3B0aW9ucy5sb2dnZXIuZGVidWcoYFByb3h5aW5nIHRvICR7Q29uZmlnLnVhbFVybH1gKTtcbiAgICAgICAgICAgIC8vIG9wdGlvbnMubG9nZ2VyLmRlYnVnKFwiVXNpbmcgc2VydmljZSBjbGFzczogXCIgKyBzdmNDbGFzcyk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHNlcnZpY2UgPSBuZXcgc3ZjQ2xhc3MoQ29uZmlnLnVhbFVybCwgY2xpZW50KTtcbiAgICAgICAgc2VydmljZS5zZXRUaW1lb3V0KENvbmZpZy50aW1lb3V0IHx8IDMwMDAwKTtcbiAgICAgICAgaWYob3B0aW9ucy5sb2dnZXIpIHtcbiAgICAgICAgICAgIHNlcnZpY2Uuc2V0TG9nZ2VyKG9wdGlvbnMubG9nZ2VyKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc2VydmljZTtcbiAgICB9LFxuXG4gICAgZ2V0QXV0aENvb2tpZTogZnVuY3Rpb24ocmVxOiBhbnkpIDogc3RyaW5nIHtcbiAgICAgICAgaWYoIXJlcSkgcmV0dXJuIG51bGw7XG4gICAgICAgIGlmKHJlcS5jb29raWVzKSB7ICAgLy9wYXJzZWQgYnkgY29va2llUGFyc2VyIGFscmVhZHlcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiQ09PS0lFUyBQQVJTRUQgLi4uIFwiKTtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiQ09PS0lFUyBBUkUuLi5cIik7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyZXEuY29va2llcykpO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCIgXCIpO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCJBVVRIIENPT0tJRSBJUyBcIiArIHJlcS5jb29raWVzW0dQX0FVVEhfQ09PS0lFXSk7XG4gICAgICAgICAgICByZXR1cm4gcmVxLmNvb2tpZXNbR1BfQVVUSF9DT09LSUVdO1xuICAgICAgICB9IGVsc2UgaWYocmVxLmhlYWRlcnMuY29va2llKSB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIkNPT0tJRVMgTkVFRCBQQVJTSU5HXCIpO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBsZXQgY29va2llcyA9IHRoaXMucGFyc2VDb29raWVzKHJlcS5oZWFkZXJzLmNvb2tpZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvb2tpZXNbR1BfQVVUSF9DT09LSUVdO1xuICAgICAgICAgICAgfSBjYXRjaCggZSApIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkVSUk9SIHBhcnNpbmcgY29va2llczogXCIgKyBlLm1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcblxuICAgIHBhcnNlQ29va2llczogZnVuY3Rpb24gcGFyc2Uoc3RyIDogc3RyaW5nKSB7XG4gICAgICAgIGlmICghc3RyIHx8IHR5cGVvZiBzdHIgIT09ICdzdHJpbmcnIHx8ICFzdHIubGVuZ3RoKSByZXR1cm4gbnVsbDtcblxuICAgICAgICBsZXQgcmVzdWx0ID0ge31cbiAgICAgICAgbGV0IGV4cHIgPSAvOyAqLztcbiAgICAgICAgbGV0IHBhaXJzID0gc3RyLnNwbGl0KGV4cHIpO1xuXG4gICAgICAgIHBhaXJzLmZvckVhY2goIHBhaXIgPT4ge1xuICAgICAgICAgICAgbGV0IHNlcElkeCA9IHBhaXIuaW5kZXhPZignPScpO1xuXG4gICAgICAgICAgICBpZiAoc2VwSWR4IDwgMCkgcmV0dXJuOyAvL2lnbm9yZSBub24tICdrZXk9dmFsdWUnIHZhbHVlc1xuXG4gICAgICAgICAgICBsZXQga2V5ID0gcGFpci5zdWJzdHIoMCwgc2VwSWR4KS50cmltKCk7XG4gICAgICAgICAgICBsZXQgdmFsID0gcGFpci5zdWJzdHIoKytzZXBJZHgsIHBhaXIubGVuZ3RoKS50cmltKCk7XG5cbiAgICAgICAgICAgIC8vIHF1b3RlZCB2YWx1ZXNcbiAgICAgICAgICAgIGlmICgnXCInID09IHZhbFswXSkgdmFsID0gdmFsLnNsaWNlKDEsIC0xKTtcblxuICAgICAgICAgICAgLy8gb25seSBhc3NpZ24gb25jZVxuICAgICAgICAgICAgaWYgKHVuZGVmaW5lZCA9PSByZXN1bHRba2V5XSkge1xuICAgICAgICAgICAgICAgIGxldCB2YWx1ZSA9IHZhbDtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGRlY29kZVVSSUNvbXBvbmVudCh2YWwpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgfVxuICAgICAgICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG5cblxuXG59O1xuXG5leHBvcnQgZGVmYXVsdCBTZXJ2aWNlUHJveHk7XG4iXX0=