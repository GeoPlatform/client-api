import NodeHttpClient from '../../http/node';
import { Config, ItemService } from '@geoplatform/client';
const GP_AUTH_COOKIE = 'gpoauth-a';
const ɵ0 = function (router, routes, options) {
    options = options || {};
    let paths = options.paths || {};
    let auths = options.auth || {};
    routes.forEach(route => {
        if (paths[route.key] === false)
            return; //disabled endpoint
        if (!paths[route.key] && !route.path)
            return; //something is wrong with route
        //newer route override...
        // {
        //   'create': {
        //     'path': 'custom/path',
        //     'auth': true,
        //     'onResponse': function(result, res, next) { }
        //   }
        // }
        let overrides = options[route.key] || {};
        //look for overriden paths in either new override structure or older key:path format
        let path = '/' + (overrides.path || paths[route.key] || route.path);
        //look for authentication override in either new structure or older format
        let needsAuth = overrides.auth || auths[route.key] || route.auth;
        if (options.logger) {
            options.logger.debug(`Binding Service Route [${route.method}] ${path}`);
        }
        router[route.method](path, (req, res, next) => {
            let promise = null;
            if (typeof (route.onExecute) !== 'function') {
                promise = Promise.resolve(null);
            }
            else {
                if (options.logger) {
                    options.logger.debug(`Executing Service Route [${route.method}] ${path}`);
                    options.logger.debug(JSON.stringify(req.params));
                    options.logger.debug("-------------------------");
                }
                let svc = this.getService(req, needsAuth, options);
                try {
                    promise = route.onExecute(svc, req);
                }
                catch (e) {
                    promise = Promise.reject(e);
                }
            }
            promise.then((result) => {
                let onResponse = overrides.onResponse || route.onResponse;
                if (onResponse)
                    onResponse(result, res, next);
                else
                    res.json(result);
            })
                .catch((err) => {
                if (overrides.onError)
                    overrides.onError(err);
                if (options.onError)
                    options.onError(route.key, err);
                next(err);
            })
                .finally(() => {
                //if route has a finish function defined, invoke it
                if (overrides.onFinish) {
                    overrides.onFinish(req, res);
                }
                //if proxy has an overall finish function defined, invoke it
                let finishFn = options.onFinish;
                if (finishFn)
                    finishFn(route.key, req, res);
            });
        });
    });
}, ɵ1 = function (req, needsAuth, options) {
    let token = req.accessToken || null;
    if (needsAuth && options && options.logger) {
        if (!token) {
            options.logger.warn("ServiceProxy.getClient() - No Access Token was provided on incoming request header!");
        }
        else if (!!options.debug) {
            options.logger.debug(`ServiceProxy.getClient() - Token: ${token}`);
            options.logger.debug(`ServiceProxy.getClient() - JWT: ${req.jwt}`);
        }
    }
    //check the incoming proxied request for cookies that should be forwarded along
    let cookie = this.getAuthCookie(req);
    // console.log("COOKIE IS " + cookie);
    if (cookie && !cookie.length)
        cookie = null;
    // if(options && options.logger) {
    //     options.logger.debug("Proxying Request Cookie: " + cookie);
    //     options.logger.debug(" ");
    // } else {
    //     console.log("Proxying Request Cookie: " + cookie);
    // }
    return new NodeHttpClient({
        timeout: Config.timeout,
        token: needsAuth ? token : null,
        cookie: needsAuth ? cookie : null
    });
}, ɵ2 = function (req, needsAuth, options) {
    let client = this.getClient(req, needsAuth, options);
    let svcClass = options.serviceClass || ItemService;
    // console.log("Proxying to " + Config.ualUrl);
    if (options.logger) {
        options.logger.debug(`Proxying to ${Config.ualUrl}`);
        // options.logger.debug("Using service class: " + svcClass);
    }
    let service = new svcClass(Config.ualUrl, client);
    service.setTimeout(Config.timeout || 30000);
    if (options.logger) {
        service.setLogger(options.logger);
    }
    return service;
}, ɵ3 = function (req) {
    if (!req)
        return null;
    if (req.cookies) { //parsed by cookieParser already
        // console.log("COOKIES PARSED ... ");
        // console.log("COOKIES ARE...");
        // console.log(JSON.stringify(req.cookies));
        // console.log(" ");
        // console.log("AUTH COOKIE IS " + req.cookies[GP_AUTH_COOKIE]);
        return req.cookies[GP_AUTH_COOKIE];
    }
    else if (req.headers.cookie) {
        // console.log("COOKIES NEED PARSING");
        try {
            let cookies = this.parseCookies(req.headers.cookie);
            return cookies[GP_AUTH_COOKIE];
        }
        catch (e) {
            console.log("ERROR parsing cookies: " + e.message);
            return null;
        }
    }
}, ɵ4 = function parse(str) {
    if (!str || typeof str !== 'string' || !str.length)
        return null;
    let result = {};
    let expr = /; */;
    let pairs = str.split(expr);
    pairs.forEach(pair => {
        let sepIdx = pair.indexOf('=');
        if (sepIdx < 0)
            return; //ignore non- 'key=value' values
        let key = pair.substr(0, sepIdx).trim();
        let val = pair.substr(++sepIdx, pair.length).trim();
        // quoted values
        if ('"' == val[0])
            val = val.slice(1, -1);
        // only assign once
        if (undefined == result[key]) {
            let value = val;
            try {
                value = decodeURIComponent(val);
            }
            catch (e) { }
            result[key] = value;
        }
    });
    return result;
};
const ServiceProxy = {
    /**
     * @param {Router} router - ExpressJS router instance
     * @param {array[object]} routes - list of routes to map to the router
     * @param {object} options - additional configuration needed
     */
    bindRoutes: ɵ0,
    /**
    * @param {HttpRequest} req - incoming http request being proxied
    * @param {boolean} needsAuth - flag indicating if the request must provide an authentication token
    * @param {object} options - additional configuration options
    * @return {HttpClient} client to use to make requests to GeoPlatform API endpoint
    */
    getClient: ɵ1,
    /**
     * @param {HttpRequest} req - incoming http request being proxied
     * @param {boolean} needsAuth - flag indicating if request requires authorization token
     * @param {object} options - additional configuration options
     */
    getService: ɵ2,
    getAuthCookie: ɵ3,
    parseCookies: ɵ4
};
export default ServiceProxy;
export { ɵ0, ɵ1, ɵ2, ɵ3, ɵ4 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BnZW9wbGF0Zm9ybS9jbGllbnQvbm9kZS8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL3Byb3hpZXMvYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLGNBQWMsTUFBTSxpQkFBaUIsQ0FBQztBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTFELE1BQU0sY0FBYyxHQUFHLFdBQVcsQ0FBQztXQVNuQixVQUFTLE1BQVksRUFBRSxNQUFjLEVBQUUsT0FBYztJQUU3RCxPQUFPLEdBQUcsT0FBTyxJQUFJLEVBQUUsQ0FBQztJQUN4QixJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztJQUNoQyxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUUvQixNQUFNLENBQUMsT0FBTyxDQUFFLEtBQUssQ0FBQyxFQUFFO1FBRXBCLElBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxLQUFLO1lBQUUsT0FBTyxDQUFFLG1CQUFtQjtRQUMzRCxJQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJO1lBQUUsT0FBTyxDQUFDLCtCQUErQjtRQUU1RSx5QkFBeUI7UUFDekIsSUFBSTtRQUNKLGdCQUFnQjtRQUNoQiw2QkFBNkI7UUFDN0Isb0JBQW9CO1FBQ3BCLG9EQUFvRDtRQUNwRCxNQUFNO1FBQ04sSUFBSTtRQUNKLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRXpDLG9GQUFvRjtRQUNwRixJQUFJLElBQUksR0FBRyxHQUFHLEdBQUcsQ0FBRSxTQUFTLENBQUMsSUFBSSxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUks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QUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ25DO1lBQUMsT0FBTyxDQUFDLEVBQUUsR0FBRztZQUNmLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7U0FDdkI7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILE9BQU8sTUFBTSxDQUFDO0FBQ2xCLENBQUM7QUFoTUwsTUFBTSxZQUFZLEdBQUc7SUFFakI7Ozs7T0FJRztJQUNILFVBQVUsSUF5RVQ7SUFFRDs7Ozs7TUFLRTtJQUNGLFNBQVMsSUE4QlI7SUFHRDs7OztPQUlHO0lBQ0gsVUFBVSxJQWNUO0lBRUQsYUFBYSxJQW1CWjtJQUVELFlBQVksSUE2Qlg7Q0FLSixDQUFDO0FBRUYsZUFBZSxZQUFZLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcblxuaW1wb3J0IE5vZGVIdHRwQ2xpZW50IGZyb20gJy4uLy4uL2h0dHAvbm9kZSc7XG5pbXBvcnQgeyBDb25maWcsIEl0ZW1TZXJ2aWNlIH0gZnJvbSAnQGdlb3BsYXRmb3JtL2NsaWVudCc7XG5cbmNvbnN0IEdQX0FVVEhfQ09PS0lFID0gJ2dwb2F1dGgtYSc7XG5cbmNvbnN0IFNlcnZpY2VQcm94eSA9IHtcblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7Um91dGVyfSByb3V0ZXIgLSBFeHByZXNzSlMgcm91dGVyIGluc3RhbmNlXG4gICAgICogQHBhcmFtIHthcnJheVtvYmplY3RdfSByb3V0ZXMgLSBsaXN0IG9mIHJvdXRlcyB0byBtYXAgdG8gdGhlIHJvdXRlclxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIC0gYWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG5lZWRlZFxuICAgICAqL1xuICAgIGJpbmRSb3V0ZXM6IGZ1bmN0aW9uKHJvdXRlciA6IGFueSwgcm91dGVzIDogYW55W10sIG9wdGlvbnMgPzogYW55KSB7XG5cbiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgICAgIGxldCBwYXRocyA9IG9wdGlvbnMucGF0aHMgfHwge307XG4gICAgICAgIGxldCBhdXRocyA9IG9wdGlvbnMuYXV0aCB8fCB7fTtcblxuICAgICAgICByb3V0ZXMuZm9yRWFjaCggcm91dGUgPT4ge1xuXG4gICAgICAgICAgICBpZihwYXRoc1tyb3V0ZS5rZXldID09PSBmYWxzZSkgcmV0dXJuOyAgLy9kaXNhYmxlZCBlbmRwb2ludFxuICAgICAgICAgICAgaWYoIXBhdGhzW3JvdXRlLmtleV0gJiYgIXJvdXRlLnBhdGgpIHJldHVybjsgLy9zb21ldGhpbmcgaXMgd3Jvbmcgd2l0aCByb3V0ZVxuXG4gICAgICAgICAgICAvL25ld2VyIHJvdXRlIG92ZXJyaWRlLi4uXG4gICAgICAgICAgICAvLyB7XG4gICAgICAgICAgICAvLyAgICdjcmVhdGUnOiB7XG4gICAgICAgICAgICAvLyAgICAgJ3BhdGgnOiAnY3VzdG9tL3BhdGgnLFxuICAgICAgICAgICAgLy8gICAgICdhdXRoJzogdHJ1ZSxcbiAgICAgICAgICAgIC8vICAgICAnb25SZXNwb25zZSc6IGZ1bmN0aW9uKHJlc3VsdCwgcmVzLCBuZXh0KSB7IH1cbiAgICAgICAgICAgIC8vICAgfVxuICAgICAgICAgICAgLy8gfVxuICAgICAgICAgICAgbGV0IG92ZXJyaWRlcyA9IG9wdGlvbnNbcm91dGUua2V5XSB8fCB7fTtcblxuICAgICAgICAgICAgLy9sb29rIGZvciBvdmVycmlkZW4gcGF0aHMgaW4gZWl0aGVyIG5ldyBvdmVycmlkZSBzdHJ1Y3R1cmUgb3Igb2xkZXIga2V5OnBhdGggZm9ybWF0XG4gICAgICAgICAgICBsZXQgcGF0aCA9ICcvJyArICggb3ZlcnJpZGVzLnBhdGggfHwgcGF0aHNbcm91dGUua2V5XSB8fCByb3V0ZS5wYXRoICk7XG4gICAgICAgICAgICAvL2xvb2sgZm9yIGF1dGhlbnRpY2F0aW9uIG92ZXJyaWRlIGluIGVpdGhlciBuZXcgc3RydWN0dXJlIG9yIG9sZGVyIGZvcm1hdFxuICAgICAgICAgICAgbGV0IG5lZWRzQXV0aCA9IG92ZXJyaWRlcy5hdXRoIHx8IGF1dGhzW3JvdXRlLmtleV0gfHwgcm91dGUuYXV0aDtcblxuICAgICAgICAgICAgaWYob3B0aW9ucy5sb2dnZXIpIHtcbiAgICAgICAgICAgICAgICBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhgQmluZGluZyBTZXJ2aWNlIFJvdXRlIFske3JvdXRlLm1ldGhvZH1dICR7cGF0aH1gKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcm91dGVyW3JvdXRlLm1ldGhvZF0oIHBhdGgsIChyZXEgOiBhbnksIHJlcyA6IGFueSwgbmV4dCA6IEZ1bmN0aW9uKSA9PiB7XG5cbiAgICAgICAgICAgICAgICBsZXQgcHJvbWlzZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgaWYodHlwZW9mKHJvdXRlLm9uRXhlY3V0ZSkgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSggbnVsbCApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMubG9nZ2VyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhgRXhlY3V0aW5nIFNlcnZpY2UgUm91dGUgWyR7cm91dGUubWV0aG9kfV0gJHtwYXRofWApXG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhKU09OLnN0cmluZ2lmeShyZXEucGFyYW1zKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhcIi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgbGV0IHN2YyA9IHRoaXMuZ2V0U2VydmljZShyZXEsIG5lZWRzQXV0aCwgb3B0aW9ucyk7XG5cbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSByb3V0ZS5vbkV4ZWN1dGUoc3ZjLCByZXEpO1xuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKCBlICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IFByb21pc2UucmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKCAoIHJlc3VsdCA6IGFueSApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9uUmVzcG9uc2UgPSBvdmVycmlkZXMub25SZXNwb25zZSB8fCByb3V0ZS5vblJlc3BvbnNlO1xuICAgICAgICAgICAgICAgICAgICBpZihvblJlc3BvbnNlKSBvblJlc3BvbnNlKHJlc3VsdCwgcmVzLCBuZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSByZXMuanNvbihyZXN1bHQpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKCAoZXJyIDogRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYob3ZlcnJpZGVzLm9uRXJyb3IpIG92ZXJyaWRlcy5vbkVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMub25FcnJvcikgb3B0aW9ucy5vbkVycm9yKHJvdXRlLmtleSwgZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgbmV4dChlcnIpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmZpbmFsbHkoICgpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAvL2lmIHJvdXRlIGhhcyBhIGZpbmlzaCBmdW5jdGlvbiBkZWZpbmVkLCBpbnZva2UgaXRcbiAgICAgICAgICAgICAgICAgICAgaWYob3ZlcnJpZGVzLm9uRmluaXNoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvdmVycmlkZXMub25GaW5pc2gocmVxLCByZXMpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy9pZiBwcm94eSBoYXMgYW4gb3ZlcmFsbCBmaW5pc2ggZnVuY3Rpb24gZGVmaW5lZCwgaW52b2tlIGl0XG4gICAgICAgICAgICAgICAgICAgIGxldCBmaW5pc2hGbiA9IG9wdGlvbnMub25GaW5pc2g7XG4gICAgICAgICAgICAgICAgICAgIGlmKGZpbmlzaEZuKSBmaW5pc2hGbihyb3V0ZS5rZXksIHJlcSwgcmVzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuXG4gICAgfSxcblxuICAgIC8qKlxuICAgICogQHBhcmFtIHtIdHRwUmVxdWVzdH0gcmVxIC0gaW5jb21pbmcgaHR0cCByZXF1ZXN0IGJlaW5nIHByb3hpZWRcbiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbmVlZHNBdXRoIC0gZmxhZyBpbmRpY2F0aW5nIGlmIHRoZSByZXF1ZXN0IG11c3QgcHJvdmlkZSBhbiBhdXRoZW50aWNhdGlvbiB0b2tlblxuICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgLSBhZGRpdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9uc1xuICAgICogQHJldHVybiB7SHR0cENsaWVudH0gY2xpZW50IHRvIHVzZSB0byBtYWtlIHJlcXVlc3RzIHRvIEdlb1BsYXRmb3JtIEFQSSBlbmRwb2ludFxuICAgICovXG4gICAgZ2V0Q2xpZW50OiBmdW5jdGlvbihyZXEgOiBhbnksIG5lZWRzQXV0aCA6IGJvb2xlYW4sIG9wdGlvbnMgPzogYW55KSB7XG5cbiAgICAgICAgbGV0IHRva2VuID0gcmVxLmFjY2Vzc1Rva2VuIHx8IG51bGw7XG4gICAgICAgIGlmKG5lZWRzQXV0aCAmJiBvcHRpb25zICYmIG9wdGlvbnMubG9nZ2VyKSB7XG4gICAgICAgICAgICBpZighdG9rZW4pIHtcbiAgICAgICAgICAgICAgICBvcHRpb25zLmxvZ2dlci53YXJuKFwiU2VydmljZVByb3h5LmdldENsaWVudCgpIC0gTm8gQWNjZXNzIFRva2VuIHdhcyBwcm92aWRlZCBvbiBpbmNvbWluZyByZXF1ZXN0IGhlYWRlciFcIik7XG4gICAgICAgICAgICB9IGVsc2UgaWYoISFvcHRpb25zLmRlYnVnKSB7XG4gICAgICAgICAgICAgICAgb3B0aW9ucy5sb2dnZXIuZGVidWcoYFNlcnZpY2VQcm94eS5nZXRDbGllbnQoKSAtIFRva2VuOiAke3Rva2VufWApO1xuICAgICAgICAgICAgICAgIG9wdGlvbnMubG9nZ2VyLmRlYnVnKGBTZXJ2aWNlUHJveHkuZ2V0Q2xpZW50KCkgLSBKV1Q6ICR7cmVxLmp3dH1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vY2hlY2sgdGhlIGluY29taW5nIHByb3hpZWQgcmVxdWVzdCBmb3IgY29va2llcyB0aGF0IHNob3VsZCBiZSBmb3J3YXJkZWQgYWxvbmdcbiAgICAgICAgbGV0IGNvb2tpZSA9IHRoaXMuZ2V0QXV0aENvb2tpZShyZXEpO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhcIkNPT0tJRSBJUyBcIiArIGNvb2tpZSk7XG4gICAgICAgIGlmKGNvb2tpZSAmJiAhY29va2llLmxlbmd0aCkgY29va2llID0gbnVsbDtcblxuICAgICAgICAvLyBpZihvcHRpb25zICYmIG9wdGlvbnMubG9nZ2VyKSB7XG4gICAgICAgIC8vICAgICBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhcIlByb3h5aW5nIFJlcXVlc3QgQ29va2llOiBcIiArIGNvb2tpZSk7XG4gICAgICAgIC8vICAgICBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhcIiBcIik7XG4gICAgICAgIC8vIH0gZWxzZSB7XG4gICAgICAgIC8vICAgICBjb25zb2xlLmxvZyhcIlByb3h5aW5nIFJlcXVlc3QgQ29va2llOiBcIiArIGNvb2tpZSk7XG4gICAgICAgIC8vIH1cblxuXG4gICAgICAgIHJldHVybiBuZXcgTm9kZUh0dHBDbGllbnQoe1xuICAgICAgICAgICAgdGltZW91dDogQ29uZmlnLnRpbWVvdXQsXG4gICAgICAgICAgICB0b2tlbjogbmVlZHNBdXRoID8gdG9rZW4gOiBudWxsLFxuICAgICAgICAgICAgY29va2llOiBuZWVkc0F1dGggPyBjb29raWUgOiBudWxsXG4gICAgICAgIH0pO1xuICAgIH0sXG5cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7SHR0cFJlcXVlc3R9IHJlcSAtIGluY29taW5nIGh0dHAgcmVxdWVzdCBiZWluZyBwcm94aWVkXG4gICAgICogQHBhcmFtIHtib29sZWFufSBuZWVkc0F1dGggLSBmbGFnIGluZGljYXRpbmcgaWYgcmVxdWVzdCByZXF1aXJlcyBhdXRob3JpemF0aW9uIHRva2VuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgLSBhZGRpdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9uc1xuICAgICAqL1xuICAgIGdldFNlcnZpY2U6IGZ1bmN0aW9uKHJlcSA6IGFueSwgbmVlZHNBdXRoIDogYm9vbGVhbiwgb3B0aW9ucyA/OiBhbnkpIHtcbiAgICAgICAgbGV0IGNsaWVudCA9IHRoaXMuZ2V0Q2xpZW50KHJlcSwgbmVlZHNBdXRoLCBvcHRpb25zKTtcbiAgICAgICAgbGV0IHN2Y0NsYXNzID0gb3B0aW9ucy5zZXJ2aWNlQ2xhc3MgfHwgSXRlbVNlcnZpY2U7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwiUHJveHlpbmcgdG8gXCIgKyBDb25maWcudWFsVXJsKTtcbiAgICAgICAgaWYob3B0aW9ucy5sb2dnZXIpIHtcbiAgICAgICAgICAgIG9wdGlvbnMubG9nZ2VyLmRlYnVnKGBQcm94eWluZyB0byAke0NvbmZpZy51YWxVcmx9YCk7XG4gICAgICAgICAgICAvLyBvcHRpb25zLmxvZ2dlci5kZWJ1ZyhcIlVzaW5nIHNlcnZpY2UgY2xhc3M6IFwiICsgc3ZjQ2xhc3MpO1xuICAgICAgICB9XG4gICAgICAgIGxldCBzZXJ2aWNlID0gbmV3IHN2Y0NsYXNzKENvbmZpZy51YWxVcmwsIGNsaWVudCk7XG4gICAgICAgIHNlcnZpY2Uuc2V0VGltZW91dChDb25maWcudGltZW91dCB8fCAzMDAwMCk7XG4gICAgICAgIGlmKG9wdGlvbnMubG9nZ2VyKSB7XG4gICAgICAgICAgICBzZXJ2aWNlLnNldExvZ2dlcihvcHRpb25zLmxvZ2dlcik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNlcnZpY2U7XG4gICAgfSxcblxuICAgIGdldEF1dGhDb29raWU6IGZ1bmN0aW9uKHJlcTogYW55KSA6IHN0cmluZyB7XG4gICAgICAgIGlmKCFyZXEpIHJldHVybiBudWxsO1xuICAgICAgICBpZihyZXEuY29va2llcykgeyAgIC8vcGFyc2VkIGJ5IGNvb2tpZVBhcnNlciBhbHJlYWR5XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIkNPT0tJRVMgUEFSU0VEIC4uLiBcIik7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIkNPT0tJRVMgQVJFLi4uXCIpO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVxLmNvb2tpZXMpKTtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiIFwiKTtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiQVVUSCBDT09LSUUgSVMgXCIgKyByZXEuY29va2llc1tHUF9BVVRIX0NPT0tJRV0pO1xuICAgICAgICAgICAgcmV0dXJuIHJlcS5jb29raWVzW0dQX0FVVEhfQ09PS0lFXTtcbiAgICAgICAgfSBlbHNlIGlmKHJlcS5oZWFkZXJzLmNvb2tpZSkge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCJDT09LSUVTIE5FRUQgUEFSU0lOR1wiKTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgbGV0IGNvb2tpZXMgPSB0aGlzLnBhcnNlQ29va2llcyhyZXEuaGVhZGVycy5jb29raWUpO1xuICAgICAgICAgICAgICAgIHJldHVybiBjb29raWVzW0dQX0FVVEhfQ09PS0lFXTtcbiAgICAgICAgICAgIH0gY2F0Y2goIGUgKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJFUlJPUiBwYXJzaW5nIGNvb2tpZXM6IFwiICsgZS5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBwYXJzZUNvb2tpZXM6IGZ1bmN0aW9uIHBhcnNlKHN0ciA6IHN0cmluZykge1xuICAgICAgICBpZiAoIXN0ciB8fCB0eXBlb2Ygc3RyICE9PSAnc3RyaW5nJyB8fCAhc3RyLmxlbmd0aCkgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgbGV0IHJlc3VsdCA9IHt9XG4gICAgICAgIGxldCBleHByID0gLzsgKi87XG4gICAgICAgIGxldCBwYWlycyA9IHN0ci5zcGxpdChleHByKTtcblxuICAgICAgICBwYWlycy5mb3JFYWNoKCBwYWlyID0+IHtcbiAgICAgICAgICAgIGxldCBzZXBJZHggPSBwYWlyLmluZGV4T2YoJz0nKTtcblxuICAgICAgICAgICAgaWYgKHNlcElkeCA8IDApIHJldHVybjsgLy9pZ25vcmUgbm9uLSAna2V5PXZhbHVlJyB2YWx1ZXNcblxuICAgICAgICAgICAgbGV0IGtleSA9IHBhaXIuc3Vic3RyKDAsIHNlcElkeCkudHJpbSgpO1xuICAgICAgICAgICAgbGV0IHZhbCA9IHBhaXIuc3Vic3RyKCsrc2VwSWR4LCBwYWlyLmxlbmd0aCkudHJpbSgpO1xuXG4gICAgICAgICAgICAvLyBxdW90ZWQgdmFsdWVzXG4gICAgICAgICAgICBpZiAoJ1wiJyA9PSB2YWxbMF0pIHZhbCA9IHZhbC5zbGljZSgxLCAtMSk7XG5cbiAgICAgICAgICAgIC8vIG9ubHkgYXNzaWduIG9uY2VcbiAgICAgICAgICAgIGlmICh1bmRlZmluZWQgPT0gcmVzdWx0W2tleV0pIHtcbiAgICAgICAgICAgICAgICBsZXQgdmFsdWUgPSB2YWw7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBkZWNvZGVVUklDb21wb25lbnQodmFsKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7IH1cbiAgICAgICAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuXG5cblxufTtcblxuZXhwb3J0IGRlZmF1bHQgU2VydmljZVByb3h5O1xuIl19