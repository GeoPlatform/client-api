import * as tslib_1 from "tslib";
import { GPHttpClient } from '@geoplatform/client';
var NodeHttpClient = /** @class */ (function (_super) {
    tslib_1.__extends(NodeHttpClient, _super);
    /**
     * @param options.timeout
     * @param options.token - the bearer token or a function to retrieve it
     */
    function NodeHttpClient(options) {
        return _super.call(this, options) || this;
    }
    /**
     * @param options - request configuration
     * @return request object
     */
    NodeHttpClient.prototype.createRequestOpts = function (options) {
        var opts = {
            method: options.method,
            url: options.url,
            json: false !== options.json,
            timeout: options.timeout || this.timeout
        };
        if (options.params) {
            opts.qs = options.params;
        }
        if (options.file) {
            var fs = require('fs');
            if (!fs)
                throw new Error("Module 'fs' not available");
            opts.formData = {
                file: {
                    value: fs.createReadStream(options.file.path),
                    options: {
                        filename: options.file.originalFilename
                    }
                }
            };
            Object.assign(opts.formData, options.data || {});
        }
        else if (options.data) {
            if (options.formData) {
                opts.formData = options.data;
            }
            else {
                opts.body = options.data;
            }
        }
        if (options.headers) {
            opts.headers = options.headers;
        }
        //set authorization header if one was provided
        if (this.token) {
            var token = this.token();
            if (token) {
                opts.auth = { 'bearer': token };
            }
        }
        var cookie = this.getCookie();
        if (cookie) {
            opts.headers = opts.headers || {};
            opts.headers.Cookie = this.authCookieName + '=' + cookie;
        }
        //copy over user-supplied options
        if (options.options) {
            for (var o in options.options) {
                if (options.options.hasOwnProperty(o)) {
                    opts[o] = options.options[o];
                }
            }
        }
        // console.log(JSON.stringify(opts));
        return opts;
    };
    /**
     *
     */
    NodeHttpClient.prototype.execute = function (options) {
        var _this = this;
        var request = require('request');
        // require('request-debug')(request);
        if (!request) {
            throw new Error("Module 'request' not available");
        }
        return new Promise(function (resolve, reject) {
            request(options, function (error, response, body) {
                _this.checkAndHandleError(error, response)
                    .then(function () {
                    if (options.json === false)
                        resolve(response);
                    else
                        resolve(body);
                })
                    .catch(function (e) { return reject(e); });
            });
        });
    };
    /**
     *
     */
    NodeHttpClient.prototype.checkAndHandleError = function (error, response) {
        var props = {
            message: null,
            error: null,
            status: 200
        };
        if (error) {
            // Logger.debug("Error generated by request library: " + error.code);
            if (error.code === 'ETIMEDOUT' || error.code === 'ESOCKETTIMEDOUT') {
                props.status = 500;
                props.error = "Connection Timeout";
                props.message = "The response from the service took too long to read";
                if (error.connect === true) {
                    props.message = "Unable to establish a connection to the service";
                }
            }
            else {
                return Promise.reject(error);
            }
        }
        else if (response.statusCode < 200 || response.statusCode > 204) {
            // Logger.debug('Error returned by remote endpoint (' + response.statusCode + ')');
            // Logger.debug(JSON.stringify(response));
            props.status = response.statusCode;
            if (response.body && typeof (response.body) === 'object') {
                props = response.body;
                props.status = props.status || response.statusCode;
                props.message = props.message || "An error occurred communicating with service";
                if (response.statusCode === 409) {
                    var sidx = response.body.message.indexOf(" ");
                    var eidx = response.body.message.indexOf(' already exists');
                    if (sidx >= 0 && eidx > sidx) {
                        props.item = response.body.message.substring(sidx + 1, eidx);
                    }
                }
            }
            else {
                switch (response.statusCode) {
                    case 404:
                        props.error = "Not Found";
                        props.message = response.request.uri.pathname + " cannot be found";
                        break;
                    case 401:
                        props.error = "Unauthenticated";
                        props.message = "You are not authenticated";
                        break;
                    case 403:
                        props.error = "Unauthorized";
                        props.message = "You are not authorized to access " + response.request.uri.pathname;
                        break;
                    case 409:
                        props.error = "Conflict";
                        props.message = "Item already exists";
                        // pattern received is: { ..., message: 'Resource <identifier> already exists', ... }
                        try {
                            var json = JSON.parse(response.body);
                            var sidx = json.message.indexOf(" ");
                            var eidx = json.message.indexOf(' already exists');
                            if (sidx >= 0 && eidx > sidx) {
                                props.item = json.message.substring(sidx + 1, eidx);
                            }
                        }
                        catch (e) {
                            props.message += '.  Unable to extract existing identifier from service response';
                        }
                        break;
                    default:
                        try {
                            var json = JSON.parse(response.body);
                            props = json;
                            props.status = response.statusCode;
                            // Logger.debug("PARSED ERROR: " + JSON.stringify(props));
                        }
                        catch (e) {
                            props.error = "Server Error";
                            props.message = response.body;
                            // Logger.debug("DEFAULTED ERROR: " + JSON.stringify(props));
                        }
                }
            }
        }
        if (props.status < 200 || props.status > 204) {
            props.error = props.error || "Server Error";
            props.status = props.status || response.statusCode;
            props.message = props.message || "An error occurred communicating with service";
            var err = new Error(props.message);
            Object.assign(err, props);
            // Logger.debug("UTILS.checkAndHandleError : " + err);
            // Logger.debug("UTILS.checkAndHandleError : " + JSON.stringify(err));
            // Logger.debug("UTILS.checkAndHandleError : " + err.message);
            return Promise.reject(err);
        }
        return Promise.resolve(null);
    };
    return NodeHttpClient;
}(GPHttpClient));
export default NodeHttpClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BnZW9wbGF0Zm9ybS9jbGllbnQvbm9kZS8iLCJzb3VyY2VzIjpbImh0dHAvbm9kZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBR25EO0lBQTZCLDBDQUFZO0lBRXJDOzs7T0FHRztJQUNILHdCQUFZLE9BQWlDO2VBQ3pDLGtCQUFNLE9BQU8sQ0FBQztJQUNsQixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsMENBQWlCLEdBQWpCLFVBQWtCLE9BQWdDO1FBRTlDLElBQUksSUFBSSxHQUF5QjtZQUM3QixNQUFNLEVBQUUsT0FBTyxDQUFDLE1BQU07WUFDdEIsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHO1lBQ2hCLElBQUksRUFBRSxLQUFLLEtBQUssT0FBTyxDQUFDLElBQUk7WUFDNUIsT0FBTyxFQUFFLE9BQU8sQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU87U0FDM0MsQ0FBQztRQUVGLElBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUNmLElBQUksQ0FBQyxFQUFFLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztTQUM1QjtRQUVELElBQUcsT0FBTyxDQUFDLElBQUksRUFBRTtZQUNiLElBQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN6QixJQUFHLENBQUMsRUFBRTtnQkFBRSxNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixDQUFDLENBQUM7WUFDckQsSUFBSSxDQUFDLFFBQVEsR0FBRztnQkFDWixJQUFJLEVBQUU7b0JBQ0YsS0FBSyxFQUFHLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztvQkFDOUMsT0FBTyxFQUFFO3dCQUNMLFFBQVEsRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQjtxQkFDMUM7aUJBQ0o7YUFDSixDQUFDO1lBQ0YsTUFB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LEtBQUssQ0FBQyxDQUFDO1lBRTFCLHNEQUFzRDtZQUN0RCxzRUFBc0U7WUFDdEUsOERBQThEO1lBQzlELE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUM5QjtRQUVELE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRUwscUJBQUM7QUFBRCxDQUFDLEFBL05ELENBQTZCLFlBQVksR0ErTnhDO0FBR0QsZUFBZSxjQUFjLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IEdQSHR0cENsaWVudCB9IGZyb20gJ0BnZW9wbGF0Zm9ybS9jbGllbnQnO1xuXG5cbmNsYXNzIE5vZGVIdHRwQ2xpZW50IGV4dGVuZHMgR1BIdHRwQ2xpZW50IHtcblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSBvcHRpb25zLnRpbWVvdXRcbiAgICAgKiBAcGFyYW0gb3B0aW9ucy50b2tlbiAtIHRoZSBiZWFyZXIgdG9rZW4gb3IgYSBmdW5jdGlvbiB0byByZXRyaWV2ZSBpdFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMgPzogeyBba2V5OnN0cmluZ10gOiBhbnkgfSkge1xuICAgICAgICBzdXBlcihvcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyAtIHJlcXVlc3QgY29uZmlndXJhdGlvblxuICAgICAqIEByZXR1cm4gcmVxdWVzdCBvYmplY3RcbiAgICAgKi9cbiAgICBjcmVhdGVSZXF1ZXN0T3B0cyhvcHRpb25zIDogeyBba2V5OnN0cmluZ10gOiBhbnkgfSkgOiBhbnkge1xuXG4gICAgICAgIGxldCBvcHRzIDoge1trZXk6c3RyaW5nXTogYW55fSA9IHtcbiAgICAgICAgICAgIG1ldGhvZDogb3B0aW9ucy5tZXRob2QsXG4gICAgICAgICAgICB1cmw6IG9wdGlvbnMudXJsLFxuICAgICAgICAgICAganNvbjogZmFsc2UgIT09IG9wdGlvbnMuanNvbixcbiAgICAgICAgICAgIHRpbWVvdXQ6IG9wdGlvbnMudGltZW91dCB8fCB0aGlzLnRpbWVvdXRcbiAgICAgICAgfTtcblxuICAgICAgICBpZihvcHRpb25zLnBhcmFtcykge1xuICAgICAgICAgICAgb3B0cy5xcyA9IG9wdGlvbnMucGFyYW1zO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYob3B0aW9ucy5maWxlKSB7XG4gICAgICAgICAgICBjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG4gICAgICAgICAgICBpZighZnMpIHRocm93IG5ldyBFcnJvcihcIk1vZHVsZSAnZnMnIG5vdCBhdmFpbGFibGVcIik7XG4gICAgICAgICAgICBvcHRzLmZvcm1EYXRhID0ge1xuICAgICAgICAgICAgICAgIGZpbGU6IHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICBmcy5jcmVhdGVSZWFkU3RyZWFtKG9wdGlvbnMuZmlsZS5wYXRoKSxcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9uczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlsZW5hbWU6IG9wdGlvbnMuZmlsZS5vcmlnaW5hbEZpbGVuYW1lXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihvcHRzLmZvcm1EYXRhLCBvcHRpb25zLmRhdGF8fHt9KTtcblxuICAgICAgICB9IGVsc2UgaWYob3B0aW9ucy5kYXRhKSB7XG4gICAgICAgICAgICBpZihvcHRpb25zLmZvcm1EYXRhKSB7XG4gICAgICAgICAgICAgICAgb3B0cy5mb3JtRGF0YSA9IG9wdGlvbnMuZGF0YTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb3B0cy5ib2R5ID0gb3B0aW9ucy5kYXRhO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYob3B0aW9ucy5oZWFkZXJzKSB7XG4gICAgICAgICAgICBvcHRzLmhlYWRlcnMgPSBvcHRpb25zLmhlYWRlcnM7XG4gICAgICAgIH1cblxuICAgICAgICAvL3NldCBhdXRob3JpemF0aW9uIGhlYWRlciBpZiBvbmUgd2FzIHByb3ZpZGVkXG4gICAgICAgIGlmKHRoaXMudG9rZW4pIHtcbiAgICAgICAgICAgIGxldCB0b2tlbiA9IHRoaXMudG9rZW4oKTtcbiAgICAgICAgICAgIGlmKHRva2VuKSB7XG4gICAgICAgICAgICAgICAgb3B0cy5hdXRoID0geyAnYmVhcmVyJzogdG9rZW4gfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsZXQgY29va2llID0gdGhpcy5nZXRDb29raWUoKTtcbiAgICAgICAgaWYoY29va2llKSB7XG4gICAgICAgICAgICBvcHRzLmhlYWRlcnMgPSBvcHRzLmhlYWRlcnMgfHwge307XG4gICAgICAgICAgICBvcHRzLmhlYWRlcnMuQ29va2llID0gdGhpcy5hdXRoQ29va2llTmFtZSArICc9JyArIGNvb2tpZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vY29weSBvdmVyIHVzZXItc3VwcGxpZWQgb3B0aW9uc1xuICAgICAgICBpZihvcHRpb25zLm9wdGlvbnMpIHtcbiAgICAgICAgICAgIGZvcihsZXQgbyBpbiBvcHRpb25zLm9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBpZihvcHRpb25zLm9wdGlvbnMuaGFzT3duUHJvcGVydHkobykpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0c1tvXSA9IG9wdGlvbnMub3B0aW9uc1tvXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShvcHRzKSk7XG5cbiAgICAgICAgcmV0dXJuIG9wdHM7XG4gICAgfVxuXG5cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgZXhlY3V0ZShvcHRpb25zIDogYW55KSA6IFByb21pc2U8YW55PiB7XG5cbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QnKTtcbiAgICAgICAgLy8gcmVxdWlyZSgncmVxdWVzdC1kZWJ1ZycpKHJlcXVlc3QpO1xuICAgICAgICBpZighcmVxdWVzdCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTW9kdWxlICdyZXF1ZXN0JyBub3QgYXZhaWxhYmxlXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHJlcXVlc3Qob3B0aW9ucywgKGVycm9yIDogYW55LCByZXNwb25zZSA6IGFueSwgYm9keSA6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tBbmRIYW5kbGVFcnJvcihlcnJvciwgcmVzcG9uc2UpXG4gICAgICAgICAgICAgICAgLnRoZW4oICgpID0+ICB7XG4gICAgICAgICAgICAgICAgICAgIGlmKG9wdGlvbnMuanNvbiA9PT0gZmFsc2UpIHJlc29sdmUoIHJlc3BvbnNlICk7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmVzb2x2ZSggYm9keSApO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKCBlID0+IHJlamVjdChlKSApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIGNoZWNrQW5kSGFuZGxlRXJyb3IgKGVycm9yIDogYW55LCByZXNwb25zZSA6IGFueSkgOiBQcm9taXNlPGFueT4ge1xuXG4gICAgICAgIGxldCBwcm9wcyA6IHsgW2tleTpzdHJpbmddOiBhbnkgfSA9IHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IG51bGwsXG4gICAgICAgICAgICBlcnJvcjogbnVsbCwgICAgLy9lcnJvciB0eXBlXG4gICAgICAgICAgICBzdGF0dXM6IDIwMFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmKGVycm9yKSB7XG4gICAgICAgICAgICAvLyBMb2dnZXIuZGVidWcoXCJFcnJvciBnZW5lcmF0ZWQgYnkgcmVxdWVzdCBsaWJyYXJ5OiBcIiArIGVycm9yLmNvZGUpO1xuXG4gICAgICAgICAgICBpZihlcnJvci5jb2RlID09PSAnRVRJTUVET1VUJyB8fCBlcnJvci5jb2RlID09PSAnRVNPQ0tFVFRJTUVET1VUJykge1xuXG4gICAgICAgICAgICAgICAgcHJvcHMuc3RhdHVzID0gNTAwO1xuICAgICAgICAgICAgICAgIHByb3BzLmVycm9yID0gXCJDb25uZWN0aW9uIFRpbWVvdXRcIjtcbiAgICAgICAgICAgICAgICBwcm9wcy5tZXNzYWdlID0gXCJUaGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmljZSB0b29rIHRvbyBsb25nIHRvIHJlYWRcIjtcblxuICAgICAgICAgICAgICAgIGlmKGVycm9yLmNvbm5lY3QgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvcHMubWVzc2FnZSA9IFwiVW5hYmxlIHRvIGVzdGFibGlzaCBhIGNvbm5lY3Rpb24gdG8gdGhlIHNlcnZpY2VcIjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9IGVsc2UgaWYocmVzcG9uc2Uuc3RhdHVzQ29kZSA8IDIwMCB8fCByZXNwb25zZS5zdGF0dXNDb2RlID4gMjA0KSB7XG5cbiAgICAgICAgICAgIC8vIExvZ2dlci5kZWJ1ZygnRXJyb3IgcmV0dXJuZWQgYnkgcmVtb3RlIGVuZHBvaW50ICgnICsgcmVzcG9uc2Uuc3RhdHVzQ29kZSArICcpJyk7XG4gICAgICAgICAgICAvLyBMb2dnZXIuZGVidWcoSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpKTtcblxuICAgICAgICAgICAgcHJvcHMuc3RhdHVzID0gcmVzcG9uc2Uuc3RhdHVzQ29kZTtcblxuICAgICAgICAgICAgaWYocmVzcG9uc2UuYm9keSAmJiB0eXBlb2YocmVzcG9uc2UuYm9keSkgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgcHJvcHMgPSByZXNwb25zZS5ib2R5O1xuICAgICAgICAgICAgICAgIHByb3BzLnN0YXR1cyA9IHByb3BzLnN0YXR1cyB8fCByZXNwb25zZS5zdGF0dXNDb2RlO1xuICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgPSBwcm9wcy5tZXNzYWdlIHx8IFwiQW4gZXJyb3Igb2NjdXJyZWQgY29tbXVuaWNhdGluZyB3aXRoIHNlcnZpY2VcIjtcblxuICAgICAgICAgICAgICAgIGlmKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDQwOSkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgc2lkeCA9IHJlc3BvbnNlLmJvZHkubWVzc2FnZS5pbmRleE9mKFwiIFwiKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGVpZHggPSByZXNwb25zZS5ib2R5Lm1lc3NhZ2UuaW5kZXhPZignIGFscmVhZHkgZXhpc3RzJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmKHNpZHggPj0gMCAmJiBlaWR4ID4gc2lkeCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuaXRlbSA9IHJlc3BvbnNlLmJvZHkubWVzc2FnZS5zdWJzdHJpbmcoc2lkeCsxLCBlaWR4KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIHN3aXRjaChyZXNwb25zZS5zdGF0dXNDb2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgNDA0IDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLmVycm9yID0gXCJOb3QgRm91bmRcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgPSByZXNwb25zZS5yZXF1ZXN0LnVyaS5wYXRobmFtZSArIFwiIGNhbm5vdCBiZSBmb3VuZFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgNDAxIDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLmVycm9yID0gXCJVbmF1dGhlbnRpY2F0ZWRcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgPSBcIllvdSBhcmUgbm90IGF1dGhlbnRpY2F0ZWRcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDQwMyA6XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5lcnJvciA9IFwiVW5hdXRob3JpemVkXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5tZXNzYWdlID0gXCJZb3UgYXJlIG5vdCBhdXRob3JpemVkIHRvIGFjY2VzcyBcIiArIHJlc3BvbnNlLnJlcXVlc3QudXJpLnBhdGhuYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgNDA5IDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLmVycm9yID0gXCJDb25mbGljdFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMubWVzc2FnZSA9IFwiSXRlbSBhbHJlYWR5IGV4aXN0c1wiO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBwYXR0ZXJuIHJlY2VpdmVkIGlzOiB7IC4uLiwgbWVzc2FnZTogJ1Jlc291cmNlIDxpZGVudGlmaWVyPiBhbHJlYWR5IGV4aXN0cycsIC4uLiB9XG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBqc29uID0gSlNPTi5wYXJzZShyZXNwb25zZS5ib2R5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2lkeCA9IGpzb24ubWVzc2FnZS5pbmRleE9mKFwiIFwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZWlkeCA9IGpzb24ubWVzc2FnZS5pbmRleE9mKCcgYWxyZWFkeSBleGlzdHMnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihzaWR4ID49IDAgJiYgZWlkeCA+IHNpZHgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuaXRlbSA9IGpzb24ubWVzc2FnZS5zdWJzdHJpbmcoc2lkeCsxLCBlaWR4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKCBlICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgKz0gJy4gIFVuYWJsZSB0byBleHRyYWN0IGV4aXN0aW5nIGlkZW50aWZpZXIgZnJvbSBzZXJ2aWNlIHJlc3BvbnNlJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGpzb24gPSBKU09OLnBhcnNlKHJlc3BvbnNlLmJvZHkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzID0ganNvbjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5zdGF0dXMgPSByZXNwb25zZS5zdGF0dXNDb2RlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExvZ2dlci5kZWJ1ZyhcIlBBUlNFRCBFUlJPUjogXCIgKyBKU09OLnN0cmluZ2lmeShwcm9wcykpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuZXJyb3IgPSBcIlNlcnZlciBFcnJvclwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgPSByZXNwb25zZS5ib2R5O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExvZ2dlci5kZWJ1ZyhcIkRFRkFVTFRFRCBFUlJPUjogXCIgKyBKU09OLnN0cmluZ2lmeShwcm9wcykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICBpZiggcHJvcHMuc3RhdHVzIDwgMjAwIHx8IHByb3BzLnN0YXR1cyA+IDIwNCApIHtcblxuICAgICAgICAgICAgcHJvcHMuZXJyb3IgPSBwcm9wcy5lcnJvciB8fCBcIlNlcnZlciBFcnJvclwiO1xuICAgICAgICAgICAgcHJvcHMuc3RhdHVzID0gcHJvcHMuc3RhdHVzIHx8IHJlc3BvbnNlLnN0YXR1c0NvZGU7XG4gICAgICAgICAgICBwcm9wcy5tZXNzYWdlID0gcHJvcHMubWVzc2FnZSB8fCBcIkFuIGVycm9yIG9jY3VycmVkIGNvbW11bmljYXRpbmcgd2l0aCBzZXJ2aWNlXCI7XG5cbiAgICAgICAgICAgIGxldCBlcnIgPSBuZXcgRXJyb3IocHJvcHMubWVzc2FnZSk7XG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKGVyciwgcHJvcHMpO1xuXG4gICAgICAgICAgICAvLyBMb2dnZXIuZGVidWcoXCJVVElMUy5jaGVja0FuZEhhbmRsZUVycm9yIDogXCIgKyBlcnIpO1xuICAgICAgICAgICAgLy8gTG9nZ2VyLmRlYnVnKFwiVVRJTFMuY2hlY2tBbmRIYW5kbGVFcnJvciA6IFwiICsgSlNPTi5zdHJpbmdpZnkoZXJyKSk7XG4gICAgICAgICAgICAvLyBMb2dnZXIuZGVidWcoXCJVVElMUy5jaGVja0FuZEhhbmRsZUVycm9yIDogXCIgKyBlcnIubWVzc2FnZSk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbCk7XG4gICAgfVxuXG59XG5cblxuZXhwb3J0IGRlZmF1bHQgTm9kZUh0dHBDbGllbnQ7XG4iXX0=