import { GPHttpClient } from '@geoplatform/client';
class NodeHttpClient extends GPHttpClient {
    /**
     * @param options.timeout
     * @param options.token - the bearer token or a function to retrieve it
     */
    constructor(options) {
        super(options);
    }
    /**
     * @param options - request configuration
     * @return request object
     */
    createRequestOpts(options) {
        let opts = {
            method: options.method,
            url: options.url,
            json: false !== options.json,
            timeout: options.timeout || this.timeout
        };
        if (options.params) {
            opts.qs = options.params;
        }
        if (options.file) {
            const fs = require('fs');
            if (!fs)
                throw new Error("Module 'fs' not available");
            opts.formData = {
                file: {
                    value: fs.createReadStream(options.file.path),
                    options: {
                        filename: options.file.originalFilename
                    }
                }
            };
            Object.assign(opts.formData, options.data || {});
        }
        else if (options.data) {
            if (options.formData) {
                opts.formData = options.data;
            }
            else {
                opts.body = options.data;
            }
        }
        if (options.headers) {
            opts.headers = options.headers;
        }
        //set authorization header if one was provided
        if (this.token) {
            let token = this.token();
            if (token) {
                opts.auth = { 'bearer': token };
            }
        }
        let cookie = this.getCookie();
        if (cookie) {
            opts.headers = opts.headers || {};
            opts.headers.Cookie = this.authCookieName + '=' + cookie;
        }
        //copy over user-supplied options
        if (options.options) {
            for (let o in options.options) {
                if (options.options.hasOwnProperty(o)) {
                    opts[o] = options.options[o];
                }
            }
        }
        // console.log(JSON.stringify(opts));
        return opts;
    }
    /**
     *
     */
    execute(options) {
        const request = require('request');
        // require('request-debug')(request);
        if (!request) {
            throw new Error("Module 'request' not available");
        }
        return new Promise((resolve, reject) => {
            request(options, (error, response, body) => {
                this.checkAndHandleError(error, response)
                    .then(() => {
                    if (options.json === false)
                        resolve(response);
                    else
                        resolve(body);
                })
                    .catch(e => reject(e));
            });
        });
    }
    /**
     *
     */
    checkAndHandleError(error, response) {
        let props = {
            message: null,
            error: null,
            status: 200
        };
        if (error) {
            // Logger.debug("Error generated by request library: " + error.code);
            if (error.code === 'ETIMEDOUT' || error.code === 'ESOCKETTIMEDOUT') {
                props.status = 500;
                props.error = "Connection Timeout";
                props.message = "The response from the service took too long to read";
                if (error.connect === true) {
                    props.message = "Unable to establish a connection to the service";
                }
            }
            else {
                return Promise.reject(error);
            }
        }
        else if (response.statusCode < 200 || response.statusCode > 204) {
            // Logger.debug('Error returned by remote endpoint (' + response.statusCode + ')');
            // Logger.debug(JSON.stringify(response));
            props.status = response.statusCode;
            if (response.body && typeof (response.body) === 'object') {
                props = response.body;
                props.status = props.status || response.statusCode;
                props.message = props.message || "An error occurred communicating with service";
                if (response.statusCode === 409) {
                    let sidx = response.body.message.indexOf(" ");
                    let eidx = response.body.message.indexOf(' already exists');
                    if (sidx >= 0 && eidx > sidx) {
                        props.item = response.body.message.substring(sidx + 1, eidx);
                    }
                }
            }
            else {
                switch (response.statusCode) {
                    case 404:
                        props.error = "Not Found";
                        props.message = response.request.uri.pathname + " cannot be found";
                        break;
                    case 401:
                        props.error = "Unauthenticated";
                        props.message = "You are not authenticated";
                        break;
                    case 403:
                        props.error = "Unauthorized";
                        props.message = "You are not authorized to access " + response.request.uri.pathname;
                        break;
                    case 409:
                        props.error = "Conflict";
                        props.message = "Item already exists";
                        // pattern received is: { ..., message: 'Resource <identifier> already exists', ... }
                        try {
                            let json = JSON.parse(response.body);
                            let sidx = json.message.indexOf(" ");
                            let eidx = json.message.indexOf(' already exists');
                            if (sidx >= 0 && eidx > sidx) {
                                props.item = json.message.substring(sidx + 1, eidx);
                            }
                        }
                        catch (e) {
                            props.message += '.  Unable to extract existing identifier from service response';
                        }
                        break;
                    default:
                        try {
                            let json = JSON.parse(response.body);
                            props = json;
                            props.status = response.statusCode;
                            // Logger.debug("PARSED ERROR: " + JSON.stringify(props));
                        }
                        catch (e) {
                            props.error = "Server Error";
                            props.message = response.body;
                            // Logger.debug("DEFAULTED ERROR: " + JSON.stringify(props));
                        }
                }
            }
        }
        if (props.status < 200 || props.status > 204) {
            props.error = props.error || "Server Error";
            props.status = props.status || response.statusCode;
            props.message = props.message || "An error occurred communicating with service";
            let err = new Error(props.message);
            Object.assign(err, props);
            // Logger.debug("UTILS.checkAndHandleError : " + err);
            // Logger.debug("UTILS.checkAndHandleError : " + JSON.stringify(err));
            // Logger.debug("UTILS.checkAndHandleError : " + err.message);
            return Promise.reject(err);
        }
        return Promise.resolve(null);
    }
}
export default NodeHttpClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BnZW9wbGF0Zm9ybS9jbGllbnQvbm9kZS8iLCJzb3VyY2VzIjpbImh0dHAvbm9kZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFHbkQsTUFBTSxjQUFlLFNBQVEsWUFBWTtJQUVyQzs7O09BR0c7SUFDSCxZQUFZLE9BQWlDO1FBQ3pDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNuQixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsaUJBQWlCLENBQUMsT0FBZ0M7UUFFOUMsSUFBSSxJQUFJLEdBQXlCO1lBQzdCLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTTtZQUN0QixHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUc7WUFDaEIsSUFBSSxFQUFFLEtBQUssS0FBSyxPQUFPLENBQUMsSUFBSTtZQUM1QixPQUFPLEVBQUUsT0FBTyxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTztTQUMzQyxDQUFDO1FBRUYsSUFBRyxPQUFPLENBQUMsTUFBTSxFQUFFO1lBQ2YsSUFBSSxDQUFDLEVBQUUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1NBQzVCO1FBRUQsSUFBRyxPQUFPLENBQUMsSUFBSSxFQUFFO1lBQ2IsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3pCLElBQUcsQ0FBQyxFQUFFO2dCQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQztZQUNyRCxJQUFJLENBQUMsUUFBUSxHQUFHO2dCQUNaLElBQUksRUFBRTtvQkFDRixLQUFLLEVBQUcsRUFBRSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO29CQUM5QyxPQUFPLEVBQUU7d0JBQ0wsUUFBUSxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCO3FCQUMxQztpQkFDSjthQUNKLENBQUM7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QUUsS0FBSyxDQUFDLENBQUM7WUFFMUIsc0RBQXNEO1lBQ3RELHNFQUFzRTtZQUN0RSw4REFBOEQ7WUFDOUQsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzlCO1FBRUQsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pDLENBQUM7Q0FFSjtBQUdELGVBQWUsY0FBYyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBHUEh0dHBDbGllbnQgfSBmcm9tICdAZ2VvcGxhdGZvcm0vY2xpZW50JztcblxuXG5jbGFzcyBOb2RlSHR0cENsaWVudCBleHRlbmRzIEdQSHR0cENsaWVudCB7XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0gb3B0aW9ucy50aW1lb3V0XG4gICAgICogQHBhcmFtIG9wdGlvbnMudG9rZW4gLSB0aGUgYmVhcmVyIHRva2VuIG9yIGEgZnVuY3Rpb24gdG8gcmV0cmlldmUgaXRcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zID86IHsgW2tleTpzdHJpbmddIDogYW55IH0pIHtcbiAgICAgICAgc3VwZXIob3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIG9wdGlvbnMgLSByZXF1ZXN0IGNvbmZpZ3VyYXRpb25cbiAgICAgKiBAcmV0dXJuIHJlcXVlc3Qgb2JqZWN0XG4gICAgICovXG4gICAgY3JlYXRlUmVxdWVzdE9wdHMob3B0aW9ucyA6IHsgW2tleTpzdHJpbmddIDogYW55IH0pIDogYW55IHtcblxuICAgICAgICBsZXQgb3B0cyA6IHtba2V5OnN0cmluZ106IGFueX0gPSB7XG4gICAgICAgICAgICBtZXRob2Q6IG9wdGlvbnMubWV0aG9kLFxuICAgICAgICAgICAgdXJsOiBvcHRpb25zLnVybCxcbiAgICAgICAgICAgIGpzb246IGZhbHNlICE9PSBvcHRpb25zLmpzb24sXG4gICAgICAgICAgICB0aW1lb3V0OiBvcHRpb25zLnRpbWVvdXQgfHwgdGhpcy50aW1lb3V0XG4gICAgICAgIH07XG5cbiAgICAgICAgaWYob3B0aW9ucy5wYXJhbXMpIHtcbiAgICAgICAgICAgIG9wdHMucXMgPSBvcHRpb25zLnBhcmFtcztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmKG9wdGlvbnMuZmlsZSkge1xuICAgICAgICAgICAgY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuICAgICAgICAgICAgaWYoIWZzKSB0aHJvdyBuZXcgRXJyb3IoXCJNb2R1bGUgJ2ZzJyBub3QgYXZhaWxhYmxlXCIpO1xuICAgICAgICAgICAgb3B0cy5mb3JtRGF0YSA9IHtcbiAgICAgICAgICAgICAgICBmaWxlOiB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiAgZnMuY3JlYXRlUmVhZFN0cmVhbShvcHRpb25zLmZpbGUucGF0aCksXG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVuYW1lOiBvcHRpb25zLmZpbGUub3JpZ2luYWxGaWxlbmFtZVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ob3B0cy5mb3JtRGF0YSwgb3B0aW9ucy5kYXRhfHx7fSk7XG5cbiAgICAgICAgfSBlbHNlIGlmKG9wdGlvbnMuZGF0YSkge1xuICAgICAgICAgICAgaWYob3B0aW9ucy5mb3JtRGF0YSkge1xuICAgICAgICAgICAgICAgIG9wdHMuZm9ybURhdGEgPSBvcHRpb25zLmRhdGE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG9wdHMuYm9keSA9IG9wdGlvbnMuZGF0YTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmKG9wdGlvbnMuaGVhZGVycykge1xuICAgICAgICAgICAgb3B0cy5oZWFkZXJzID0gb3B0aW9ucy5oZWFkZXJzO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9zZXQgYXV0aG9yaXphdGlvbiBoZWFkZXIgaWYgb25lIHdhcyBwcm92aWRlZFxuICAgICAgICBpZih0aGlzLnRva2VuKSB7XG4gICAgICAgICAgICBsZXQgdG9rZW4gPSB0aGlzLnRva2VuKCk7XG4gICAgICAgICAgICBpZih0b2tlbikge1xuICAgICAgICAgICAgICAgIG9wdHMuYXV0aCA9IHsgJ2JlYXJlcic6IHRva2VuIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGNvb2tpZSA9IHRoaXMuZ2V0Q29va2llKCk7XG4gICAgICAgIGlmKGNvb2tpZSkge1xuICAgICAgICAgICAgb3B0cy5oZWFkZXJzID0gb3B0cy5oZWFkZXJzIHx8IHt9O1xuICAgICAgICAgICAgb3B0cy5oZWFkZXJzLkNvb2tpZSA9IHRoaXMuYXV0aENvb2tpZU5hbWUgKyAnPScgKyBjb29raWU7XG4gICAgICAgIH1cblxuICAgICAgICAvL2NvcHkgb3ZlciB1c2VyLXN1cHBsaWVkIG9wdGlvbnNcbiAgICAgICAgaWYob3B0aW9ucy5vcHRpb25zKSB7XG4gICAgICAgICAgICBmb3IobGV0IG8gaW4gb3B0aW9ucy5vcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgaWYob3B0aW9ucy5vcHRpb25zLmhhc093blByb3BlcnR5KG8pKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdHNbb10gPSBvcHRpb25zLm9wdGlvbnNbb107XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob3B0cykpO1xuXG4gICAgICAgIHJldHVybiBvcHRzO1xuICAgIH1cblxuXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIGV4ZWN1dGUob3B0aW9ucyA6IGFueSkgOiBQcm9taXNlPGFueT4ge1xuXG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSByZXF1aXJlKCdyZXF1ZXN0Jyk7XG4gICAgICAgIC8vIHJlcXVpcmUoJ3JlcXVlc3QtZGVidWcnKShyZXF1ZXN0KTtcbiAgICAgICAgaWYoIXJlcXVlc3QpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk1vZHVsZSAncmVxdWVzdCcgbm90IGF2YWlsYWJsZVwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KCAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICByZXF1ZXN0KG9wdGlvbnMsIChlcnJvciA6IGFueSwgcmVzcG9uc2UgOiBhbnksIGJvZHkgOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNoZWNrQW5kSGFuZGxlRXJyb3IoZXJyb3IsIHJlc3BvbnNlKVxuICAgICAgICAgICAgICAgIC50aGVuKCAoKSA9PiAge1xuICAgICAgICAgICAgICAgICAgICBpZihvcHRpb25zLmpzb24gPT09IGZhbHNlKSByZXNvbHZlKCByZXNwb25zZSApO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHJlc29sdmUoIGJvZHkgKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaCggZSA9PiByZWplY3QoZSkgKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgIH1cblxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICBjaGVja0FuZEhhbmRsZUVycm9yIChlcnJvciA6IGFueSwgcmVzcG9uc2UgOiBhbnkpIDogUHJvbWlzZTxhbnk+IHtcblxuICAgICAgICBsZXQgcHJvcHMgOiB7IFtrZXk6c3RyaW5nXTogYW55IH0gPSB7XG4gICAgICAgICAgICBtZXNzYWdlOiBudWxsLFxuICAgICAgICAgICAgZXJyb3I6IG51bGwsICAgIC8vZXJyb3IgdHlwZVxuICAgICAgICAgICAgc3RhdHVzOiAyMDBcbiAgICAgICAgfTtcblxuICAgICAgICBpZihlcnJvcikge1xuICAgICAgICAgICAgLy8gTG9nZ2VyLmRlYnVnKFwiRXJyb3IgZ2VuZXJhdGVkIGJ5IHJlcXVlc3QgbGlicmFyeTogXCIgKyBlcnJvci5jb2RlKTtcblxuICAgICAgICAgICAgaWYoZXJyb3IuY29kZSA9PT0gJ0VUSU1FRE9VVCcgfHwgZXJyb3IuY29kZSA9PT0gJ0VTT0NLRVRUSU1FRE9VVCcpIHtcblxuICAgICAgICAgICAgICAgIHByb3BzLnN0YXR1cyA9IDUwMDtcbiAgICAgICAgICAgICAgICBwcm9wcy5lcnJvciA9IFwiQ29ubmVjdGlvbiBUaW1lb3V0XCI7XG4gICAgICAgICAgICAgICAgcHJvcHMubWVzc2FnZSA9IFwiVGhlIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZpY2UgdG9vayB0b28gbG9uZyB0byByZWFkXCI7XG5cbiAgICAgICAgICAgICAgICBpZihlcnJvci5jb25uZWN0ID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgPSBcIlVuYWJsZSB0byBlc3RhYmxpc2ggYSBjb25uZWN0aW9uIHRvIHRoZSBzZXJ2aWNlXCI7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSBlbHNlIGlmKHJlc3BvbnNlLnN0YXR1c0NvZGUgPCAyMDAgfHwgcmVzcG9uc2Uuc3RhdHVzQ29kZSA+IDIwNCkge1xuXG4gICAgICAgICAgICAvLyBMb2dnZXIuZGVidWcoJ0Vycm9yIHJldHVybmVkIGJ5IHJlbW90ZSBlbmRwb2ludCAoJyArIHJlc3BvbnNlLnN0YXR1c0NvZGUgKyAnKScpO1xuICAgICAgICAgICAgLy8gTG9nZ2VyLmRlYnVnKEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlKSk7XG5cbiAgICAgICAgICAgIHByb3BzLnN0YXR1cyA9IHJlc3BvbnNlLnN0YXR1c0NvZGU7XG5cbiAgICAgICAgICAgIGlmKHJlc3BvbnNlLmJvZHkgJiYgdHlwZW9mKHJlc3BvbnNlLmJvZHkpID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgIHByb3BzID0gcmVzcG9uc2UuYm9keTtcbiAgICAgICAgICAgICAgICBwcm9wcy5zdGF0dXMgPSBwcm9wcy5zdGF0dXMgfHwgcmVzcG9uc2Uuc3RhdHVzQ29kZTtcbiAgICAgICAgICAgICAgICBwcm9wcy5tZXNzYWdlID0gcHJvcHMubWVzc2FnZSB8fCBcIkFuIGVycm9yIG9jY3VycmVkIGNvbW11bmljYXRpbmcgd2l0aCBzZXJ2aWNlXCI7XG5cbiAgICAgICAgICAgICAgICBpZihyZXNwb25zZS5zdGF0dXNDb2RlID09PSA0MDkpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHNpZHggPSByZXNwb25zZS5ib2R5Lm1lc3NhZ2UuaW5kZXhPZihcIiBcIik7XG4gICAgICAgICAgICAgICAgICAgIGxldCBlaWR4ID0gcmVzcG9uc2UuYm9keS5tZXNzYWdlLmluZGV4T2YoJyBhbHJlYWR5IGV4aXN0cycpO1xuICAgICAgICAgICAgICAgICAgICBpZihzaWR4ID49IDAgJiYgZWlkeCA+IHNpZHgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLml0ZW0gPSByZXNwb25zZS5ib2R5Lm1lc3NhZ2Uuc3Vic3RyaW5nKHNpZHgrMSwgZWlkeCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICBzd2l0Y2gocmVzcG9uc2Uuc3RhdHVzQ29kZSkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDQwNCA6XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5lcnJvciA9IFwiTm90IEZvdW5kXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5tZXNzYWdlID0gcmVzcG9uc2UucmVxdWVzdC51cmkucGF0aG5hbWUgKyBcIiBjYW5ub3QgYmUgZm91bmRcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDQwMSA6XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5lcnJvciA9IFwiVW5hdXRoZW50aWNhdGVkXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5tZXNzYWdlID0gXCJZb3UgYXJlIG5vdCBhdXRoZW50aWNhdGVkXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSA0MDMgOlxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuZXJyb3IgPSBcIlVuYXV0aG9yaXplZFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMubWVzc2FnZSA9IFwiWW91IGFyZSBub3QgYXV0aG9yaXplZCB0byBhY2Nlc3MgXCIgKyByZXNwb25zZS5yZXF1ZXN0LnVyaS5wYXRobmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDQwOSA6XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5lcnJvciA9IFwiQ29uZmxpY3RcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLm1lc3NhZ2UgPSBcIkl0ZW0gYWxyZWFkeSBleGlzdHNcIjtcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGF0dGVybiByZWNlaXZlZCBpczogeyAuLi4sIG1lc3NhZ2U6ICdSZXNvdXJjZSA8aWRlbnRpZmllcj4gYWxyZWFkeSBleGlzdHMnLCAuLi4gfVxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQganNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2UuYm9keSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNpZHggPSBqc29uLm1lc3NhZ2UuaW5kZXhPZihcIiBcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGVpZHggPSBqc29uLm1lc3NhZ2UuaW5kZXhPZignIGFscmVhZHkgZXhpc3RzJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2lkeCA+PSAwICYmIGVpZHggPiBzaWR4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLml0ZW0gPSBqc29uLm1lc3NhZ2Uuc3Vic3RyaW5nKHNpZHgrMSwgZWlkeCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCggZSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5tZXNzYWdlICs9ICcuICBVbmFibGUgdG8gZXh0cmFjdCBleGlzdGluZyBpZGVudGlmaWVyIGZyb20gc2VydmljZSByZXNwb25zZSc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxuXG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBqc29uID0gSlNPTi5wYXJzZShyZXNwb25zZS5ib2R5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wcyA9IGpzb247XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuc3RhdHVzID0gcmVzcG9uc2Uuc3RhdHVzQ29kZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBMb2dnZXIuZGVidWcoXCJQQVJTRUQgRVJST1I6IFwiICsgSlNPTi5zdHJpbmdpZnkocHJvcHMpKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLmVycm9yID0gXCJTZXJ2ZXIgRXJyb3JcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5tZXNzYWdlID0gcmVzcG9uc2UuYm9keTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBMb2dnZXIuZGVidWcoXCJERUZBVUxURUQgRVJST1I6IFwiICsgSlNPTi5zdHJpbmdpZnkocHJvcHMpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICAgICAgaWYoIHByb3BzLnN0YXR1cyA8IDIwMCB8fCBwcm9wcy5zdGF0dXMgPiAyMDQgKSB7XG5cbiAgICAgICAgICAgIHByb3BzLmVycm9yID0gcHJvcHMuZXJyb3IgfHwgXCJTZXJ2ZXIgRXJyb3JcIjtcbiAgICAgICAgICAgIHByb3BzLnN0YXR1cyA9IHByb3BzLnN0YXR1cyB8fCByZXNwb25zZS5zdGF0dXNDb2RlO1xuICAgICAgICAgICAgcHJvcHMubWVzc2FnZSA9IHByb3BzLm1lc3NhZ2UgfHwgXCJBbiBlcnJvciBvY2N1cnJlZCBjb21tdW5pY2F0aW5nIHdpdGggc2VydmljZVwiO1xuXG4gICAgICAgICAgICBsZXQgZXJyID0gbmV3IEVycm9yKHByb3BzLm1lc3NhZ2UpO1xuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihlcnIsIHByb3BzKTtcblxuICAgICAgICAgICAgLy8gTG9nZ2VyLmRlYnVnKFwiVVRJTFMuY2hlY2tBbmRIYW5kbGVFcnJvciA6IFwiICsgZXJyKTtcbiAgICAgICAgICAgIC8vIExvZ2dlci5kZWJ1ZyhcIlVUSUxTLmNoZWNrQW5kSGFuZGxlRXJyb3IgOiBcIiArIEpTT04uc3RyaW5naWZ5KGVycikpO1xuICAgICAgICAgICAgLy8gTG9nZ2VyLmRlYnVnKFwiVVRJTFMuY2hlY2tBbmRIYW5kbGVFcnJvciA6IFwiICsgZXJyLm1lc3NhZ2UpO1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xuICAgIH1cblxufVxuXG5cbmV4cG9ydCBkZWZhdWx0IE5vZGVIdHRwQ2xpZW50O1xuIl19